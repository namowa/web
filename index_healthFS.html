<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker</title>

    <!-- External Libraries -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container">
        <!-- App Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Health Tracker</h1>
                    <p class="text-gray-500">ระบบส่งเสริมสุขภาพพนักงาน</p>
                </div>
                <!-- LIFF Profile Info -->
                <div id="liff-profile" class="hidden flex items-center space-x-3">
                    <span id="liff-display-name" class="font-semibold text-gray-700 text-right"></span>
                    <img id="liff-picture-url" class="w-10 h-10 rounded-full" src="" alt="LINE Profile Picture">
                </div>
                <div id="liff-loading" class="text-sm text-gray-500">
                    กำลังเชื่อมต่อกับ LINE...
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Loading Indicator -->
            <div id="app-loading" class="text-center p-10">
                <p>กำลังเตรียมข้อมูล กรุณารอสักครู่...</p>
            </div>
            
            <!-- Main Application (Hidden until LIFF is ready) -->
            <div id="main-app" class="hidden">
                <!-- Navigation -->
                <nav class="mb-6">
                    <div class="flex space-x-2 p-2 bg-gray-200 rounded-lg">
                        <button data-page="dashboard" class="nav-button px-4 py-2 rounded-md text-sm font-medium transition-colors bg-indigo-600 text-white">ภาพรวม</button>
                        <button data-page="profile" class="nav-button px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-700 bg-gray-200 hover:bg-gray-300">โปรไฟล์</button>
                        <button data-page="log" class="nav-button px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-700 bg-gray-200 hover:bg-gray-300">บันทึกกิจกรรม</button>
                        <button data-page="history" class="nav-button px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-700 bg-gray-200 hover:bg-gray-300">ประวัติ</button>
                    </div>
                </nav>

                <!-- Content Pages -->
                <div id="content-pages">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page active">
                        <div class="p-6 bg-white rounded-xl shadow-lg">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">ภาพรวมสุขภาพ</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- BMI Gauge -->
                                <div class="flex flex-col items-center">
                                    <h3 class="text-lg font-semibold text-gray-700">ดัชนีมวลกาย (BMI)</h3>
                                    <div class="relative w-full max-w-xs h-48">
                                        <canvas id="bmiGaugeChart"></canvas>
                                    </div>
                                </div>
                                <!-- Exercise Summary -->
                                <div class="flex flex-col">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-2">สรุปการออกกำลังกาย</h3>
                                    <div id="exercise-summary-container" class="space-y-3">
                                        <!-- Summary data will be injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Page -->
                    <div id="profile-page" class="page">
                        <div class="p-6 bg-white rounded-xl shadow-lg">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">ข้อมูลส่วนตัว</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">วัน/เดือน/ปีเกิด</label>
                                    <input type="date" id="profile-dob" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700">เพศ</label>
                                    <select id="profile-gender" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="">ไม่ระบุ</option>
                                        <option value="male">ชาย</option>
                                        <option value="female">หญิง</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ส่วนสูง (cm)</label>
                                    <input type="number" id="profile-height" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">น้ำหนัก (kg)</label>
                                    <input type="number" id="profile-weight" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                            </div>
                            <div id="age-display" class="mt-4 text-gray-600"></div>
                            <button id="save-profile-btn" class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                บันทึกข้อมูล
                            </button>
                            <p id="profile-message" class="mt-4 text-center font-semibold"></p>
                            <div id="bmi-display" class="mt-4"></div>
                            <div class="mt-8">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">กราฟติดตามน้ำหนัก</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <canvas id="weightChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Log Entry Page -->
                    <div id="log-page" class="page">
                         <div class="p-6 bg-white rounded-xl shadow-lg">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">บันทึกกิจกรรม</h2>
                            <div class="mb-4">
                                <div class="flex border-b border-gray-200">
                                    <button data-log-type="exercise" class="log-type-btn flex-1 py-2 text-center font-medium border-b-2 border-indigo-500 text-indigo-600">ออกกำลังกาย</button>
                                    <button data-log-type="food" class="log-type-btn flex-1 py-2 text-center font-medium text-gray-500">อาหาร</button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <!-- Exercise Type Dropdown -->
                                <div id="exercise-type-container">
                                    <label class="block text-sm font-medium text-gray-700">ประเภทการออกกำลังกาย</label>
                                    <select id="log-exercise-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="running">การวิ่ง</option>
                                        <option value="walking">เดิน</option>
                                        <option value="cycling">ปั่นจักรยาน</option>
                                        <option value="other">กีฬาอื่นๆ</option>
                                    </select>
                                </div>
                                <!-- Kcal input -->
                                <div id="kcal-input-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">แคลอรี่ (kcal)</label>
                                    <input type="number" id="log-kcal" placeholder="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                                <!-- Km Input -->
                                <div id="km-input-container">
                                    <label class="block text-sm font-medium text-gray-700">ระยะทาง (กม.)</label>
                                    <input type="number" id="log-km" placeholder="0.0" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                                <!-- Minutes Input -->
                                <div id="minutes-input-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">เวลา (นาที)</label>
                                    <input type="number" id="log-minutes" placeholder="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                                </div>
                                <div>
                                    <label id="log-upload-label" class="block text-sm font-medium text-gray-700">อัปโหลดรูปภาพ</label>
                                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                        <div class="space-y-1 text-center">
                                            <img id="log-preview" src="" alt="Preview" class="hidden mx-auto h-48 w-auto rounded-md"/>
                                            <svg id="log-placeholder-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 4v.01M28 8L20 16m0 0L12 8m8 8v20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                            <div class="flex text-sm text-gray-600 justify-center">
                                                <label for="log-file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                                    <span>เลือกไฟล์</span>
                                                    <input id="log-file-upload" type="file" class="sr-only" accept="image/*"/>
                                                </label>
                                                <p class="pl-1">หรือลากและวาง</p>
                                            </div>
                                            <p class="text-xs text-gray-500">PNG, JPG, GIF</p>
                                        </div>
                                    </div>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700">คำอธิบาย (ถ้ามี)</label>
                                    <textarea id="log-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                            </div>
                            <button id="log-submit-btn" class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-150 ease-in-out">บันทึกกิจกรรม</button>
                             <p id="log-message" class="mt-4 text-center font-semibold"></p>
                        </div>
                    </div>

                    <!-- History Page -->
                    <div id="history-page" class="page">
                         <div class="p-6 bg-white rounded-xl shadow-lg">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">ประวัติการบันทึกทั้งหมด</h2>
                            <div id="history-container" class="space-y-6"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="text-center mt-8 text-gray-400 text-xs">
               <p id="footer-text">ข้อมูลถูกจัดเก็บในระบบคลาวด์</p>
            </footer>
        </main>
        
        <!-- Modals and Popups -->
        <div id="sending-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
                <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="font-semibold">กำลังส่งข้อมูล...</span>
            </div>
        </div>
        
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 max-w-sm">
                <h3 class="text-lg font-bold text-gray-900 mb-2">ยืนยันการลบ</h3>
                <p id="confirm-modal-message" class="text-gray-600 mb-6">คุณต้องการลบรายการนี้ใช่หรือไม่?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">ลบ</button>
                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration and Constants ---
        const CONFIG = {
            LIFF_ID: "1654435774-wze0oX67",
            WEBHOOK_URL: 'https://prod-53.southeastasia.logic.azure.com:443/workflows/c2e513eb481f410ba8177327c40e7f9d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=AiNM5m_ySfmRHe50_UsM83kLpJJOMBtCkvID9APwgvc',
            EXERCISE_TYPE_MAP: {
                running: 'การวิ่ง',
                walking: 'เดิน',
                cycling: 'ปั่นจักรยาน',
                other: 'กีฬาอื่นๆ'
            }
        };

        // --- DOM Element References ---
        const DOM = {
            appLoading: document.getElementById('app-loading'),
            mainApp: document.getElementById('main-app'),
            liffLoading: document.getElementById('liff-loading'),
            liffProfileContainer: document.getElementById('liff-profile'),
            liffDisplayName: document.getElementById('liff-display-name'),
            liffPictureUrl: document.getElementById('liff-picture-url'),
            footerText: document.getElementById('footer-text'),
            navButtons: document.querySelectorAll('.nav-button'),
            pages: document.querySelectorAll('.page'),
            profile: {
                dob: document.getElementById('profile-dob'),
                gender: document.getElementById('profile-gender'),
                weight: document.getElementById('profile-weight'),
                height: document.getElementById('profile-height'),
                saveBtn: document.getElementById('save-profile-btn'),
                ageDisplay: document.getElementById('age-display'),
                bmiDisplay: document.getElementById('bmi-display'),
                message: document.getElementById('profile-message'),
                weightChartCanvas: document.getElementById('weightChart'),
            },
            log: {
                typeButtons: document.querySelectorAll('.log-type-btn'),
                exerciseTypeContainer: document.getElementById('exercise-type-container'),
                exerciseType: document.getElementById('log-exercise-type'),
                kcalInputContainer: document.getElementById('kcal-input-container'),
                kcal: document.getElementById('log-kcal'),
                kmInputContainer: document.getElementById('km-input-container'),
                km: document.getElementById('log-km'),
                minutesInputContainer: document.getElementById('minutes-input-container'),
                minutes: document.getElementById('log-minutes'),
                uploadLabel: document.getElementById('log-upload-label'),
                fileInput: document.getElementById('log-file-upload'),
                preview: document.getElementById('log-preview'),
                placeholderIcon: document.getElementById('log-placeholder-icon'),
                description: document.getElementById('log-description'),
                submitBtn: document.getElementById('log-submit-btn'),
                message: document.getElementById('log-message'),
            },
            historyContainer: document.getElementById('history-container'),
            dashboard: {
                 bmiGaugeChartCanvas: document.getElementById('bmiGaugeChart'),
                 exerciseSummaryContainer: document.getElementById('exercise-summary-container'),
            },
            sendingPopup: document.getElementById('sending-popup'),
            confirmModal: {
                container: document.getElementById('confirm-modal'),
                confirmBtn: document.getElementById('confirm-delete-btn'),
                cancelBtn: document.getElementById('cancel-delete-btn'),
            }
        };

        // --- Application State ---
        let state = {
            firebase: {
                app: null,
                auth: null,
                db: null,
                userId: null,
            },
            liff: {
                profile: null,
                liffId: null,
            },
            appData: {
                profile: { dob: '', gender: '' },
                weightHistory: [],
                heightHistory: [],
                logs: [],
            },
            currentLogType: 'exercise',
            logImageBase64: null,
            weightChartInstance: null,
            bmiGaugeChartInstance: null,
            itemToDeleteId: null,
            unsubscribeListeners: [], // To store unsubscribe functions for cleanup
        };

        // --- Helper & Utility Functions ---
        const setElementVisibility = (element, isVisible) => element.classList.toggle('hidden', !isVisible);
        const showUserMessage = (element, text, isSuccess) => {
            element.textContent = text;
            element.className = `mt-4 text-center font-semibold ${isSuccess ? 'text-green-600' : 'text-red-600'}`;
            setTimeout(() => { element.textContent = ''; }, 3000);
        };
        const resizeImage = (file, maxWidth = 800, maxHeight = 600, quality = 0.85) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.onerror = reject;
                    img.onload = () => {
                        let { width, height } = img;
                        if (width > height) { if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; } } 
                        else { if (height > maxHeight) { width = Math.round((width * maxHeight) / height); height = maxHeight; } }
                        const canvas = document.createElement('canvas');
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- API & Webhook Communication ---
        const postToWebhook = async (payload) => {
            const cleanedPayload = Object.entries(payload).reduce((acc, [key, value]) => {
                if (value !== null && value !== undefined) acc[key] = value;
                return acc;
            }, {});
            console.log("Sending cleaned payload to webhook:", JSON.stringify(cleanedPayload, null, 2));
            try {
                const response = await fetch(CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanedPayload)
                });
                if (![200, 202].includes(response.status)) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with status: ${response.status}. ${errorText}`);
                }
                console.log('Data posted successfully.');
            } catch (error) {
                console.error('Error posting data to webhook:', error);
            }
        };

        // --- Business Logic (Calculations) ---
        const calculateAge = (dobString) => {
            if (!dobString) return null;
            const birthDate = new Date(dobString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        };
        const calculateBmi = () => {
            const lastWeight = state.appData.weightHistory.at(-1)?.value;
            const lastHeight = state.appData.heightHistory.at(-1)?.value;
            if (!lastWeight || !lastHeight || lastHeight <= 0) return { value: null, info: null };
            const heightInMeters = lastHeight / 100;
            const bmiValue = (lastWeight / (heightInMeters * heightInMeters)).toFixed(1);
            let bmiInfo = {};
            if (bmiValue < 18.5) bmiInfo = { text: 'น้ำหนักน้อยกว่าเกณฑ์', color: '#3b82f6' };
            else if (bmiValue <= 22.9) bmiInfo = { text: 'สมส่วน', color: '#22c55e' };
            else if (bmiValue <= 24.9) bmiInfo = { text: 'น้ำหนักเกิน', color: '#f59e0b' };
            else if (bmiValue <= 29.9) bmiInfo = { text: 'โรคอ้วน', color: '#f97316' };
            else bmiInfo = { text: 'โรคอ้วนอันตราย', color: '#ef4444' };
            return { value: bmiValue, info: bmiInfo };
        };

        // --- UI Rendering & Updates ---
        const updateLiffProfileUI = () => {
            DOM.liffDisplayName.textContent = state.liff.profile.displayName;
            DOM.liffPictureUrl.src = state.liff.profile.pictureUrl;
            setElementVisibility(DOM.liffProfileContainer, true);
            setElementVisibility(DOM.liffLoading, false);
            DOM.footerText.textContent = `UserID: ${state.firebase.userId}`;
        };
        const renderProfileBmiDisplay = () => {
            const { value, info } = calculateBmi();
            if (!value) {
                DOM.profile.bmiDisplay.innerHTML = '';
                return;
            }
            DOM.profile.bmiDisplay.innerHTML = `<div class="mt-4 p-4 bg-gray-100 rounded-lg text-center"><h3 class="font-bold text-lg">ค่าดัชนีมวลกาย (BMI)</h3><p class="text-3xl font-bold">${value}</p><p class="font-semibold" style="color:${info.color};">${info.text}</p></div>`;
        };
        const updateProfileCalculations = () => {
            const age = calculateAge(DOM.profile.dob.value);
            DOM.profile.ageDisplay.textContent = age !== null ? `อายุ: ${age} ปี` : '';
            renderProfileBmiDisplay();
        };
        const renderWeightChart = () => {
            const ctx = DOM.profile.weightChartCanvas.getContext('2d');
            if (state.weightChartInstance) state.weightChartInstance.destroy();
            if (state.appData.weightHistory.length < 2) {
                ctx.clearRect(0, 0, DOM.profile.weightChartCanvas.width, DOM.profile.weightChartCanvas.height);
                ctx.font = "16px Sarabun";
                ctx.fillStyle = "rgb(107, 114, 128)";
                ctx.textAlign = "center";
                ctx.fillText("ต้องการข้อมูลน้ำหนักอย่างน้อย 2 ครั้งเพื่อสร้างกราฟ", DOM.profile.weightChartCanvas.width / 2, DOM.profile.weightChartCanvas.height / 2);
                return;
            }
            const labels = state.appData.weightHistory.map((entry, index) => {
                const date = entry.timestamp.toDate();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                return [`ครั้งที่ ${index + 1}`, `${day}-${month}-${year}`];
            });
            const data = state.appData.weightHistory.map(entry => entry.value);
            state.weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'น้ำหนัก (kg)', data, borderColor: 'rgb(79, 70, 229)', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.1 }] },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: { y: { beginAtZero: false }, x: { title: { display: false } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => new Date(state.appData.weightHistory[tooltipItems[0].dataIndex].timestamp.toMillis()).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                                label: (tooltipItem) => `น้ำหนัก: ${tooltipItem.formattedValue} kg`
                            }
                        }
                    }
                }
            });
        };
        const renderBmiGauge = () => {
            const { value, info } = calculateBmi();
            const ctx = DOM.dashboard.bmiGaugeChartCanvas.getContext('2d');
            if(state.bmiGaugeChartInstance) state.bmiGaugeChartInstance.destroy();
            if (!value) {
                ctx.clearRect(0, 0, DOM.dashboard.bmiGaugeChartCanvas.width, DOM.dashboard.bmiGaugeChartCanvas.height);
                ctx.font = "16px Sarabun"; ctx.fillStyle = "rgb(107, 114, 128)"; ctx.textAlign = "center";
                ctx.fillText("ไม่มีข้อมูล BMI", DOM.dashboard.bmiGaugeChartCanvas.width / 2, DOM.dashboard.bmiGaugeChartCanvas.height / 2);
                return;
            }
            const maxBmi = 50;
            state.bmiGaugeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [value, maxBmi - value], backgroundColor: [info.color, '#e5e7eb'], borderColor: ['#fff', '#fff'], borderWidth: 2, circumference: 180, rotation: -90, }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { display: false }, tooltip: { enabled: false },
                        datalabels: {
                            formatter: (val, context) => (context.dataIndex === 0) ? `${val}\n${info.text}` : '',
                            color: '#1f2937', textAlign: 'center', font: { size: 18, weight: 'bold', family: 'Sarabun' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        };
        const renderExerciseSummary = () => {
            const summary = { running: { km: 0 }, walking: { km: 0 }, cycling: { km: 0 }, other: { minutes: 0 } };
            state.appData.logs.filter(log => log.type === 'exercise').forEach(log => {
                if (log.exerciseType && summary[log.exerciseType]) {
                    if (log.km) summary[log.exerciseType].km += log.km;
                    if (log.minutes) summary[log.exerciseType].minutes += log.minutes;
                }
            });
            DOM.dashboard.exerciseSummaryContainer.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg"><span class="font-semibold text-gray-600">วิ่ง</span><span class="font-bold text-lg text-indigo-600">${summary.running.km.toFixed(1)} กม.</span></div>
                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg"><span class="font-semibold text-gray-600">เดิน</span><span class="font-bold text-lg text-indigo-600">${summary.walking.km.toFixed(1)} กม.</span></div>
                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg"><span class="font-semibold text-gray-600">ปั่นจักรยาน</span><span class="font-bold text-lg text-indigo-600">${summary.cycling.km.toFixed(1)} กม.</span></div>
                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg"><span class="font-semibold text-gray-600">กีฬาอื่นๆ</span><span class="font-bold text-lg text-indigo-600">${summary.other.minutes} นาที</span></div>`;
        };
        const createHistoryItemHTML = (item) => {
            const logDate = item.timestamp.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
            let contentHtml = '';
            if (item.type === 'exercise' || item.type === 'food') {
                const isExercise = item.type === 'exercise';
                const typeDisplay = isExercise ? { text: 'ออกกำลังกาย', bg: 'bg-blue-100', textColor: 'text-blue-800' } : { text: 'อาหาร', bg: 'bg-green-100', textColor: 'text-green-800' };
                let detailsHtml = '';
                if (isExercise) {
                    const typeText = CONFIG.EXERCISE_TYPE_MAP[item.exerciseType] || 'ออกกำลังกาย';
                    const valueText = item.km > 0 ? `${item.km} กม.` : (item.minutes > 0 ? `${item.minutes} นาที` : '');
                    detailsHtml = `<p class="mt-1 font-semibold text-blue-600">${typeText}${valueText ? `: ${valueText}` : ''}</p>`;
                } else {
                    detailsHtml = `<p class="mt-1 font-semibold text-orange-600">${item.kcal || 0} kcal</p>`;
                }
                contentHtml = `<img src="${item.imageData}" alt="${item.description || 'log image'}" class="w-24 h-24 object-cover rounded-md bg-gray-200 flex-shrink-0"><div class="flex-1 flex flex-col"><div class="flex-grow pr-6"><span class="px-2 py-1 text-xs font-semibold rounded-full ${typeDisplay.bg} ${typeDisplay.textColor}">${typeDisplay.text}</span><p class="mt-2 text-gray-700">${item.description || 'ไม่มีคำอธิบาย'}</p>${detailsHtml}</div><div class="text-right text-xs text-gray-400 mt-2">${logDate}</div></div>`;
            } else {
                const isWeight = item.type === 'weight';
                const iconSvg = isWeight ? `<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : `<svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                contentHtml = `<div class="flex-shrink-0 w-12 h-12 rounded-full ${isWeight ? 'bg-purple-100' : 'bg-teal-100'} flex items-center justify-center">${iconSvg}</div><div class="flex-1 flex flex-col"><div class="flex-grow pr-6"><span class="font-semibold text-gray-800">อัปเดต${isWeight ? 'น้ำหนัก' : 'ส่วนสูง'}</span><p class="mt-1 text-lg text-gray-700 font-bold">${item.value} ${isWeight ? 'kg' : 'cm'}</p></div><div class="text-right text-xs text-gray-400 mt-1">${logDate}</div></div>`;
            }
            return `<div class="relative flex items-start space-x-4 p-4 border border-gray-200 rounded-lg">${contentHtml}<button class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-500" data-id="${item.id}" data-type="${item.type}"><svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
        };
        const loadHistory = () => {
            const combinedHistory = [
                ...state.appData.logs,
                ...state.appData.weightHistory.map(entry => ({ ...entry, type: 'weight' })),
                ...state.appData.heightHistory.map(entry => ({ ...entry, type: 'height' }))
            ].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
            if (combinedHistory.length === 0) {
                DOM.historyContainer.innerHTML = '<p class="text-center text-gray-500">ยังไม่มีข้อมูลบันทึก</p>';
                return;
            }
            DOM.historyContainer.innerHTML = combinedHistory.map(item => createHistoryItemHTML({ ...item, sortDate: item.timestamp })).join('');
        };
        const loadDashboard = () => { renderBmiGauge(); renderExerciseSummary(); };
        const loadProfileForm = () => {
            const { profile, weightHistory, heightHistory } = state.appData;
            DOM.profile.dob.value = profile.dob || '';
            DOM.profile.gender.value = profile.gender || '';
            DOM.profile.weight.value = weightHistory.at(-1)?.value || '';
            DOM.profile.height.value = heightHistory.at(-1)?.value || '';
            updateProfileCalculations();
            renderWeightChart();
        };
        const resetLogForm = () => {
            DOM.log.description.value = ''; DOM.log.fileInput.value = ''; DOM.log.kcal.value = ''; DOM.log.km.value = ''; DOM.log.minutes.value = '';
            DOM.log.exerciseType.value = 'running'; state.logImageBase64 = null; DOM.log.preview.src = '';
            setElementVisibility(DOM.log.preview, false); setElementVisibility(DOM.log.placeholderIcon, true);
            DOM.log.typeButtons[0].click(); 
        };

        // --- Event Handlers ---
        const handleSaveProfile = async () => {
            setElementVisibility(DOM.sendingPopup, true);
            try {
                const { db, userId } = state.firebase;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const profileRef = doc(db, "artifacts", appId, "users", userId);
                const newWeight = parseFloat(DOM.profile.weight.value);
                const newHeight = parseFloat(DOM.profile.height.value);
                
                const profileData = {
                    dob: DOM.profile.dob.value,
                    gender: DOM.profile.gender.value,
                    updatedAt: serverTimestamp()
                };
                await setDoc(profileRef, { profile: profileData }, { merge: true });

                if (newWeight) await addDoc(collection(profileRef, "weights"), { value: newWeight, timestamp: serverTimestamp() });
                if (newHeight) await addDoc(collection(profileRef, "heights"), { value: newHeight, timestamp: serverTimestamp() });
                
                const webhookPayload = {
                    userId: userId, displayName: state.liff.profile.displayName, pictureUrl: state.liff.profile.pictureUrl,
                    timestamp: new Date().toISOString(), eventType: 'profileUpdate', description: 'Profile updated.',
                    dob: profileData.dob || null, gender: profileData.gender || null,
                    height: newHeight || null, weight: newWeight || null,
                };
                await postToWebhook(webhookPayload);

                showUserMessage(DOM.profile.message, 'บันทึกข้อมูลสำเร็จ!', true);
            } catch (error) {
                console.error("Error saving profile:", error);
                showUserMessage(DOM.profile.message, 'เกิดข้อผิดพลาดในการบันทึก', false);
            } finally {
                setElementVisibility(DOM.sendingPopup, false);
            }
        };
        const handleSaveLog = async () => {
            if (!state.logImageBase64) { showUserMessage(DOM.log.message, 'กรุณาเลือกรูปภาพ', false); return; }
            setElementVisibility(DOM.sendingPopup, true);
            try {
                const { db, userId } = state.firebase;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const logsCollectionRef = collection(db, "artifacts", appId, "users", userId, "logs");
                
                const logToSave = {
                    type: state.currentLogType,
                    description: DOM.log.description.value,
                    imageData: state.logImageBase64,
                    timestamp: serverTimestamp(),
                    exerciseType: null, km: 0, minutes: 0, kcal: 0
                };

                if (state.currentLogType === 'exercise') {
                    logToSave.exerciseType = DOM.log.exerciseType.value;
                    if (['running', 'walking', 'cycling'].includes(logToSave.exerciseType)) logToSave.km = parseFloat(DOM.log.km.value) || 0;
                    else logToSave.minutes = parseInt(DOM.log.minutes.value) || 0;
                } else {
                    logToSave.kcal = parseInt(DOM.log.kcal.value) || 0;
                }
                
                await addDoc(logsCollectionRef, logToSave);
                
                const webhookPayload = {
                    userId: userId, displayName: state.liff.profile.displayName, pictureUrl: state.liff.profile.pictureUrl,
                    timestamp: new Date().toISOString(), eventType: logToSave.type,
                    description: logToSave.description || null, imageData: logToSave.imageData,
                    height: state.appData.heightHistory.at(-1)?.value || null, weight: state.appData.weightHistory.at(-1)?.value || null,
                    exerciseType: logToSave.exerciseType, km: logToSave.km > 0 ? logToSave.km : null,
                    minutes: logToSave.minutes > 0 ? logToSave.minutes : null, kcal: logToSave.kcal > 0 ? logToSave.kcal : null,
                };
                await postToWebhook(webhookPayload);

                showUserMessage(DOM.log.message, 'บันทึกกิจกรรมสำเร็จ!', true);
                resetLogForm();
            } catch (error) {
                console.error("Error saving log:", error);
                showUserMessage(DOM.log.message, 'เกิดข้อผิดพลาดในการบันทึกกิจกรรม', false);
            } finally {
                setElementVisibility(DOM.sendingPopup, false);
            }
        };
        const handleDeleteItem = async () => {
            if (!state.itemToDeleteId) return;
            const { id, type } = state.itemToDeleteId;
            const { db, userId } = state.firebase;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let docRef;

            if (type === 'weight') docRef = doc(db, "artifacts", appId, "users", userId, "weights", id);
            else if (type === 'height') docRef = doc(db, "artifacts", appId, "users", userId, "heights", id);
            else docRef = doc(db, "artifacts", appId, "users", userId, "logs", id);
            
            try {
                await deleteDoc(docRef);
                console.log("Document deleted successfully");
            } catch(error) {
                console.error("Error deleting document: ", error);
            } finally {
                state.itemToDeleteId = null;
                setElementVisibility(DOM.confirmModal.container, false);
            }
        };
        const handleNavigation = (event) => {
            const button = event.currentTarget;
            const targetPageId = button.dataset.page + '-page';
            DOM.pages.forEach(page => page.classList.remove('active'));
            document.getElementById(targetPageId).classList.add('active');
            DOM.navButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-700', 'bg-gray-200', 'hover:bg-gray-300');
            });
            button.classList.add('bg-indigo-600', 'text-white');
            button.classList.remove('text-gray-700', 'bg-gray-200', 'hover:bg-gray-300');
            if (button.dataset.page === 'history') loadHistory();
            if (button.dataset.page === 'profile') renderWeightChart();
            if (button.dataset.page === 'dashboard') loadDashboard();
        };
        const handleImageSelection = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const resizedBase64 = await resizeImage(file);
                state.logImageBase64 = resizedBase64;
                DOM.log.preview.src = resizedBase64;
                setElementVisibility(DOM.log.preview, true);
                setElementVisibility(DOM.log.placeholderIcon, false);
            } catch (error) {
                console.error("Image processing failed:", error);
                showUserMessage(DOM.log.message, 'ประมวลผลรูปภาพไม่สำเร็จ', false);
            }
        };

        // --- Real-time Data Listeners ---
        const setupFirestoreListeners = () => {
            const { db, userId } = state.firebase;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Clean up old listeners before attaching new ones
            state.unsubscribeListeners.forEach(unsub => unsub());
            state.unsubscribeListeners = [];

            // Listener for Profile
            const profileRef = doc(db, "artifacts", appId, "users", userId);
            const unsubProfile = onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.appData.profile = docSnap.data().profile || { dob: '', gender: '' };
                } else {
                    console.log("No profile document! Creating one.");
                    setDoc(profileRef, { profile: { createdAt: serverTimestamp() } }, { merge: true });
                }
                loadProfileForm();
                loadDashboard();
            });

            // Listener for Weight History
            const weightsQuery = query(collection(profileRef, "weights"), orderBy("timestamp", "asc"));
            const unsubWeights = onSnapshot(weightsQuery, (querySnapshot) => {
                state.appData.weightHistory = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadProfileForm();
                loadDashboard();
                if(document.getElementById('history-page').classList.contains('active')) loadHistory();
            });

            // Listener for Height History
            const heightsQuery = query(collection(profileRef, "heights"), orderBy("timestamp", "asc"));
            const unsubHeights = onSnapshot(heightsQuery, (querySnapshot) => {
                state.appData.heightHistory = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadProfileForm();
                loadDashboard();
                if(document.getElementById('history-page').classList.contains('active')) loadHistory();
            });

            // Listener for Logs
            const logsQuery = query(collection(profileRef, "logs"), orderBy("timestamp", "desc"));
            const unsubLogs = onSnapshot(logsQuery, (querySnapshot) => {
                state.appData.logs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadDashboard();
                if(document.getElementById('history-page').classList.contains('active')) loadHistory();
            });

            state.unsubscribeListeners.push(unsubProfile, unsubWeights, unsubHeights, unsubLogs);
        };

        // --- Initialization ---
        const setupEventListeners = () => {
            DOM.navButtons.forEach(button => button.addEventListener('click', handleNavigation));
            [DOM.profile.dob, DOM.profile.weight, DOM.profile.height, DOM.profile.gender].forEach(input => input.addEventListener('input', updateProfileCalculations));
            DOM.profile.saveBtn.addEventListener('click', handleSaveProfile);
            DOM.log.typeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    state.currentLogType = button.dataset.logType;
                    const isExercise = state.currentLogType === 'exercise';
                    DOM.log.uploadLabel.textContent = `อัปโหลดรูปภาพ${isExercise ? 'การออกกำลังกาย' : 'อาหาร'}`;
                    setElementVisibility(DOM.log.exerciseTypeContainer, isExercise);
                    setElementVisibility(DOM.log.kcalInputContainer, !isExercise);
                    if (isExercise) DOM.log.exerciseType.dispatchEvent(new Event('change'));
                    else { setElementVisibility(DOM.log.kmInputContainer, false); setElementVisibility(DOM.log.minutesInputContainer, false); }
                    DOM.log.typeButtons.forEach(btn => {
                        btn.classList.remove('border-indigo-500', 'text-indigo-600'); btn.classList.add('text-gray-500');
                    });
                    button.classList.add('border-indigo-500', 'text-indigo-600');
                });
            });
            DOM.log.exerciseType.addEventListener('change', (e) => {
                const isOther = e.target.value === 'other';
                setElementVisibility(DOM.log.kmInputContainer, !isOther);
                setElementVisibility(DOM.log.minutesInputContainer, isOther);
            });
            DOM.log.fileInput.addEventListener('change', handleImageSelection);
            DOM.log.submitBtn.addEventListener('click', handleSaveLog);
            DOM.historyContainer.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-btn');
                if (deleteButton) {
                    state.itemToDeleteId = { id: deleteButton.dataset.id, type: deleteButton.dataset.type };
                    setElementVisibility(DOM.confirmModal.container, true);
                }
            });
            DOM.confirmModal.cancelBtn.addEventListener('click', () => {
                state.itemToDeleteId = null; setElementVisibility(DOM.confirmModal.container, false);
            });
            DOM.confirmModal.confirmBtn.addEventListener('click', handleDeleteItem);
        };
        const initializeAppUI = () => {
            setElementVisibility(DOM.appLoading, false);
            setElementVisibility(DOM.mainApp, true);
            setupEventListeners();
            setupFirestoreListeners();
        };
        const main = async () => {
            try {
                // These should be provided by the environment
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig) {
                    throw new Error("Firebase config is not available.");
                }

                // 1. Initialize Firebase
                state.firebase.app = initializeApp(firebaseConfig);
                state.firebase.auth = getAuth(state.firebase.app);
                state.firebase.db = getFirestore(state.firebase.app);

                // 2. Authenticate with Firebase
                if (customToken) {
                    await signInWithCustomToken(state.firebase.auth, customToken);
                } else {
                    await signInAnonymously(state.firebase.auth);
                }
                
                // 3. Initialize LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return; 
                }
                
                state.liff.profile = await liff.getProfile();
                state.firebase.userId = state.liff.profile.userId; // Use LIFF User ID for document paths

                // 4. Start the app
                updateLiffProfileUI();
                initializeAppUI();

            } catch (error) {
                console.error("Initialization failed", error);
                DOM.appLoading.textContent = `เกิดข้อผิดพลาดในการเริ่มต้น: ${error.message}`;
                setElementVisibility(DOM.liffLoading, false);
            }
        };

        main();
    </script>
</body>
</html>
