<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker V2</title>

    <!-- External Libraries -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Input Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            ring: 2px;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* File Input Style */
        .file-input-label {
            cursor: pointer;
            border: 2px dashed #cbd5e1;
            padding: 2rem;
            transition: all 0.2s ease-in-out;
            border-radius: 0.75rem;
            background-color: #f8fafc;
        }
        .file-input-label:hover {
            background-color: #eff6ff;
            border-color: #6366f1;
        }

        /* Navigation Button Style */
        .nav-btn {
            transition: all 0.2s;
        }
        .nav-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-6 px-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- Header -->
        <div class="p-6 border-b border-gray-100 bg-white sticky top-0 z-20">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Health Tracker</h1>
                    <p class="text-sm text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
                </div>
                <!-- LIFF Profile -->
                <div id="liff-profile" class="hidden flex items-center gap-3 bg-gray-50 py-1.5 px-3 rounded-full border border-gray-100">
                    <span id="liff-display-name" class="text-sm font-semibold text-gray-700 truncate max-w-[100px]"></span>
                    <img id="liff-picture-url" class="w-8 h-8 rounded-full border-2 border-white shadow-sm" src="" alt="Profile">
                </div>
                <div id="liff-loading" class="text-xs text-indigo-500 animate-pulse font-medium">
                    Connecting...
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-6 flex p-1 bg-gray-100 rounded-xl">
                <button data-page="dashboard" class="nav-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-900">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                <button data-page="profile" class="nav-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-900 active">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                <button data-page="log" class="nav-btn flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-900">‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button data-page="history" class="nav-btn flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="p-6">
            
            <!-- Loading Indicator -->
            <div id="app-loading" class="text-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div id="main-app" class="hidden">
                
                <!-- 1. DASHBOARD PAGE -->
                <div id="dashboard-page" class="page">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                    </h2>
                    
                    <!-- BMI Gauge -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6 flex flex-col items-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢ (BMI)</h3>
                        <div class="relative w-full max-w-[280px] h-48">
                            <canvas id="bmiGaugeChart"></canvas>
                        </div>
                    </div>

                    <!-- Exercise Summary -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div id="exercise-summary-container" class="grid grid-cols-2 gap-3">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- 2. PROFILE PAGE -->
                <div id="profile-page" class="page active">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                        </h2>
                        <div id="bmi-display" class="text-sm font-medium"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                                <input type="number" id="profile-age" class="form-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏û‡∏®</label>
                                <select id="profile-gender" class="form-input bg-white">
                                    <option value="">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏®</option>
                                    <option value="male">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm)</label>
                                <input type="number" id="profile-height" class="form-input" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                                <input type="number" id="profile-weight" class="form-input" placeholder="0.0">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</label>
                                <input type="number" id="profile-bodyfat" class="form-input" placeholder="0.0" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">% ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</label>
                                <input type="number" id="profile-muscle" class="form-input" placeholder="0.0" step="0.1">
                            </div>
                        </div>

                        <button id="save-profile-btn" class="w-full mt-6 bg-indigo-600 text-white py-3 rounded-xl font-semibold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 transition-all active:scale-95">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                        </button>
                        <p id="profile-message" class="h-6 text-sm"></p>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3>
                        <div class="bg-gray-50 p-2 rounded-xl border border-gray-100 h-64">
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 3. LOG PAGE -->
                <div id="log-page" class="page">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                    </h2>

                    <!-- Type Toggle -->
                    <div class="flex p-1 bg-gray-100 rounded-lg mb-6">
                        <button data-log-type="exercise" class="log-type-btn flex-1 py-2 rounded-md text-sm font-medium transition-all bg-white text-indigo-600 shadow-sm">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</button>
                        <button data-log-type="food" class="log-type-btn flex-1 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-900">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    </div>

                    <div class="space-y-5">
                        <!-- Exercise Type -->
                        <div id="exercise-type-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <select id="log-exercise-type" class="form-input bg-white">
                                <option value="running">üèÉ ‡∏ß‡∏¥‡πà‡∏á (Running)</option>
                                <option value="walking">üö∂ ‡πÄ‡∏î‡∏¥‡∏ô (Walking)</option>
                                <option value="cycling">üö¥ ‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô (Cycling)</option>
                                <option value="other">üèãÔ∏è ‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)</option>
                            </select>
                        </div>

                        <!-- Value Inputs -->
                        <div id="km-input-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</label>
                            <input type="number" id="log-km" class="form-input" placeholder="0.00" step="0.01">
                        </div>

                        <div id="minutes-input-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                            <input type="number" id="log-minutes" class="form-input" placeholder="0">
                        </div>

                        <div id="kcal-input-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</label>
                            <input type="number" id="log-kcal" class="form-input" placeholder="0">
                        </div>

                        <!-- Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label>
                            <label for="log-file-upload" class="file-input-label flex flex-col items-center justify-center group">
                                <div id="upload-placeholder" class="text-center">
                                    <div class="w-12 h-12 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-indigo-100 transition-colors">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </div>
                                    <p class="text-sm text-gray-500"><span class="text-indigo-600 font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span></p>
                                    <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG</p>
                                </div>
                                <img id="log-preview" class="hidden max-h-64 rounded-lg shadow-sm object-contain" alt="Preview">
                            </label>
                            <input id="log-file-upload" type="file" class="hidden" accept="image/*">
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="log-description" rows="3" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞, ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà..."></textarea>
                        </div>

                        <button id="log-submit-btn" class="w-full mt-6 bg-indigo-600 text-white py-3 rounded-xl font-semibold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 transition-all active:scale-95">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                        </button>
                        <p id="log-message" class="h-6 text-sm"></p>
                    </div>
                </div>

                <!-- 4. HISTORY PAGE -->
                <div id="history-page" class="page">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </h2>
                    <div id="history-container" class="space-y-4 pb-12">
                        <!-- History Items -->
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="mt-10 text-center border-t border-gray-100 pt-6">
                <p class="text-xs text-gray-400">Health Tracker V2 &copy; 2024</p>
                <p id="footer-text" class="text-xs text-gray-300 mt-1 font-mono">ID: -</p>
            </div>
        </div>
    </div>

    <!-- Loading Popup -->
    <div id="sending-popup" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white px-8 py-6 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce-small">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-100 border-t-indigo-600 mb-4"></div>
            <span class="font-semibold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl transform transition-all scale-100">
            <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 text-center mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p class="text-gray-500 text-center text-sm mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
            <div class="flex gap-3">
                <button id="cancel-delete-btn" class="flex-1 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-btn" class="flex-1 py-2.5 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition-colors shadow-lg shadow-red-200">‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const CONFIG = {
            LIFF_ID: "1654435774-VGmjB3Gk",
            APP_ID: "default-app-id",
            EXERCISE_MAP: { running: '‡∏ß‡∏¥‡πà‡∏á', walking: '‡πÄ‡∏î‡∏¥‡∏ô', cycling: '‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô', other: '‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
        };

        // --- DOM ---
        const el = (id) => document.getElementById(id);
        const DOM = {
            loading: el('app-loading'), main: el('main-app'),
            liffLoading: el('liff-loading'), liffProfile: el('liff-profile'), 
            liffName: el('liff-display-name'), liffPic: el('liff-picture-url'),
            footer: el('footer-text'), navBtns: document.querySelectorAll('.nav-button'), pages: document.querySelectorAll('.page'),
            profile: {
                age: el('profile-age'), gender: el('profile-gender'), weight: el('profile-weight'), height: el('profile-height'),
                bodyfat: el('profile-bodyfat'), muscle: el('profile-muscle'), btn: el('save-profile-btn'), 
                msg: el('profile-message'), bmi: el('bmi-display'), chart: el('weightChart')
            },
            log: {
                typeBtns: document.querySelectorAll('.log-type-btn'), typeContainer: el('exercise-type-container'), 
                typeSelect: el('log-exercise-type'), kcalDiv: el('kcal-input-container'), kcal: el('log-kcal'),
                kmDiv: el('km-input-container'), km: el('log-km'), minDiv: el('minutes-input-container'), min: el('log-minutes'),
                label: el('log-upload-label'), file: el('log-file-upload'), preview: el('log-preview'), placeholder: el('upload-placeholder'),
                desc: el('log-description'), btn: el('log-submit-btn'), msg: el('log-message')
            },
            history: el('history-container'),
            dash: { gauge: el('bmiGaugeChart'), summary: el('exercise-summary-container') },
            popup: el('sending-popup'),
            modal: { box: el('confirm-modal'), ok: el('confirm-delete-btn'), cancel: el('cancel-delete-btn') }
        };

        // --- STATE ---
        let state = {
            db: null, uid: null, liffUid: null,
            data: { profile: {}, weightHistory: [], heightHistory: [], bodyfatHistory: [], muscleHistory: [], logs: [] },
            logType: 'exercise', imgBase64: null, charts: {}, deleteId: null, unsubs: []
        };

        // --- UTILS ---
        const toggle = (el, show) => el.classList.toggle('hidden', !show);
        const msg = (el, txt, success) => {
            el.textContent = txt;
            el.className = `h-6 text-sm text-center font-medium ${success ? 'text-green-600' : 'text-red-600'}`;
            setTimeout(() => el.textContent = '', 3000);
        };
        const resize = (file) => new Promise((resolve) => {
            const r = new FileReader();
            r.onload = (e) => {
                const i = new Image();
                i.onload = () => {
                    let {width: w, height: h} = i;
                    if (w > h) { if (w > 800) { h = Math.round(h * (800/w)); w = 800; } }
                    else { if (h > 600) { w = Math.round(w * (600/h)); h = 600; } }
                    const c = document.createElement('canvas'); c.width = w; c.height = h;
                    c.getContext('2d').drawImage(i, 0, 0, w, h);
                    resolve(c.toDataURL('image/jpeg', 0.85));
                };
                i.src = e.target.result;
            };
            r.readAsDataURL(file);
        });

        // --- LOGIC ---
        const calcBMI = () => {
            const w = state.data.weightHistory.at(-1)?.value;
            const h = state.data.heightHistory.at(-1)?.value;
            if (!w || !h) return null;
            const hm = h/100;
            const val = (w / (hm*hm)).toFixed(1);
            let color = '#3b82f6';
            if (val >= 18.5 && val <= 22.9) color = '#22c55e';
            else if (val >= 23 && val <= 24.9) color = '#eab308';
            else if (val >= 25 && val <= 29.9) color = '#f97316';
            else if (val >= 30) color = '#ef4444';
            return { val, color };
        };

        // --- RENDER ---
        const renderProfile = () => {
            const p = state.data.profile;
            DOM.profile.age.value = p.age || '';
            DOM.profile.gender.value = p.gender || '';
            DOM.profile.weight.value = state.data.weightHistory.at(-1)?.value || '';
            DOM.profile.height.value = state.data.heightHistory.at(-1)?.value || '';
            DOM.profile.bodyfat.value = state.data.bodyfatHistory.at(-1)?.value || '';
            DOM.profile.muscle.value = state.data.muscleHistory.at(-1)?.value || '';

            const bmi = calcBMI();
            DOM.profile.bmiDisplay.innerHTML = bmi ? 
                `<span class="text-gray-500">BMI:</span> <span class="text-lg font-bold" style="color:${bmi.color}">${bmi.val}</span>` : '';

            // Chart
            if (state.charts.weight) state.charts.weight.destroy();
            if (state.data.weightHistory.length < 2) {
                const ctx = DOM.profile.weightChartCanvas.getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "14px Sarabun"; ctx.fillStyle = "#9ca3af"; ctx.textAlign = "center";
                ctx.fillText("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ", ctx.canvas.width/2, ctx.canvas.height/2);
            } else {
                state.charts.weight = new Chart(DOM.profile.weightChartCanvas, {
                    type: 'line',
                    data: {
                        labels: state.data.weightHistory.map((_, i) => `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i+1}`),
                        datasets: [{
                            label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å',
                            data: state.data.weightHistory.map(d => d.value),
                            borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2, tension: 0.3, fill: true, pointRadius: 3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
                });
            }
        };

        const renderHistory = () => {
            const history = [
                ...state.data.logs,
                ...state.data.weightHistory.map(d => ({...d, type: 'weight'})),
                ...state.data.heightHistory.map(d => ({...d, type: 'height'})),
                ...state.data.bodyfatHistory.map(d => ({...d, type: 'bodyfat'})),
                ...state.data.muscleHistory.map(d => ({...d, type: 'muscle'}))
            ].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            DOM.history.innerHTML = history.length ? '' : '<div class="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
            
            history.forEach(item => {
                const date = item.timestamp.toDate().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                let html = '', icon = '', color = '';

                if (item.type === 'exercise' || item.type === 'food') {
                    const isEx = item.type === 'exercise';
                    color = isEx ? 'bg-indigo-100 text-indigo-600' : 'bg-green-100 text-green-600';
                    icon = isEx ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>' 
                                : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>';
                    
                    let detail = isEx 
                        ? `<span class="font-semibold text-indigo-600">${CONFIG.EXERCISE_MAP[item.exerciseType]}</span> ${item.km ? item.km+' ‡∏Å‡∏°.' : item.minutes+' ‡∏ô‡∏≤‡∏ó‡∏µ'}`
                        : `<span class="font-semibold text-green-600">${item.kcal} kcal</span>`;

                    html = `
                        <div class="flex-shrink-0 w-12 h-12 rounded-xl ${color} flex items-center justify-center">${icon}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <p class="text-sm text-gray-900">${detail}</p>
                                <span class="text-xs text-gray-400 whitespace-nowrap ml-2">${date}</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate mt-0.5">${item.description || '-'}</p>
                        </div>
                        ${item.imageData ? `<img src="${item.imageData}" class="w-12 h-12 rounded-lg object-cover border border-gray-100">` : ''}
                    `;
                } else {
                    // Stats Update
                    const map = { weight: ['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', 'kg', 'bg-purple-100 text-purple-600'], height: ['‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', 'cm', 'bg-blue-100 text-blue-600'], bodyfat: ['%‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', '%', 'bg-yellow-100 text-yellow-600'], muscle: ['%‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', '%', 'bg-red-100 text-red-600'] };
                    const m = map[item.type];
                    if (m) {
                        html = `
                            <div class="flex-shrink-0 w-10 h-10 rounded-full ${m[2]} flex items-center justify-center text-xs font-bold">${m[0][0]}</div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <p class="text-sm font-medium text-gray-800">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï${m[0]}</p>
                                    <span class="text-xs text-gray-400">${date}</span>
                                </div>
                                <p class="text-lg font-bold text-gray-700 leading-none mt-1">${item.value} <span class="text-xs font-normal text-gray-400">${m[1]}</span></p>
                            </div>
                        `;
                    }
                }

                if (html) {
                    const div = document.createElement('div');
                    div.className = "relative group bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4 hover:shadow-md transition-shadow";
                    div.innerHTML = html + `<button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 text-gray-300 hover:text-red-500" onclick="confirmDel('${item.id}', '${item.type}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                    DOM.history.appendChild(div);
                }
            });
        };

        window.confirmDel = (id, type) => {
            state.deleteId = { id, type };
            toggle(DOM.modal.box, true);
        };

        // --- ACTIONS ---
        const saveProfile = async () => {
            toggle(DOM.popup, true);
            try {
                const ref = doc(state.db, "artifacts", CONFIG.APP_ID, "users", state.liffUid);
                const v = {
                    w: parseFloat(DOM.profile.weight.value), h: parseFloat(DOM.profile.height.value),
                    f: parseFloat(DOM.profile.bodyfat.value), m: parseFloat(DOM.profile.muscle.value)
                };

                await setDoc(ref, { profile: { age: DOM.profile.age.value, gender: DOM.profile.gender.value, updatedAt: serverTimestamp() } }, { merge: true });

                // Change Detection
                const check = (val, hist) => val && (!hist.length || val !== hist.at(-1).value);
                if (check(v.w, state.data.weightHistory)) await addDoc(collection(ref, "weights"), { value: v.w, timestamp: serverTimestamp() });
                if (check(v.h, state.data.heightHistory)) await addDoc(collection(ref, "heights"), { value: v.h, timestamp: serverTimestamp() });
                if (check(v.f, state.data.bodyfatHistory)) await addDoc(collection(ref, "bodyfats"), { value: v.f, timestamp: serverTimestamp() });
                if (check(v.m, state.data.muscleHistory)) await addDoc(collection(ref, "muscles"), { value: v.m, timestamp: serverTimestamp() });

                msg(DOM.profile.msg, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', true);
            } catch (e) { console.error(e); msg(DOM.profile.msg, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', false); }
            toggle(DOM.popup, false);
        };

        const saveLog = async () => {
            if (!state.imgBase64) { msg(DOM.log.msg, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', false); return; }
            toggle(DOM.popup, true);
            try {
                const data = {
                    type: state.logType, description: DOM.log.description.value, imageData: state.imgBase64, timestamp: serverTimestamp(),
                    exerciseType: null, km: 0, minutes: 0, kcal: 0
                };
                if (state.logType === 'exercise') {
                    data.exerciseType = DOM.log.exerciseType.value;
                    if (['running','walking','cycling'].includes(data.exerciseType)) data.km = parseFloat(DOM.log.km.value) || 0;
                    else data.minutes = parseInt(DOM.log.minutes.value) || 0;
                } else {
                    data.kcal = parseInt(DOM.log.kcal.value) || 0;
                }

                await addDoc(collection(state.db, "artifacts", CONFIG.APP_ID, "users", state.liffUid, "logs"), data);
                msg(DOM.log.msg, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
                
                // Reset Form
                DOM.log.description.value = ''; DOM.log.fileInput.value = ''; 
                state.imgBase64 = null; toggle(DOM.log.preview, false); toggle(DOM.log.placeholder, true);
            } catch (e) { console.error(e); msg(DOM.log.msg, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); }
            toggle(DOM.popup, false);
        };

        const deleteItem = async () => {
            if (!state.deleteId) return;
            const { id, type } = state.deleteId;
            const col = type === 'exercise' || type === 'food' ? 'logs' : type + 's'; // weights, heights...
            try {
                await deleteDoc(doc(state.db, "artifacts", CONFIG.APP_ID, "users", state.liffUid, col, id));
            } catch(e) { console.error(e); }
            toggle(DOM.modal.box, false);
        };

        // --- INIT ---
        const init = async () => {
            const app = initializeApp({
                apiKey: "AIzaSyDATchWwmazw3wPnuNk4i-d79rnyBpSDM0",
                authDomain: "line-liff-a543c.firebaseapp.com",
                projectId: "line-liff-a543c",
                storageBucket: "line-liff-a543c.appspot.com",
                messagingSenderId: "617440448369",
                appId: "1:617440448369:web:523f9ce4861c6b656c30d0"
            });
            state.db = getFirestore(app);
            
            // 1. Firebase Auth
            onAuthStateChanged(getAuth(app), async (user) => {
                if (!user) await signInAnonymously(getAuth(app));
                state.uid = user?.uid;

                // 2. LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const p = await liff.getProfile();
                state.liffUid = p.userId;
                DOM.liffName.textContent = p.displayName;
                DOM.liffPic.src = p.pictureUrl;
                toggle(DOM.liffProfile, true); toggle(DOM.liffLoading, false);
                DOM.footer.textContent = `ID: ${state.liffUid}`;

                // 3. Load Data
                const ref = doc(state.db, "artifacts", CONFIG.APP_ID, "users", state.liffUid);
                
                // Listeners
                onSnapshot(ref, s => { if(s.exists()) state.data.profile = s.data().profile || {}; renderProfile(); });
                ['weight','height','bodyfat','muscle'].forEach(k => {
                    onSnapshot(query(collection(ref, k+'s'), orderBy('timestamp','asc')), s => {
                        state.data[k+'History'] = s.docs.map(d => ({id: d.id, ...d.data()}));
                        renderProfile(); if(DOM.history.offsetParent) renderHistory();
                    });
                });
                onSnapshot(query(collection(ref, 'logs'), orderBy('timestamp','desc')), s => {
                    state.data.logs = s.docs.map(d => ({id: d.id, ...d.data()}));
                    if(DOM.history.offsetParent) renderHistory();
                });

                toggle(DOM.loading, false); toggle(DOM.main, true);
            });
        };

        // Events
        DOM.navBtns.forEach(b => b.addEventListener('click', e => {
            DOM.pages.forEach(p => p.classList.remove('active'));
            el(e.target.dataset.page+'-page').classList.add('active');
            DOM.navBtns.forEach(n => { n.classList.remove('active', 'bg-indigo-600', 'text-white'); n.classList.add('text-gray-500'); });
            e.target.classList.add('active'); e.target.classList.remove('text-gray-500');
            
            const p = e.target.dataset.page;
            if(p === 'profile') renderProfile();
            if(p === 'history') renderHistory();
        }));

        DOM.log.typeBtns.forEach(b => b.addEventListener('click', () => {
            state.logType = b.dataset.logType;
            const isEx = state.logType === 'exercise';
            DOM.log.typeBtns.forEach(n => { n.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm'); n.classList.add('text-gray-500'); });
            b.classList.add('bg-white', 'text-indigo-600', 'shadow-sm'); b.classList.remove('text-gray-500');
            
            toggle(DOM.log.typeContainer, isEx); toggle(DOM.log.kcalDiv, !isEx);
            if(isEx) DOM.log.typeSelect.dispatchEvent(new Event('change'));
            else { toggle(DOM.log.kmDiv, false); toggle(DOM.log.minDiv, false); }
        }));

        DOM.log.typeSelect.addEventListener('change', e => {
            const isOther = e.target.value === 'other';
            toggle(DOM.log.kmDiv, !isOther); toggle(DOM.log.minDiv, isOther);
        });

        DOM.log.file.addEventListener('change', async e => {
            if(e.target.files[0]) {
                state.imgBase64 = await resize(e.target.files[0]);
                DOM.log.preview.src = state.imgBase64;
                toggle(DOM.log.preview, true); toggle(DOM.log.placeholder, false);
            }
        });

        DOM.profile.btn.addEventListener('click', saveProfile);
        DOM.log.btn.addEventListener('click', saveLog);
        DOM.modal.cancel.addEventListener('click', () => toggle(DOM.modal.box, false));
        DOM.modal.ok.addEventListener('click', deleteItem);

        init();
    </script>
</body>
</html>
