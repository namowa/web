<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker</title>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="w-full max-w-2xl mx-auto p-4">
        <!-- Loading / Splash Screen -->
        <div id="loadingSection" class="text-center py-20">
            <h1 class="text-3xl font-bold text-slate-800">Health Tracker</h1>
            <p id="loadingStatus" class="text-slate-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...</p>
        </div>

        <!-- Registration Section (Hidden by default) -->
        <div id="registrationSection" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10">
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
                <form id="registrationForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label><input type="text" id="regFirstName" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                        <div><label class="block text-sm font-bold">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="regLastName" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    </div>
                    <div><label class="block text-sm font-bold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="regEmployeeId" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="regHeight" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                        <div><label class="block text-sm font-bold">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input type="number" id="regWeight" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    </div>
                    <button type="submit" id="registerButton" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg hover:bg-blue-700">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>

        <!-- Main App Section (Hidden by default) -->
        <div id="mainAppSection" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 mb-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-slate-800">Health Tracker</h1>
                    <p id="liff-greeting" class="text-slate-500 mt-2"></p>
                </div>

                <!-- Log Type Selector -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <div class="flex gap-4">
                        <label class="flex-1"><input type="radio" name="logType" value="exercise" class="peer hidden" checked><div class="p-3 text-center border rounded-lg cursor-pointer peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">üèÉ‚Äç‚ôÇÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div></label>
                        <label class="flex-1"><input type="radio" name="logType" value="food" class="peer hidden"><div class="p-3 text-center border rounded-lg cursor-pointer peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600">ü•ó ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></label>
                    </div>
                </div>

                <!-- Main Form -->
                <form id="logForm" class="space-y-6">
                    <!-- Exercise Section -->
                    <div id="exerciseSection">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="exerciseType" class="block text-sm font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select id="exerciseType" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg">
                                    <option value="running">‡∏ß‡∏¥‡πà‡∏á</option>
                                    <option value="walking">‡πÄ‡∏î‡∏¥‡∏ô</option>
                                    <option value="cycling">‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô</option>
                                    <option value="other">‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                </select>
                            </div>
                            <!-- Dynamic field for distance/duration -->
                            <div id="distanceField">
                                <label for="distance" class="block text-sm font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</label>
                                <input type="number" step="0.1" id="distance" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg">
                            </div>
                            <div id="durationField" class="hidden">
                                <label for="duration" class="block text-sm font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                <input type="number" id="duration" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    <!-- Food Section -->
                    <div id="foodSection" class="hidden">
                        <label for="foodNotes" class="block text-sm font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô</label>
                        <textarea id="foodNotes" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß, ‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏±‡∏Å" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></textarea>
                    </div>
                    
                    <div><label class="block text-sm font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="logDate" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></div>
                    <div><label class="block text-sm font-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><textarea id="notes" rows="3" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></textarea></div>

                    <div class="flex flex-col sm:flex-row gap-4 pt-2">
                        <button type="submit" id="submitButton" class="w-full sm:w-1/2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="button" id="loadHistoryButton" class="w-full sm:w-1/2 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-6 text-center text-sm font-medium"></div>
            </div>

            <!-- History Data Section -->
            <div id="historySection" class="bg-white rounded-2xl shadow-xl p-6 md:p-10 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <div id="historyLoader" class="text-center p-4 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="p-3 text-left text-xs font-bold uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3 text-left text-xs font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-3 text-left text-xs font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
                <p id="noHistoryMessage" class="text-center text-slate-500 p-6 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
        </div>
        
        <!-- Version Number -->
        <div class="text-center mt-2">
            <p class="text-xs text-slate-400">Version 0.01A</p>
        </div>
    </div>

    <script>
        const LIFF_ID = '1654435774-DazrMVl1';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTOMqYNhFaQsjayr4yG9j0Q1cwOfh33HCaQJVOZeb9Bs9W1xzEVmLqo1kAKTNEFxd2jg/exec';
        
        let userProfile = { userId: null, displayName: null };

        const loadingSection = document.getElementById('loadingSection');
        const loadingStatus = document.getElementById('loadingStatus');
        const registrationSection = document.getElementById('registrationSection');
        const mainAppSection = document.getElementById('mainAppSection');
        const greeting = document.getElementById('liff-greeting');
        const statusMessage = document.getElementById('statusMessage');
        const historySection = document.getElementById('historySection');
        const historyTableBody = document.getElementById('historyTableBody');
        const historyLoader = document.getElementById('historyLoader');
        const noHistoryMessage = document.getElementById('noHistoryMessage');

        document.addEventListener('DOMContentLoaded', initializeLiff);

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    loadingStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Login';
                    return;
                }
                const profile = await liff.getProfile();
                userProfile = { userId: profile.userId, displayName: profile.displayName };
                greeting.innerHTML = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span class="font-bold text-blue-600">${userProfile.displayName}</span>!`;
                
                await checkUserRegistration();
            } catch (error) {
                loadingStatus.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ';
                console.error('LIFF Error:', error);
            }
        }

        async function checkUserRegistration() {
            loadingStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
            const url = `${SCRIPT_URL}?action=checkUser&userId=${userProfile.userId}`;
            try {
                const response = await fetch(url);
                const result = await response.json();
                loadingSection.classList.add('hidden');
                if (result.isRegistered) {
                    mainAppSection.classList.remove('hidden');
                } else {
                    registrationSection.classList.remove('hidden');
                }
            } catch (error) {
                loadingStatus.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                console.error('Check Registration Error:', error);
            }
        }

        // Registration Form Logic
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            button.disabled = true;
            button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const payload = {
                type: 'register',
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                employeeId: document.getElementById('regEmployeeId').value,
                height: document.getElementById('regHeight').value,
                weight: document.getElementById('regWeight').value,
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                registrationSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
                console.error('Registration Submit Error:', error);
            } finally {
                button.disabled = false;
                button.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
            }
        });

        // Main Log Form Logic
        document.querySelectorAll('input[name="logType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isExercise = e.target.value === 'exercise';
                document.getElementById('exerciseSection').classList.toggle('hidden', !isExercise);
                document.getElementById('foodSection').classList.toggle('hidden', isExercise);
            });
        });

        document.getElementById('exerciseType').addEventListener('change', (e) => {
            const type = e.target.value;
            const isDistanceSport = ['running', 'walking', 'cycling'].includes(type);
            document.getElementById('distanceField').classList.toggle('hidden', !isDistanceSport);
            document.getElementById('durationField').classList.toggle('hidden', isDistanceSport);
        });

        document.getElementById('logForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('submitButton');
            button.disabled = true;
            button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            statusMessage.textContent = '';

            const logType = document.querySelector('input[name="logType"]:checked').value;
            const payload = {
                type: 'log',
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                date: document.getElementById('logDate').value,
                logType: logType,
                notes: document.getElementById('notes').value,
            };

            if (logType === 'exercise') {
                const exerciseType = document.getElementById('exerciseType').value;
                payload.exerciseType = exerciseType;
                if (['running', 'walking', 'cycling'].includes(exerciseType)) {
                    payload.distance = document.getElementById('distance').value;
                    payload.duration = '';
                } else {
                    payload.distance = '';
                    payload.duration = document.getElementById('duration').value;
                }
            } else { // food
                payload.notes = document.getElementById('foodNotes').value;
            }

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                statusMessage.innerHTML = `<span class="text-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>`;
                e.target.reset();
            } catch (error) {
                statusMessage.innerHTML = `<span class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>`;
                console.error('Log Submit Error:', error);
            } finally {
                button.disabled = false;
                button.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('logDate').valueAsDate = new Date();
            }
        });
        
        document.getElementById('loadHistoryButton').addEventListener('click', async () => {
            historySection.classList.remove('hidden');
            historyLoader.classList.remove('hidden');
            noHistoryMessage.classList.add('hidden');
            historyTableBody.innerHTML = '';

            const url = `${SCRIPT_URL}?action=getHistory&userId=${userProfile.userId}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length === 0) {
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    data.forEach(row => {
                        let detail = '';
                        if (row.logType === 'exercise') {
                            detail = `${row.exerciseType}: ${row.distance ? row.distance + ' ‡∏Å‡∏°.' : ''}${row.duration ? row.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ' : ''}`;
                        } else {
                            detail = row.notes;
                        }
                        const formattedDate = new Date(row.date).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
                        historyTableBody.innerHTML += `<tr class="border-b">
                            <td class="p-3 text-sm">${formattedDate}</td>
                            <td class="p-3 text-sm font-medium">${row.logType === 'exercise' ? 'üèÉ‚Äç‚ôÇÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢' : 'ü•ó ‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}</td>
                            <td class="p-3 text-sm text-slate-600">${detail}</td>
                        </tr>`;
                    });
                }
            } catch (error) {
                console.error('History Load Error:', error);
            } finally {
                historyLoader.classList.add('hidden');
            }
        });

        // Set default date
        document.getElementById('logDate').valueAsDate = new Date();
    </script>
</body>
</html>
