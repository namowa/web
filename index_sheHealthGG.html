<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="w-full max-w-2xl mx-auto">
        <!-- Loading Screen -->
        <div id="loadingSection" class="text-center py-20 px-4">
            <h1 class="text-3xl font-bold text-slate-800">Health Tracker</h1>
            <p id="loadingStatus" class="text-slate-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...</p>
        </div>

        <!-- Registration Section -->
        <div id="registrationSection" class="hidden fade-in p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10">
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
                <form id="registrationForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label><input type="text" id="regFirstName" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                        <div><label class="block text-sm font-bold">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="regLastName" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    </div>
                    <div><label class="block text-sm font-bold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="regEmployeeId" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="regHeight" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                        <div><label class="block text-sm font-bold">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input type="number" step="0.1" id="regWeight" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg" required></div>
                    </div>
                    <button type="submit" id="registerButton" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg hover:bg-blue-700">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="mainAppSection" class="hidden fade-in">
            <!-- Header -->
            <div class="bg-white rounded-t-2xl shadow-md p-4 text-center">
                 <h1 class="text-2xl font-bold text-slate-800">Health Tracker</h1>
                 <p id="liff-greeting" class="text-slate-500 text-sm mt-1"></p>
                 <p class="text-xs text-slate-400 mt-2">Version 0.1B</p>
            </div>
            <!-- Tab Navigation -->
            <nav class="flex bg-white shadow-md">
                <button data-tab="dashboard" class="tab-btn flex-1 p-4 font-semibold border-b-4 border-transparent">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                <button data-tab="profile" class="tab-btn flex-1 p-4 font-semibold border-b-4 border-transparent">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                <button data-tab="log" class="tab-btn flex-1 p-4 font-semibold border-b-4 border-transparent">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button data-tab="history" class="tab-btn flex-1 p-4 font-semibold border-b-4 border-transparent">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </nav>

            <!-- Tab Panels -->
            <div class="p-1">
                <!-- Dashboard Panel -->
                <div id="dashboard-panel" class="tab-panel bg-white p-6 rounded-b-2xl">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="text-center p-4 border rounded-lg">
                            <h3 class="font-bold text-lg mb-2">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢ (BMI)</h3>
                            <div class="relative w-48 h-24 mx-auto mb-2">
                                <div class="absolute top-0 left-0 w-full h-full border-8 border-slate-200 rounded-t-full border-b-0"></div>
                                <div id="bmiGauge" class="absolute top-0 left-0 w-full h-full border-8 border-transparent rounded-t-full border-b-0 transition-all duration-500" style="--gauge-color: #facc15; clip-path: inset(0 0 0 0); background: conic-gradient(from -90deg, var(--gauge-color) 0deg, var(--gauge-color) 0deg, transparent 0deg);"></div>
                                <div id="bmiNeedle" class="absolute bottom-0 left-1/2 w-1 h-20 bg-slate-700 origin-bottom transition-transform duration-500" style="transform: translateX(-50%) rotate(0deg);"></div>
                            </div>
                            <p id="bmiValue" class="text-2xl font-bold">-</p>
                            <p id="bmiResult" class="text-sm font-semibold">-</p>
                        </div>
                        <div class="p-4 border rounded-lg">
                             <h3 class="font-bold text-lg mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h3>
                             <div id="exerciseStats" class="space-y-2 text-sm">
                                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</p>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Panel -->
                <div id="profile-panel" class="tab-panel bg-white p-6 rounded-b-2xl">
                    <form id="profileForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label><input type="text" id="profileFirstName" class="w-full p-3 mt-1 bg-slate-100 border rounded-lg" readonly></div>
                            <div><label class="block text-sm font-bold">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="profileLastName" class="w-full p-3 mt-1 bg-slate-100 border rounded-lg" readonly></div>
                        </div>
                        <div><label class="block text-sm font-bold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="profileEmployeeId" class="w-full p-3 mt-1 bg-slate-100 border rounded-lg" readonly></div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="profileHeight" class="w-full p-3 mt-1 bg-slate-100 border rounded-lg" readonly></div>
                            <div><label class="block text-sm font-bold">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input type="number" step="0.1" id="profileWeight" class="w-full p-3 mt-1 bg-slate-100 border rounded-lg" readonly></div>
                        </div>
                        <div class="flex gap-4">
                            <button type="button" id="editProfileBtn" class="w-full bg-slate-600 text-white font-bold py-3 rounded-lg hover:bg-slate-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button type="submit" id="saveProfileBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                    <hr class="my-6">
                    <h3 class="font-bold text-lg mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3>
                    <canvas id="weightChart"></canvas>
                </div>

                <!-- Log Panel -->
                <div id="log-panel" class="tab-panel bg-white p-6 rounded-b-2xl">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏£?</label>
                        <div class="flex gap-4">
                            <label class="flex-1"><input type="radio" name="logType" value="exercise" class="peer hidden" checked><div class="p-3 text-center border rounded-lg cursor-pointer peer-checked:bg-blue-600 peer-checked:text-white">üèÉ‚Äç‚ôÇÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div></label>
                            <label class="flex-1"><input type="radio" name="logType" value="food" class="peer hidden"><div class="p-3 text-center border rounded-lg cursor-pointer peer-checked:bg-green-600 peer-checked:text-white">ü•ó ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></label>
                        </div>
                    </div>
                    <form id="logForm" class="space-y-4">
                        <div id="exerciseSection">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="exerciseType" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"><option value="running">‡∏ß‡∏¥‡πà‡∏á</option><option value="walking">‡πÄ‡∏î‡∏¥‡∏ô</option><option value="cycling">‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô</option><option value="other">‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                                <div id="distanceField"><label class="block text-sm font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</label><input type="number" step="0.1" id="distance" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></div>
                                <div id="durationField" class="hidden"><label class="block text-sm font-bold">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" id="duration" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></div>
                            </div>
                        </div>
                        <div id="foodSection" class="hidden"><label class="block text-sm font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô</label><textarea id="foodNotes" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></textarea></div>
                        <div><label class="block text-sm font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="logDate" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></div>
                        <div><label class="block text-sm font-bold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="file" id="imageUpload" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                        <img id="imagePreview" class="hidden max-h-48 rounded-lg mx-auto">
                        <div><label class="block text-sm font-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="notes" rows="3" class="w-full p-3 mt-1 bg-slate-50 border rounded-lg"></textarea></div>
                        <button type="submit" id="submitLogBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                    <div id="logStatusMessage" class="mt-4 text-center text-sm font-medium"></div>
                </div>

                <!-- History Panel -->
                <div id="history-panel" class="tab-panel bg-white p-6 rounded-b-2xl">
                    <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="p-3 text-left text-xs font-bold uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3 text-left text-xs font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-3 text-left text-xs font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
                    <p id="noHistoryMessage" class="text-center text-slate-500 p-6 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const LIFF_ID = '1654435774-DazrMVl1';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwysBNyfmX5Ofk1wV-bsumfgLZsPQiv8LEj0gHmxtPbS2xowO4nv0PlJVkov3-SzuqIMg/exec';
        
        // --- GLOBAL STATE ---
        let userProfile = { userId: null, displayName: null };
        let userAppData = { profile: null, logs: [] };
        let weightChartInstance = null;
        let imageBase64 = null;

        // --- DOM ELEMENTS ---
        const el = {
            loadingSection: document.getElementById('loadingSection'),
            loadingStatus: document.getElementById('loadingStatus'),
            registrationSection: document.getElementById('registrationSection'),
            registrationContainer: document.getElementById('registrationContainer'),
            mainAppSection: document.getElementById('mainAppSection'),
            greeting: document.getElementById('liff-greeting'),
            logStatusMessage: document.getElementById('logStatusMessage'),
            historyTableBody: document.getElementById('historyTableBody'),
            noHistoryMessage: document.getElementById('noHistoryMessage'),
            imagePreview: document.getElementById('imagePreview'),
            tabs: document.querySelectorAll('.tab-btn'),
            panels: document.querySelectorAll('.tab-panel')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    el.loadingStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Login';
                    return;
                }
                const profile = await liff.getProfile();
                userProfile = { userId: profile.userId, displayName: profile.displayName };
                el.greeting.innerHTML = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span class="font-bold text-blue-600">${userProfile.displayName}</span>!`;
                await loadInitialData();
            } catch (error) {
                el.loadingStatus.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ';
                console.error('LIFF Error:', error);
            }
        });

        async function loadInitialData() {
            el.loadingStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...';
            const url = `${SCRIPT_URL}?action=getInitialData&userId=${userProfile.userId}`;
            try {
                const response = await fetch(url);
                const result = await response.json();
                el.loadingSection.classList.add('hidden');
                if (result.error) throw new Error(result.error);
                
                if (result.isRegistered) {
                    userAppData = { profile: result.profile, logs: result.logs };
                    mainAppSection.classList.remove('hidden');
                    setupUI();
                } else {
                    registrationSection.classList.remove('hidden');
                }
            } catch (error) {
                el.loadingStatus.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                console.error('Load Data Error:', error);
            }
        }
        
        function setupUI() {
            setupTabs();
            renderDashboard();
            renderProfile();
            renderHistory();
            setupEventListeners();
            document.getElementById('logDate').valueAsDate = new Date();
        }

        // --- UI & RENDERING ---
        function setupTabs() {
            el.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    el.tabs.forEach(t => t.classList.remove('active'));
                    el.panels.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
                });
            });
            el.tabs[0].click(); // Activate first tab
        }

        function renderDashboard() {
            // BMI Calculation & Gauge
            const { height, weight } = userAppData.profile;
            const bmi = weight / ((height / 100) ** 2);
            const bmiValueEl = document.getElementById('bmiValue');
            const bmiResultEl = document.getElementById('bmiResult');
            const bmiGaugeEl = document.getElementById('bmiGauge');
            const bmiNeedleEl = document.getElementById('bmiNeedle');

            let resultText, color, angle;
            if (bmi < 18.5) { resultText = '‡∏ú‡∏≠‡∏°'; color = '#3b82f6'; angle = 30; } 
            else if (bmi < 24.9) { resultText = '‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô'; color = '#22c55e'; angle = 75; } 
            else if (bmi < 29.9) { resultText = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô'; color = '#facc15'; angle = 120; } 
            else { resultText = '‡∏≠‡πâ‡∏ß‡∏ô'; color = '#ef4444'; angle = 165; }

            bmiValueEl.textContent = isNaN(bmi) ? '-' : bmi.toFixed(2);
            bmiResultEl.textContent = resultText;
            bmiResultEl.style.color = color;
            bmiGaugeEl.style.setProperty('--gauge-color', color);
            bmiGaugeEl.style.background = `conic-gradient(from -90deg, ${color} 0deg, ${color} ${angle}deg, transparent ${angle}deg)`;
            bmiNeedleEl.style.transform = `translateX(-50%) rotate(${angle-90}deg)`;

            // Exercise Stats
            const stats = { running: { count: 0, dist: 0 }, walking: { count: 0, dist: 0 }, cycling: { count: 0, dist: 0 }, other: { count: 0, dur: 0 } };
            userAppData.logs.forEach(log => {
                if (log.logType === 'exercise' && stats[log.exerciseType]) {
                    stats[log.exerciseType].count++;
                    if (log.distance) stats[log.exerciseType].dist += parseFloat(log.distance);
                    if (log.duration) stats[log.exerciseType].dur += parseInt(log.duration);
                }
            });
            document.getElementById('exerciseStats').innerHTML = `
                <p>üèÉ‚Äç‚ôÇÔ∏è ‡∏ß‡∏¥‡πà‡∏á: ${stats.running.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ${stats.running.dist.toFixed(2)} ‡∏Å‡∏°.</p>
                <p>üö∂‚Äç‚ôÇÔ∏è ‡πÄ‡∏î‡∏¥‡∏ô: ${stats.walking.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ${stats.walking.dist.toFixed(2)} ‡∏Å‡∏°.</p>
                <p>üö¥‚Äç‚ôÄÔ∏è ‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô: ${stats.cycling.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ${stats.cycling.dist.toFixed(2)} ‡∏Å‡∏°.</p>
                <p>ü§∏‚Äç‚ôÇÔ∏è ‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${stats.other.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ${stats.other.dur} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
            `;
        }

        function renderProfile() {
            const { firstName, lastName, employeeId, height, weight } = userAppData.profile;
            document.getElementById('profileFirstName').value = firstName;
            document.getElementById('profileLastName').value = lastName;
            document.getElementById('profileEmployeeId').value = employeeId;
            document.getElementById('profileHeight').value = height;
            document.getElementById('profileWeight').value = weight;
            renderWeightChart();
        }

        function renderWeightChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const weightData = userAppData.logs
                .filter(log => log.logType === 'profile update' && log.weight)
                .map(log => ({ x: new Date(log.date), y: log.weight }));
            // Add initial registration weight
            weightData.unshift({ x: new Date(userAppData.profile.timestamp), y: userAppData.profile.weight });
            
            if (weightChartInstance) weightChartInstance.destroy();
            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)',
                        data: weightData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: { scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'll' } } } }
            });
        }
        
        function renderHistory() {
            historyTableBody.innerHTML = '';
            if (userAppData.logs.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                return;
            }
            noHistoryMessage.classList.add('hidden');
            userAppData.logs.forEach(row => {
                let detail = '', icon = '';
                if (row.logType === 'exercise') {
                    icon = 'üèÉ‚Äç‚ôÇÔ∏è';
                    detail = `${row.exerciseType}: ${row.distance ? row.distance + ' ‡∏Å‡∏°.' : ''}${row.duration ? row.duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ' : ''}`;
                } else if (row.logType === 'food') {
                    icon = 'ü•ó';
                    detail = row.notes;
                } else if (row.logType === 'profile update') {
                    icon = 'üë§';
                    detail = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${row.weight} ‡∏Å‡∏Å.)`;
                }
                const formattedDate = new Date(row.date).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
                historyTableBody.innerHTML += `<tr class="border-b"><td class="p-3 text-sm">${formattedDate}</td><td class="p-3 text-sm font-medium">${icon} ${row.logType}</td><td class="p-3 text-sm text-slate-600">${detail}</td></tr>`;
            });
        }
        
        // --- EVENT LISTENERS & LOGIC ---
        function setupEventListeners() {
            // Registration
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            
            // Profile Editing
            const profileForm = document.getElementById('profileForm');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const profileInputs = profileForm.querySelectorAll('input');

            editBtn.addEventListener('click', () => {
                profileInputs.forEach(input => input.readOnly = false);
                profileInputs.forEach(input => input.classList.replace('bg-slate-100', 'bg-slate-50'));
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
            });
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveBtn.disabled = true;
                saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                const payload = {
                    type: 'updateProfile',
                    userId: userProfile.userId,
                    firstName: document.getElementById('profileFirstName').value,
                    lastName: document.getElementById('profileLastName').value,
                    employeeId: document.getElementById('profileEmployeeId').value,
                    height: document.getElementById('profileHeight').value,
                    weight: document.getElementById('profileWeight').value,
                };
                
                try {
                    await postData(payload);
                    await loadInitialData(); // Reload all data
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå');
                } finally {
                    profileInputs.forEach(input => input.readOnly = true);
                    profileInputs.forEach(input => input.classList.replace('bg-slate-50', 'bg-slate-100'));
                    saveBtn.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                }
            });

            // Main Log Form
            document.querySelectorAll('input[name="logType"]').forEach(r => r.addEventListener('change', toggleLogSections));
            document.getElementById('exerciseType').addEventListener('change', toggleExerciseFields);
            document.getElementById('logForm').addEventListener('submit', handleLogSubmit);
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        async function handleRegistration(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            button.disabled = true;
            button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const payload = {
                type: 'register',
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                employeeId: document.getElementById('regEmployeeId').value,
                height: document.getElementById('regHeight').value,
                weight: document.getElementById('regWeight').value,
            };

            try {
                await postData(payload);
                el.registrationContainer.innerHTML = `
                    <div class="text-center p-10">
                        <h2 class="text-2xl font-bold text-green-600">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                        <p class="text-slate-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...</p>
                    </div>`;
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                el.registrationSection.classList.add('hidden');
                await loadInitialData();
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                button.disabled = false;
                button.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
            }
        }
        
        function toggleLogSections(e) {
            const isExercise = e.target.value === 'exercise';
            document.getElementById('exerciseSection').classList.toggle('hidden', !isExercise);
            document.getElementById('foodSection').classList.toggle('hidden', isExercise);
        }
        
        function toggleExerciseFields(e) {
            const isDistanceSport = ['running', 'walking', 'cycling'].includes(e.target.value);
            document.getElementById('distanceField').classList.toggle('hidden', !isDistanceSport);
            document.getElementById('durationField').classList.toggle('hidden', isDistanceSport);
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    el.imagePreview.src = imageBase64;
                    el.imagePreview.classList.remove('hidden');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function handleLogSubmit(e) {
            e.preventDefault();
            const button = document.getElementById('submitLogBtn');
            button.disabled = true;
            button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            el.logStatusMessage.textContent = '';

            const logType = document.querySelector('input[name="logType"]:checked').value;
            const payload = {
                type: 'log',
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                date: document.getElementById('logDate').value,
                logType: logType,
                notes: document.getElementById('notes').value,
                imageBase64: imageBase64
            };

            if (logType === 'exercise') {
                const exerciseType = document.getElementById('exerciseType').value;
                payload.exerciseType = exerciseType;
                payload.distance = ['running', 'walking', 'cycling'].includes(exerciseType) ? document.getElementById('distance').value : '';
                payload.duration = exerciseType === 'other' ? document.getElementById('duration').value : '';
            } else {
                payload.notes = document.getElementById('foodNotes').value;
            }

            try {
                await postData(payload);
                el.logStatusMessage.innerHTML = `<span class="text-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>`;
                e.target.reset();
                el.imagePreview.classList.add('hidden');
                imageBase64 = null;
                await loadInitialData();
            } catch (error) {
                el.logStatusMessage.innerHTML = `<span class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>`;
            } finally {
                button.disabled = false;
                button.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('logDate').valueAsDate = new Date();
            }
        }

        async function postData(payload) {
            return fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }
    </script>
</body>
</html>
