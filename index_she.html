<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡πÉ‡∏à</h1>
            <p class="text-gray-500 mb-6">‡πÅ‡∏≠‡∏õ‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
            <input id="login-userid-input" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="login-button" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
            </button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå -->
    <div id="phone-verification-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h1>
            <p id="verify-welcome-text" class="text-gray-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</p>
            <input id="verify-phone-input" type="tel" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="verify-button" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
            <button id="back-to-login-from-verify-button" class="mt-4 text-sm text-gray-500 hover:text-blue-600">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô -->
    <div id="registration-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
            <p id="register-welcome-text" class="text-gray-500 mb-6">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: </p>
            <input id="register-firstname-input" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <input id="register-lastname-input" type="text" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <input id="register-phone-input" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="register-button" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
            </button>
             <button id="back-to-login-button" class="mt-4 text-sm text-gray-500 hover:text-blue-600">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å) -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡πÉ‡∏à</h1>
                    <p id="welcome-message" class="text-gray-500">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, </p>
                </div>
                 <div class="flex items-center">
                    <div id="points-display" class="bg-yellow-100 border border-yellow-300 text-yellow-800 font-bold px-4 py-2 rounded-full flex items-center mr-4">
                        <!-- Points will be rendered here -->
                    </div>
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
            <nav class="container mx-auto px-4">
                <div class="flex border-b">
                    <button data-page="dashboard" class="nav-button py-3 px-4 font-semibold border-b-2 border-blue-600 text-blue-600">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    <button data-page="rewards" class="nav-button py-3 px-4 font-semibold text-gray-500"><span class="inline-block align-middle mr-1">üéÅ</span> ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                    <button data-page="lottery" class="nav-button py-3 px-4 font-semibold text-gray-500"><span class="inline-block align-middle mr-1">üéüÔ∏è</span> ‡∏™‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏ä‡∏Ñ</button>
                </div>
            </nav>
        </header>

        <main id="main-content" class="container mx-auto p-4 md:p-6">
            <div class="loader"></div>
        </main>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDATchWwmazw3wPnuNk4i-d79rnyBpSDM0",
          authDomain: "line-liff-a543c.firebaseapp.com",
          projectId: "line-liff-a543c",
          storageBucket: "line-liff-a543c.appspot.com",
          messagingSenderId: "617440448369",
          appId: "1:617440448369:web:182dc1785335950c6c30d0"
        };
        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        let state = {
            currentPage: 'dashboard',
            userId: null,
            userData: null,
            activities: [],
            rewards: [],
            lotteryData: null,
            unsubscribers: []
        };

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const registrationScreen = document.getElementById('registration-screen');
        const phoneVerificationScreen = document.getElementById('phone-verification-screen');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        
        const loginButton = document.getElementById('login-button');
        const loginInput = document.getElementById('login-userid-input');
        
        const verifyButton = document.getElementById('verify-button');
        const verifyWelcomeText = document.getElementById('verify-welcome-text');
        const verifyPhoneInput = document.getElementById('verify-phone-input');
        const backToLoginFromVerifyButton = document.getElementById('back-to-login-from-verify-button');

        const registerButton = document.getElementById('register-button');
        const registerWelcomeText = document.getElementById('register-welcome-text');
        const registerFirstnameInput = document.getElementById('register-firstname-input');
        const registerLastnameInput = document.getElementById('register-lastname-input');
        const registerPhoneInput = document.getElementById('register-phone-input');
        const backToLoginButton = document.getElementById('back-to-login-button');

        const navButtons = document.querySelectorAll('.nav-button');
        const logoutButton = document.getElementById('logout-button');

        // --- UI Functions ---
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `text-white py-2 px-4 rounded-lg shadow-lg mb-2 animate-bounce ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function renderHeader() {
            if (!state.userData) return;
            document.getElementById('welcome-message').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${state.userData.name || state.userId}`;
            document.getElementById('points-display').innerHTML = `
                <svg class="w-6 h-6 inline-block mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.25 12.193V6.75a5.25 5.25 0 00-10.5 0v5.443a2.25 2.25 0 01-.88 1.73l-2.12 1.646a.75.75 0 00.58 1.331h14.24a.75.75 0 00.58-1.331l-2.12-1.646a2.25 2.25 0 01-.88-1.73zM16.5 6.75a4.5 4.5 0 00-9 0v4.335a3.75 3.75 0 001.465 2.882l.035.027 2.12 1.646h2.76l2.12-1.646.035-.027a3.75 3.75 0 001.465-2.882V6.75zM5.25 18a.75.75 0 000 1.5h9.5a.75.75 0 000-1.5h-9.5z"></path></svg>
                <span>${state.userData.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>`;
        }
        
        function render() {
            if (!state.userData) {
                mainContent.innerHTML = `<div class="loader"></div>`;
                return;
            }
            renderHeader();
            switch (state.currentPage) {
                case 'dashboard': renderDashboard(); break;
                case 'rewards': renderRewards(); break;
                case 'lottery': renderLottery(); break;
            }
        }
        
        function renderDashboard() {
             const userStamps = state.userData.stamps || [];
            const stampCardHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå</h2>
                    <div class="grid grid-cols-4 sm:grid-cols-8 gap-4">
                        ${state.activities.map(act => {
                            const completed = userStamps.includes(act.id);
                            return `
                                <div class="flex flex-col items-center text-center">
                                    <svg class="w-16 h-16 transition-all duration-500 ${completed ? 'text-green-500 transform scale-110' : 'text-gray-300'}" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z" />
                                    </svg>
                                    <span class="mt-2 text-sm font-medium ${completed ? 'text-gray-700' : 'text-gray-400'}">${act.stampIcon} ${act.name}</span>
                                </div>`;
                        }).join('')}
                    </div>
                    ${userStamps.length === state.activities.length ? `<div class="mt-4 text-center p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-700 rounded-r-lg"><p class="font-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏î‡∏ß‡∏á‡πÅ‡∏•‡πâ‡∏ß!</p></div>` : ''}
                </div>`;

            const activityListHTML = `
                <div class="mt-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                    <div class="space-y-4">
                        ${state.activities.map(act => `
                            <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                                <div>
                                    <p class="text-lg font-semibold text-gray-800">${act.stampIcon} ${act.name}</p>
                                    <p class="text-sm text-gray-500">${act.description}</p>
                                    <p class="text-sm font-bold text-green-600">+${act.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                                </div>
                                <button data-activity-id="${act.id}" class="join-activity-btn px-4 py-2 rounded-lg font-semibold text-white transition-colors ${userStamps.includes(act.id) ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" ${userStamps.includes(act.id) ? 'disabled' : ''}>
                                    ${userStamps.includes(act.id) ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'}
                                </button>
                            </div>`).join('')}
                    </div>
                </div>`;
            mainContent.innerHTML = stampCardHTML + activityListHTML;
        }
        
        function renderRewards() {
             mainContent.innerHTML = `
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.rewards.map(reward => `
                            <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                                <img src="${reward.img}" alt="${reward.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/ffffff?text=Image+Not+Found';">
                                <div class="p-4 flex flex-col flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-800">${reward.name}</h3>
                                    <p class="text-sm text-gray-500 mb-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${reward.stock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                                    <div class="flex-grow"></div>
                                    <div class="flex items-center justify-between mt-4">
                                        <span class="text-xl font-bold text-yellow-500">${reward.cost} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                                        <button data-reward-id="${reward.id}" class="redeem-reward-btn bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" ${state.userData.points < reward.cost || reward.stock <= 0 ? 'disabled' : ''}>
                                            ‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                                        </button>
                                    </div>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`;
        }

        function renderLottery() {
            const lottery = state.lotteryData;
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">‡∏™‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏ä‡∏Ñ</h2>
                    <p class="text-gray-600 mb-4">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏ç‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô!</p>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg mb-6">
                        <p class="font-bold">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${lottery?.prize || '...'}</p>
                    </div>
                    <p class="text-lg mb-4">‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="font-bold text-yellow-500">${lottery?.ticketCost || 0}</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏ö</p>
                    <button id="buy-ticket-btn" class="w-full max-w-xs mx-auto bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400 transition-colors text-lg" ${!lottery || state.userData.points < lottery.ticketCost ? 'disabled' : ''}>
                        ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏•‡∏≤‡∏Å
                    </button>
                    <p class="text-sm text-gray-500 mt-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏•‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${lottery?.entries?.length || 0} ‡πÉ‡∏ö</p>
                </div>`;
        }

        // --- Auth & Firestore Functions ---
        async function handleLogin() {
            const id = loginInput.value.trim();
            if (!id) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const userSnap = await getDoc(userRef);

            state.userId = id; // Store the ID

            if (userSnap.exists()) {
                // User exists, show phone verification screen
                verifyWelcomeText.innerHTML = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span class="font-bold">${id}</span>`;
                loginScreen.classList.add('hidden');
                phoneVerificationScreen.classList.remove('hidden');
            } else {
                // User does not exist, show registration screen
                registerWelcomeText.innerHTML = `‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span class="font-bold">${id}</span>`;
                loginScreen.classList.add('hidden');
                registrationScreen.classList.remove('hidden');
            }
        }

        async function handlePhoneVerification() {
            const phone = verifyPhoneInput.value.trim();
            const id = state.userId;

            if (!phone) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists() && userSnap.data().phone === phone) {
                loginSuccess(id);
            } else {
                showToast("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", true);
            }
        }

        async function handleRegistration() {
            const firstname = registerFirstnameInput.value.trim();
            const lastname = registerLastnameInput.value.trim();
            const phone = registerPhoneInput.value.trim();
            const id = state.userId; 

            if (!firstname || !lastname || !phone) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const newUser = {
                id: id,
                name: `${firstname} ${lastname}`,
                phone: phone,
                points: 0,
                stamps: [],
                redeemedRewards: []
            };

            await setDoc(userRef, newUser);
            showToast("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            loginSuccess(id);
        }

        function loginSuccess(userId) {
            state.userId = userId;
            loginScreen.classList.add('hidden');
            registrationScreen.classList.add('hidden');
            phoneVerificationScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            attachListeners();
        }

        function handleLogout() {
            state.unsubscribers.forEach(unsub => unsub());
            state.unsubscribers = [];
            
            state.userId = null;
            state.userData = null;

            appContainer.classList.add('hidden');
            registrationScreen.classList.add('hidden');
            phoneVerificationScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginInput.value = '';
            verifyPhoneInput.value = '';
        }

        async function handleJoinActivity(activityId) {
            const activity = state.activities.find(a => a.id === activityId);
            if (!activity) return;

            const userRef = doc(db, 'users', state.userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || (userDoc.data().stamps && userDoc.data().stamps.includes(activityId))) return;
                    
                    const newPoints = (userDoc.data().points || 0) + activity.points;
                    const newStamps = [...(userDoc.data().stamps || []), activityId];
                    transaction.update(userRef, { points: newPoints, stamps: newStamps });
                });
                showToast(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° "${activity.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            } catch (e) {
                console.error("Join Activity Transaction failed: ", e);
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", true);
            }
        }

        async function handleRedeemReward(rewardId) {
            const reward = state.rewards.find(r => r.id === rewardId);
            if (!reward) return;

            const userRef = doc(db, 'users', state.userId);
            const rewardRef = doc(db, 'rewards', rewardId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const rewardDoc = await transaction.get(rewardRef);
                    if (!userDoc.exists() || !rewardDoc.exists()) throw "Document does not exist!";
                    
                    if (userDoc.data().points < reward.cost) throw "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠";
                    if (rewardDoc.data().stock <= 0) throw "‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß";

                    transaction.update(userRef, { points: userDoc.data().points - reward.cost });
                    transaction.update(rewardRef, { stock: rewardDoc.data().stock - 1 });
                });
                showToast(`‡πÅ‡∏•‡∏Å "${reward.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            } catch (e) {
                showToast(typeof e === 'string' ? e : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å", true);
                console.error("Redeem Reward Transaction failed: ", e);
            }
        }

        async function handleBuyTicket() {
            const userRef = doc(db, 'users', state.userId);
            const lotteryRef = doc(db, 'lottery', 'current');
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const lotteryDoc = await transaction.get(lotteryRef);
                    if (!userDoc.exists() || !lotteryDoc.exists()) throw "Document does not exist!";
                    
                    if (userDoc.data().points < state.lotteryData.ticketCost) throw "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠";
                    
                    const newEntries = [...(lotteryDoc.data().entries || []), state.userId];
                    transaction.update(userRef, { points: userDoc.data().points - state.lotteryData.ticketCost });
                    transaction.update(lotteryRef, { entries: newEntries });
                });
                showToast("‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏ä‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (e) {
                showToast(typeof e === 'string' ? e : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", true);
                console.error("Buy Ticket Transaction failed: ", e);
            }
        }
        
        // --- Event Listeners Setup ---
        function attachListeners() {
            state.unsubscribers.forEach(unsub => unsub());
            state.unsubscribers = [];

            const unsubUser = onSnapshot(doc(db, "users", state.userId), (doc) => {
                state.userData = doc.data();
                render();
            });
            const unsubActivities = onSnapshot(collection(db, "activities"), (snapshot) => {
                state.activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            const unsubRewards = onSnapshot(collection(db, "rewards"), (snapshot) => {
                state.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            const unsubLottery = onSnapshot(doc(db, "lottery", "current"), (doc) => {
                state.lotteryData = doc.data();
                render();
            });
            
            state.unsubscribers.push(unsubUser, unsubActivities, unsubRewards, unsubLottery);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loginButton.addEventListener('click', handleLogin);
            registerButton.addEventListener('click', handleRegistration);
            verifyButton.addEventListener('click', handlePhoneVerification);

            const goBack = () => {
                registrationScreen.classList.add('hidden');
                phoneVerificationScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loginInput.value = '';
                state.userId = null;
            };
            backToLoginButton.addEventListener('click', goBack);
            backToLoginFromVerifyButton.addEventListener('click', goBack);
            
            logoutButton.addEventListener('click', handleLogout);
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.currentPage = e.currentTarget.dataset.page;
                    navButtons.forEach(b => {
                        b.classList.remove('border-blue-600', 'text-blue-600');
                        b.classList.add('text-gray-500');
                    });
                    e.currentTarget.classList.add('border-blue-600', 'text-blue-600');
                    render();
                });
            });

            mainContent.addEventListener('click', (e) => {
                if (e.target.closest('.join-activity-btn')) {
                    handleJoinActivity(e.target.closest('.join-activity-btn').dataset.activityId);
                }
                if (e.target.closest('.redeem-reward-btn')) {
                    handleRedeemReward(e.target.closest('.redeem-reward-btn').dataset.rewardId);
                }
                if (e.target.closest('#buy-ticket-btn')) {
                    handleBuyTicket();
                }
            });
        });
    </script>
</body>
</html>
