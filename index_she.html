<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHE Month - สะสมแต้ม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- หน้าจอ Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">SHE Month - เดือนแห่งความปลอดภัย</h1>
            <p class="text-gray-500 mb-6">แอปสะสมแต้มและของรางวัล</p>
            <input id="login-userid-input" type="text" placeholder="กรอกรหัสพนักงานของคุณ" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="login-button" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                ต่อไป
            </button>
        </div>
    </div>

    <!-- หน้าจอยืนยันเบอร์โทรศัพท์ -->
    <div id="phone-verification-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">ยืนยันตัวตน</h1>
            <p id="verify-welcome-text" class="text-gray-500 mb-6">กรุณากรอกเบอร์โทรศัพท์เพื่อยืนยันรหัสพนักงาน:</p>
            <input id="verify-phone-input" type="tel" placeholder="กรอกเบอร์โทรศัพท์" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="verify-button" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                ยืนยัน
            </button>
            <button id="back-to-login-from-verify-button" class="mt-4 text-sm text-gray-500 hover:text-blue-600">กลับไปหน้าเข้าสู่ระบบ</button>
        </div>
    </div>

    <!-- หน้าจอลงทะเบียน -->
    <div id="registration-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">ลงทะเบียน</h1>
            <p id="register-welcome-text" class="text-gray-500 mb-6">กรอกข้อมูลสำหรับรหัสพนักงาน: </p>
            <input id="register-firstname-input" type="text" placeholder="ชื่อจริง" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <input id="register-lastname-input" type="text" placeholder="นามสกุล" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <input id="register-phone-input" type="tel" placeholder="เบอร์โทรศัพท์" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="register-button" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                ยืนยันการลงทะเบียน
            </button>
             <button id="back-to-login-button" class="mt-4 text-sm text-gray-500 hover:text-blue-600">กลับไปหน้าเข้าสู่ระบบ</button>
        </div>
    </div>

    <!-- ส่วนหลักของแอป (ซ่อนไว้ตอนแรก) -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">SHE Month - เดือนแห่งความปลอดภัย</h1>
                    <p id="welcome-message" class="text-gray-500">ยินดีต้อนรับ, </p>
                </div>
                 <div class="flex items-center">
                    <div id="points-display" class="bg-yellow-100 border border-yellow-300 text-yellow-800 font-bold px-4 py-2 rounded-full flex items-center mr-4">
                        <!-- Points will be rendered here -->
                    </div>
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600">ออกจากระบบ</button>
                </div>
            </div>
            <nav class="container mx-auto px-4">
                <div id="nav-buttons-container" class="flex border-b overflow-x-auto">
                    <!-- Nav buttons will be inserted here by JS -->
                </div>
            </nav>
        </header>

        <main id="main-content" class="container mx-auto p-4 md:p-6">
            <div class="loader"></div>
        </main>
    </div>

    <!-- ส่วนแสดงข้อความแจ้งเตือน -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDATchWwmazw3wPnuNk4i-d79rnyBpSDM0",
          authDomain: "line-liff-a543c.firebaseapp.com",
          projectId: "line-liff-a543c",
          storageBucket: "line-liff-a543c.appspot.com",
          messagingSenderId: "617440448369",
          appId: "1:617440448369:web:182dc1785335950c6c30d0"
        };
        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        let state = {
            currentPage: 'dashboard',
            userId: null,
            isAdmin: false,
            userData: null,
            activities: [],
            rewards: [],
            numberedLotteryData: {}, // Store as an object for quick lookup
            unsubscribers: []
        };

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const registrationScreen = document.getElementById('registration-screen');
        const phoneVerificationScreen = document.getElementById('phone-verification-screen');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const navButtonsContainer = document.getElementById('nav-buttons-container');
        
        const loginButton = document.getElementById('login-button');
        const loginInput = document.getElementById('login-userid-input');
        
        const verifyButton = document.getElementById('verify-button');
        const verifyWelcomeText = document.getElementById('verify-welcome-text');
        const verifyPhoneInput = document.getElementById('verify-phone-input');
        const backToLoginFromVerifyButton = document.getElementById('back-to-login-from-verify-button');

        const registerButton = document.getElementById('register-button');
        const registerWelcomeText = document.getElementById('register-welcome-text');
        const registerFirstnameInput = document.getElementById('register-firstname-input');
        const registerLastnameInput = document.getElementById('register-lastname-input');
        const registerPhoneInput = document.getElementById('register-phone-input');
        const backToLoginButton = document.getElementById('back-to-login-button');

        const logoutButton = document.getElementById('logout-button');

        // --- UI Functions ---
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `text-white py-2 px-4 rounded-lg shadow-lg mb-2 animate-bounce ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function renderHeader() {
            const welcomeMessage = document.getElementById('welcome-message');
            const pointsDisplay = document.getElementById('points-display');
            if (state.isAdmin) {
                welcomeMessage.textContent = `ยินดีต้อนรับ, ผู้ดูแลระบบ`;
                pointsDisplay.classList.add('hidden');
            } else if (state.userData) {
                pointsDisplay.classList.remove('hidden');
                welcomeMessage.textContent = `ยินดีต้อนรับ, ${state.userData.name || state.userId}`;
                pointsDisplay.innerHTML = `
                    <svg class="w-6 h-6 inline-block mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.25 12.193V6.75a5.25 5.25 0 00-10.5 0v5.443a2.25 2.25 0 01-.88 1.73l-2.12 1.646a.75.75 0 00.58 1.331h14.24a.75.75 0 00.58-1.331l-2.12-1.646a2.25 2.25 0 01-.88-1.73zM16.5 6.75a4.5 4.5 0 00-9 0v4.335a3.75 3.75 0 001.465 2.882l.035.027 2.12 1.646h2.76l2.12-1.646.035-.027a3.75 3.75 0 001.465-2.882V6.75zM5.25 18a.75.75 0 000 1.5h9.5a.75.75 0 000-1.5h-9.5z"></path></svg>
                    <span>${state.userData.points} คะแนน</span>`;
            }
        }
        
        function render() {
            if (!state.isAdmin && !state.userData) {
                mainContent.innerHTML = `<div class="loader"></div>`;
                return;
            }
            renderHeader();
            switch (state.currentPage) {
                case 'dashboard': renderDashboard(); break;
                case 'rewards': renderRewards(); break;
                case 'numberedLottery': renderNumberedLottery(); break;
                case 'admin': renderAdminPanel(); break;
            }
        }
        
        // --- User Pages Rendering ---
        function renderDashboard() {
             const userStamps = state.userData.stamps || [];
            const stampCardHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">บัตรสะสมแสตมป์</h2>
                    <div class="grid grid-cols-4 sm:grid-cols-8 gap-4">
                        ${state.activities.map(act => {
                            const completed = userStamps.includes(act.id);
                            return `
                                <div class="flex flex-col items-center text-center">
                                    <svg class="w-16 h-16 transition-all duration-500 ${completed ? 'text-green-500 transform scale-110' : 'text-gray-300'}" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z" />
                                    </svg>
                                    <span class="mt-2 text-sm font-medium ${completed ? 'text-gray-700' : 'text-gray-400'}">${act.stampIcon} ${act.name}</span>
                                </div>`;
                        }).join('')}
                    </div>
                    ${userStamps.length === state.activities.length ? `<div class="mt-4 text-center p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-700 rounded-r-lg"><p class="font-bold">ยินดีด้วย! คุณสะสมแสตมป์ครบทุกดวงแล้ว!</p></div>` : ''}
                </div>`;

            const activityListHTML = `
                <div class="mt-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">กิจกรรมประจำเดือน</h2>
                    <div class="space-y-4">
                        ${state.activities.map(act => `
                            <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                                <div>
                                    <p class="text-lg font-semibold text-gray-800">${act.stampIcon} ${act.name}</p>
                                    <p class="text-sm text-gray-500">${act.description}</p>
                                    <p class="text-sm font-bold text-green-600">+${act.points} คะแนน</p>
                                </div>
                                <button data-activity-id="${act.id}" class="join-activity-btn px-4 py-2 rounded-lg font-semibold text-white transition-colors ${userStamps.includes(act.id) ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" ${userStamps.includes(act.id) ? 'disabled' : ''}>
                                    ${userStamps.includes(act.id) ? 'เข้าร่วมแล้ว' : 'เข้าร่วม'}
                                </button>
                            </div>`).join('')}
                    </div>
                </div>`;
            mainContent.innerHTML = stampCardHTML + activityListHTML;
        }
        
        function renderRewards() {
            const rewardsGridHTML = `
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ร้านค้าแลกของรางวัล</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.rewards.map(reward => `
                            <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
                                <img src="${reward.img}" alt="${reward.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/ffffff?text=Image+Not+Found';">
                                <div class="p-4 flex flex-col flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-800">${reward.name}</h3>
                                    <p class="text-sm text-gray-500 mb-2">คงเหลือ: ${reward.stock} ชิ้น</p>
                                    <div class="flex-grow"></div>
                                    <div class="flex items-center justify-between mt-4">
                                        <span class="text-xl font-bold text-yellow-500">${reward.cost} คะแนน</span>
                                        <button data-reward-id="${reward.id}" class="redeem-reward-btn bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" ${state.userData.points < reward.cost || reward.stock <= 0 ? 'disabled' : ''}>
                                            แลกรางวัล
                                        </button>
                                    </div>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`;

            const redeemedHistory = state.userData.redeemedRewards || [];
            redeemedHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            const historyHTML = `
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700 border-t pt-6">ประวัติการแลกของรางวัล</h3>
                    ${redeemedHistory.length > 0 ? `
                        <div class="space-y-3 bg-white p-4 rounded-xl shadow-md">
                            ${redeemedHistory.map(item => `
                                <div class="flex justify-between items-center border-b pb-2 last:border-b-0">
                                    <div>
                                        <p class="font-semibold text-gray-800">${item.name}</p>
                                        <p class="text-sm text-gray-500">วันที่: ${new Date(item.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })} น.</p>
                                    </div>
                                    <span class="font-bold text-yellow-600">-${item.cost} คะแนน</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <p class="text-gray-500 text-center mt-4">ยังไม่มีประวัติการแลกของรางวัล</p>
                    `}
                </div>
            `;
            mainContent.innerHTML = rewardsGridHTML + historyHTML;
        }

        function renderNumberedLottery() {
            const NUMBERED_LOTTERY_COST = 20;
            const ticketsOwned = Object.values(state.numberedLotteryData).filter(ticket => ticket.ownerId === state.userId).length;
            const canBuyMore = ticketsOwned < 5;
            const hasEnoughPoints = state.userData.points >= NUMBERED_LOTTERY_COST;

            let numbersHTML = '';
            for (let i = 0; i < 1000; i++) {
                const numberStr = String(i).padStart(3, '0');
                const ticketData = state.numberedLotteryData[numberStr];
                
                if (ticketData && ticketData.isSold) {
                    numbersHTML += `
                        <div class="p-2 text-center rounded-lg bg-gray-200 text-gray-500">
                            <p class="font-bold text-lg">${numberStr}</p>
                            <p class="text-xs font-mono">SOLD</p>
                            <p class="text-xs font-mono truncate">${ticketData.ownerId}</p>
                        </div>
                    `;
                } else {
                    const isDisabled = !canBuyMore || !hasEnoughPoints;
                    numbersHTML += `
                        <button data-number="${numberStr}" class="buy-numbered-ticket-btn p-2 text-center rounded-lg bg-green-100 text-green-800 hover:bg-green-200 transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isDisabled ? 'disabled' : ''}>
                            <p class="font-bold text-lg">${numberStr}</p>
                            <p class="text-xs">ว่าง</p>
                        </button>
                    `;
                }
            }

            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold mb-2 text-gray-800">สลากเรียงเบอร์</h2>
                        <p class="text-gray-600">เลือกซื้อเบอร์ที่คุณต้องการ (ใช้ ${NUMBERED_LOTTERY_COST} คะแนนต่อใบ, ซื้อได้สูงสุด 5 ใบ)</p>
                        <p class="mt-2 font-semibold text-blue-600">คุณซื้อไปแล้ว: ${ticketsOwned} / 5 ใบ</p>
                    </div>
                    <div class="grid grid-cols-5 sm:grid-cols-10 gap-2 max-h-96 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        ${numbersHTML}
                    </div>
                </div>
            `;
        }
        
        // --- Admin Panel Rendering ---
        function renderAdminPanel() {
            mainContent.innerHTML = `
                <div class="space-y-8">
                    <div id="admin-activities-section" class="bg-white p-6 rounded-xl shadow-md"></div>
                    <div id="admin-rewards-section" class="bg-white p-6 rounded-xl shadow-md"></div>
                </div>
            `;
            renderAdminActivities();
            renderAdminRewards();
        }

        function renderAdminActivities() {
            const section = document.getElementById('admin-activities-section');
            section.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800">จัดการกิจกรรม</h2>
                <div class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                    ${state.activities.map(act => `
                        <div class="flex items-center justify-between p-2 border rounded-lg">
                            <span class="truncate">${act.id}: ${act.name} (+${act.points})</span>
                            <div>
                                <button data-id="${act.id}" class="edit-activity-btn text-blue-500 hover:text-blue-700 mr-2">แก้ไข</button>
                                <button data-id="${act.id}" class="delete-activity-btn text-red-500 hover:text-red-700">ลบ</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <form id="activity-form" class="space-y-3 border-t pt-4">
                    <h3 class="font-semibold text-lg">เพิ่ม / แก้ไขกิจกรรม</h3>
                    <input type="text" id="activity-id" placeholder="ID (e.g., act09)" class="w-full p-2 border rounded" required>
                    <input type="text" id="activity-name" placeholder="ชื่อกิจกรรม" class="w-full p-2 border rounded" required>
                    <input type="text" id="activity-description" placeholder="คำอธิบาย" class="w-full p-2 border rounded" required>
                    <input type="number" id="activity-points" placeholder="คะแนน" class="w-full p-2 border rounded" required>
                    <input type="text" id="activity-icon" placeholder="ไอคอน (Emoji)" class="w-full p-2 border rounded" required>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">บันทึกกิจกรรม</button>
                    <button type="button" id="clear-activity-form" class="w-full bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400 mt-2">ล้างฟอร์ม</button>
                </form>
            `;
        }

        function renderAdminRewards() {
            const section = document.getElementById('admin-rewards-section');
            section.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800">จัดการของรางวัล</h2>
                <div class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                    ${state.rewards.map(rew => `
                        <div class="flex items-center justify-between p-2 border rounded-lg">
                            <span class="truncate">${rew.id}: ${rew.name} (${rew.cost} คะแนน)</span>
                            <div>
                                <button data-id="${rew.id}" class="edit-reward-btn text-blue-500 hover:text-blue-700 mr-2">แก้ไข</button>
                                <button data-id="${rew.id}" class="delete-reward-btn text-red-500 hover:text-red-700">ลบ</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <form id="reward-form" class="space-y-3 border-t pt-4">
                    <h3 class="font-semibold text-lg">เพิ่ม / แก้ไขของรางวัล</h3>
                    <input type="text" id="reward-id" placeholder="ID (e.g., rew05)" class="w-full p-2 border rounded" required>
                    <input type="text" id="reward-name" placeholder="ชื่อของรางวัล" class="w-full p-2 border rounded" required>
                    <input type="number" id="reward-cost" placeholder="คะแนนที่ใช้แลก" class="w-full p-2 border rounded" required>
                    <input type="number" id="reward-stock" placeholder="จำนวนคงเหลือ" class="w-full p-2 border rounded" required>
                    <input type="text" id="reward-img" placeholder="URL รูปภาพ" class="w-full p-2 border rounded" required>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">บันทึกของรางวัล</button>
                    <button type="button" id="clear-reward-form" class="w-full bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400 mt-2">ล้างฟอร์ม</button>
                </form>
            `;
        }

        // --- Auth & Firestore Functions ---
        async function handleLogin() {
            const id = loginInput.value.trim();
            if (!id) {
                showToast("กรุณากรอกรหัสพนักงาน", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const userSnap = await getDoc(userRef);

            state.userId = id; 

            if (userSnap.exists()) {
                const isAdmin = id.toLowerCase() === 'admin';
                verifyWelcomeText.innerHTML = `กรุณากรอกเบอร์โทรศัพท์เพื่อยืนยันรหัส${isAdmin ? 'ผู้ดูแลระบบ' : 'พนักงาน'}: <span class="font-bold">${id}</span>`;
                loginScreen.classList.add('hidden');
                phoneVerificationScreen.classList.remove('hidden');
            } else {
                registerWelcomeText.innerHTML = `กรอกข้อมูลสำหรับรหัสพนักงาน: <span class="font-bold">${id}</span>`;
                loginScreen.classList.add('hidden');
                registrationScreen.classList.remove('hidden');
            }
        }

        async function handlePhoneVerification() {
            const phone = verifyPhoneInput.value.trim();
            const id = state.userId;

            if (!phone) {
                showToast("กรุณากรอกเบอร์โทรศัพท์", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists() && userSnap.data().phone === phone) {
                const isAdmin = id.toLowerCase() === 'admin';
                loginSuccess(id, isAdmin);
            } else {
                showToast("เบอร์โทรศัพท์ไม่ถูกต้อง", true);
            }
        }

        async function handleRegistration() {
            const firstname = registerFirstnameInput.value.trim();
            const lastname = registerLastnameInput.value.trim();
            const phone = registerPhoneInput.value.trim();
            const id = state.userId; 

            if (!firstname || !lastname || !phone) {
                showToast("กรุณากรอกข้อมูลให้ครบทุกช่อง", true);
                return;
            }

            const userRef = doc(db, 'users', id);
            const newUser = {
                id: id,
                name: `${firstname} ${lastname}`,
                phone: phone,
                points: 0,
                stamps: [],
                redeemedRewards: []
            };

            await setDoc(userRef, newUser);
            showToast("ลงทะเบียนสำเร็จ!");
            loginSuccess(id);
        }

        function loginSuccess(userId, isAdmin = false) {
            state.userId = userId;
            state.isAdmin = isAdmin;
            
            loginScreen.classList.add('hidden');
            registrationScreen.classList.add('hidden');
            phoneVerificationScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            setupNav();
            attachListeners();
        }

        function handleLogout() {
            state.unsubscribers.forEach(unsub => unsub());
            state = { currentPage: 'dashboard', userId: null, isAdmin: false, userData: null, activities: [], rewards: [], numberedLotteryData: {}, unsubscribers: [] };

            appContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginInput.value = '';
            verifyPhoneInput.value = '';
        }

        async function handleJoinActivity(activityId) {
            const activity = state.activities.find(a => a.id === activityId);
            if (!activity) return;
            
            const userRef = doc(db, 'users', state.userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || (userDoc.data().stamps && userDoc.data().stamps.includes(activityId))) return;
                    
                    const newPoints = (userDoc.data().points || 0) + activity.points;
                    const newStamps = [...(userDoc.data().stamps || []), activityId];
                    transaction.update(userRef, { points: newPoints, stamps: newStamps });
                });
                showToast(`เข้าร่วม "${activity.name}" สำเร็จ!`);
            } catch (e) {
                console.error("Join Activity Transaction failed: ", e);
                showToast("เกิดข้อผิดพลาด กรุณาลองใหม่", true);
            }
        }

        async function handleRedeemReward(rewardId) {
            const reward = state.rewards.find(r => r.id === rewardId);
            if (!reward) return;

            const userRef = doc(db, 'users', state.userId);
            const rewardRef = doc(db, 'rewards', rewardId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const rewardDoc = await transaction.get(rewardRef);
                    if (!userDoc.exists() || !rewardDoc.exists()) throw "Document does not exist!";
                    
                    if (userDoc.data().points < reward.cost) throw "คะแนนไม่เพียงพอ";
                    if (rewardDoc.data().stock <= 0) throw "ของรางวัลหมดแล้ว";
                    
                    const newRedeemedList = [
                        ...(userDoc.data().redeemedRewards || []),
                        {
                            name: reward.name,
                            cost: reward.cost,
                            date: new Date().toISOString()
                        }
                    ];

                    transaction.update(userRef, { 
                        points: userDoc.data().points - reward.cost,
                        redeemedRewards: newRedeemedList
                    });
                    transaction.update(rewardRef, { stock: rewardDoc.data().stock - 1 });
                });
                showToast(`แลก "${reward.name}" สำเร็จ!`);
            } catch (e) {
                showToast(typeof e === 'string' ? e : "เกิดข้อผิดพลาดในการแลก", true);
                console.error("Redeem Reward Transaction failed: ", e);
            }
        }
        
        async function handleBuyNumberedTicket(numberStr) {
            const NUMBERED_LOTTERY_COST = 20;

            if (state.userData.points < NUMBERED_LOTTERY_COST) {
                showToast(`คุณต้องมี ${NUMBERED_LOTTERY_COST} คะแนนเพื่อซื้อสลาก`, true);
                return;
            }

            const ticketsOwned = Object.values(state.numberedLotteryData).filter(ticket => ticket.ownerId === state.userId).length;
            if (ticketsOwned >= 5) {
                showToast("คุณซื้อสลากครบ 5 ใบแล้ว", true);
                return;
            }

            const ticketRef = doc(db, 'numberedLottery', numberStr);
            const userRef = doc(db, 'users', state.userId);

            try {
                await runTransaction(db, async (transaction) => {
                    const ticketDoc = await transaction.get(ticketRef);
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists()) {
                        throw "ไม่พบข้อมูลผู้ใช้";
                    }
                    if (ticketDoc.exists() && ticketDoc.data().isSold) {
                        throw "เบอร์นี้ถูกซื้อไปแล้ว";
                    }
                    if (userDoc.data().points < NUMBERED_LOTTERY_COST) {
                        throw "คะแนนไม่เพียงพอ";
                    }

                    const newPoints = userDoc.data().points - NUMBERED_LOTTERY_COST;
                    transaction.update(userRef, { points: newPoints });

                    transaction.set(ticketRef, {
                        isSold: true,
                        ownerId: state.userId,
                        ownerName: state.userData.name,
                        purchaseDate: new Date().toISOString()
                    });
                });
                showToast(`ซื้อเบอร์ ${numberStr} สำเร็จ!`);
            } catch (e) {
                showToast(typeof e === 'string' ? e : "เกิดข้อผิดพลาด กรุณาลองใหม่", true);
                console.error("Buy Numbered Ticket Transaction failed: ", e);
            }
        }

        // --- Admin Action Handlers ---
        async function handleActivitySave(e) {
            e.preventDefault();
            const id = document.getElementById('activity-id').value.trim();
            if (!id) { showToast("กรุณากรอก Activity ID", true); return; }
            const activityData = {
                id: id,
                name: document.getElementById('activity-name').value.trim(),
                description: document.getElementById('activity-description').value.trim(),
                points: Number(document.getElementById('activity-points').value),
                stampIcon: document.getElementById('activity-icon').value.trim()
            };
            await setDoc(doc(db, "activities", id), activityData);
            showToast("บันทึกกิจกรรมสำเร็จ!");
            e.target.reset();
        }

        async function handleActivityDelete(id) {
            if (confirm(`คุณต้องการลบกิจกรรม ID: ${id} ใช่หรือไม่?`)) {
                await deleteDoc(doc(db, "activities", id));
                showToast("ลบกิจกรรมสำเร็จ!");
            }
        }

        async function handleRewardSave(e) {
            e.preventDefault();
            const id = document.getElementById('reward-id').value.trim();
            if (!id) { showToast("กรุณากรอก Reward ID", true); return; }
            const rewardData = {
                id: id,
                name: document.getElementById('reward-name').value.trim(),
                cost: Number(document.getElementById('reward-cost').value),
                stock: Number(document.getElementById('reward-stock').value),
                img: document.getElementById('reward-img').value.trim()
            };
            await setDoc(doc(db, "rewards", id), rewardData);
            showToast("บันทึกของรางวัลสำเร็จ!");
            e.target.reset();
        }

        async function handleRewardDelete(id) {
            if (confirm(`คุณต้องการลบของรางวัล ID: ${id} ใช่หรือไม่?`)) {
                await deleteDoc(doc(db, "rewards", id));
                showToast("ลบของรางวัลสำเร็จ!");
            }
        }
        
        // --- Event Listeners Setup ---
        function attachListeners() {
            state.unsubscribers.forEach(unsub => unsub());
            state.unsubscribers = [];

            if (!state.isAdmin) {
                const unsubUser = onSnapshot(doc(db, "users", state.userId), (doc) => {
                    state.userData = doc.data();
                    render();
                });
                state.unsubscribers.push(unsubUser);
            }

            const unsubActivities = onSnapshot(collection(db, "activities"), (snapshot) => {
                state.activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.id.localeCompare(b.id));
                if(state.userId) render();
            });
            const unsubRewards = onSnapshot(collection(db, "rewards"), (snapshot) => {
                state.rewards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.id.localeCompare(b.id));
                if(state.userId) render();
            });
            const unsubNumberedLottery = onSnapshot(collection(db, "numberedLottery"), (snapshot) => {
                state.numberedLotteryData = {};
                snapshot.forEach(doc => {
                    state.numberedLotteryData[doc.id] = doc.data();
                });
                if(state.userId && state.currentPage === 'numberedLottery') render();
            });
            
            state.unsubscribers.push(unsubActivities, unsubRewards, unsubNumberedLottery);
        }

        function setupNav() {
            navButtonsContainer.innerHTML = '';
            let navs = [
                { page: 'dashboard', icon: '📊', text: 'แดชบอร์ด' },
                { page: 'rewards', icon: '🎁', text: 'แลกของรางวัล' },
                { page: 'numberedLottery', icon: '🔢', text: 'สลากเรียงเบอร์' }
            ];

            if (state.isAdmin) {
                state.currentPage = 'admin';
                navs = [{ page: 'admin', icon: '⚙️', text: 'ผู้ดูแลระบบ' }];
            } else {
                state.currentPage = 'dashboard';
            }

            navs.forEach(nav => {
                const btn = document.createElement('button');
                btn.dataset.page = nav.page;
                btn.className = 'nav-button py-3 px-4 font-semibold text-gray-500 whitespace-nowrap';
                btn.innerHTML = `<span class="inline-block align-middle mr-1">${nav.icon}</span> ${nav.text}`;
                navButtonsContainer.appendChild(btn);
            });
            
            updateNavStyling();
        }

        function updateNavStyling() {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            const activeBtn = document.querySelector(`.nav-button[data-page="${state.currentPage}"]`);
            if (activeBtn) {
                activeBtn.classList.add('border-blue-600', 'text-blue-600');
                activeBtn.classList.remove('text-gray-500');
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loginButton.addEventListener('click', handleLogin);
            registerButton.addEventListener('click', handleRegistration);
            verifyButton.addEventListener('click', handlePhoneVerification);

            const goBack = () => {
                registrationScreen.classList.add('hidden');
                phoneVerificationScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loginInput.value = '';
                state.userId = null;
            };
            backToLoginButton.addEventListener('click', goBack);
            backToLoginFromVerifyButton.addEventListener('click', goBack);
            
            logoutButton.addEventListener('click', handleLogout);
            
            navButtonsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.nav-button')) {
                    state.currentPage = e.target.closest('.nav-button').dataset.page;
                    updateNavStyling();
                    render();
                }
            });

            mainContent.addEventListener('click', (e) => {
                // User actions
                if (e.target.closest('.join-activity-btn')) {
                    handleJoinActivity(e.target.closest('.join-activity-btn').dataset.activityId);
                }
                if (e.target.closest('.redeem-reward-btn')) {
                    handleRedeemReward(e.target.closest('.redeem-reward-btn').dataset.rewardId);
                }
                if (e.target.closest('.buy-numbered-ticket-btn')) {
                    handleBuyNumberedTicket(e.target.closest('.buy-numbered-ticket-btn').dataset.number);
                }
                // Admin actions
                if (e.target.matches('.edit-activity-btn')) {
                    const id = e.target.dataset.id;
                    const act = state.activities.find(a => a.id === id);
                    if (act) {
                        document.getElementById('activity-id').value = act.id;
                        document.getElementById('activity-name').value = act.name;
                        document.getElementById('activity-description').value = act.description;
                        document.getElementById('activity-points').value = act.points;
                        document.getElementById('activity-icon').value = act.stampIcon;
                    }
                }
                if (e.target.matches('.delete-activity-btn')) {
                    handleActivityDelete(e.target.dataset.id);
                }
                if (e.target.matches('#clear-activity-form')) {
                    document.getElementById('activity-form').reset();
                }
                if (e.target.matches('.edit-reward-btn')) {
                    const id = e.target.dataset.id;
                    const rew = state.rewards.find(r => r.id === id);
                    if (rew) {
                        document.getElementById('reward-id').value = rew.id;
                        document.getElementById('reward-name').value = rew.name;
                        document.getElementById('reward-cost').value = rew.cost;
                        document.getElementById('reward-stock').value = rew.stock;
                        document.getElementById('reward-img').value = rew.img;
                    }
                }
                if (e.target.matches('.delete-reward-btn')) {
                    handleRewardDelete(e.target.dataset.id);
                }
                if (e.target.matches('#clear-reward-form')) {
                    document.getElementById('reward-form').reset();
                }
            });

            mainContent.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.id === 'activity-form') handleActivitySave(e);
                if (e.target.id === 'reward-form') handleRewardSave(e);
            });
        });
    </script>
</body>
</html>
