<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อด้วยใบหน้า V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        #video-container { position: relative; }
        canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header & Navigation -->
        <header class="mb-6">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-slate-800">ระบบเช็คชื่อผู้เข้าอบรมด้วยใบหน้า</h1>
                <p id="status-loading" class="text-yellow-600 animate-pulse">กำลังโหลดโมเดล AI... กรุณารอสักครู่</p>
                <p id="status-ready" class="text-green-600 hidden font-semibold">ระบบพร้อมใช้งาน</p>
            </div>

            <!-- Tabs -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="tab-attendance" class="px-6 py-2 bg-blue-600 text-white rounded-full font-semibold shadow-md transition-all">
                    หน้าเช็คชื่อ / ลงทะเบียน
                </button>
                <button id="tab-management" class="px-6 py-2 bg-white text-slate-600 hover:bg-slate-200 rounded-full font-semibold shadow-sm transition-all">
                    จัดการข้อมูลผู้ลงทะเบียน
                </button>
            </div>
        </header>

        <!-- VIEW 1: Attendance & Registration -->
        <div id="view-attendance" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Interaction Area (Camera & Register) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Camera Feed -->
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <!-- Added min-h to prevent collapse before video loads -->
                    <div id="video-container" class="rounded-lg overflow-hidden bg-black aspect-video relative flex items-center justify-center min-h-[300px]">
                         <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                         <canvas id="overlay"></canvas>
                         <div id="camera-placeholder" class="absolute text-white flex flex-col items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                             </svg>
                             <span class="mt-2">กำลังเปิดกล้อง...</span>
                         </div>
                    </div>
                </div>

                <!-- Registration Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center text-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        ลงทะเบียนผู้เข้าอบรมใหม่
                    </h2>
                    <div class="flex gap-4 md:flex-row flex-col">
                        <input type="text" id="trainee-name" placeholder="กรอกชื่อ-นามสกุล" class="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <button id="btn-register" disabled class="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            ถ่ายภาพเพื่อลงทะเบียน
                        </button>
                    </div>
                    <p class="text-sm text-slate-500 mt-2">* ให้ผู้ลงทะเบียนยืนหน้ากล้องเพียงคนเดียวขณะกดปุ่ม</p>
                </div>
            </div>

            <!-- Sidebar (Attendance List) -->
            <div class="space-y-6">
                <!-- Today's Stats -->
                 <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <h3 class="text-green-800 text-sm font-semibold">เช็คชื่อแล้ว</h3>
                        <p id="count-present" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h3 class="text-blue-800 text-sm font-semibold">ลงทะเบียนทั้งหมด</h3>
                        <p id="count-registered" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                </div>

                <!-- List -->
                <div class="bg-white p-6 rounded-xl shadow-lg max-h-[600px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl font-semibold text-slate-700">รายการเข้าอบรมวันนี้</h2>
                         <button id="btn-clear-today" class="text-sm text-red-500 hover:text-red-700">ล้างรายการวันนี้</button>
                    </div>

                    <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="attendance-list">
                        <p class="text-slate-400 text-center py-4">กำลังโหลด...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: User Management (Hidden by default) -->
        <div id="view-management" class="hidden bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-6 text-slate-800 border-b pb-4">จัดการข้อมูลผู้ลงทะเบียน</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-slate-500 border-b border-slate-200">
                            <th class="py-3 px-4 font-semibold">ชื่อ-นามสกุล</th>
                            <th class="py-3 px-4 font-semibold">วันที่ลงทะเบียน</th>
                            <th class="py-3 px-4 font-semibold text-right">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-list">
                        <!-- User rows will be injected here -->
                    </tbody>
                </table>
            </div>
            <p id="no-users-msg" class="text-center text-slate-500 py-8 hidden">ยังไม่มีผู้ลงทะเบียนในระบบ</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 translate-y-20 opacity-0 z-50 font-semibold text-white"></div>

    <!-- Custom Modal for Delete Confirmation -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการลบ</h3>
            <p class="text-slate-600 mb-6">คุณต้องการลบผู้ใช้งาน "<span id="delete-user-name" class="font-semibold"></span>" ใช่หรือไม่? การกระทำนี้ไม่สามารถเรียกคืนได้</p>
            <div class="flex justify-end space-x-3">
                <button id="btn-cancel-delete" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-lg font-medium">ยกเลิก</button>
                <button id="btn-confirm-delete" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">ลบผู้ใช้งาน</button>
            </div>
        </div>
    </div>

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Globals ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const firebaseConfig = {
            apiKey: "AIzaSyDQHNJIYdss2pPiaIhJIwh0r33ZgByomUA",
            authDomain: "checkin-58c3d.firebaseapp.com",
            projectId: "checkin-58c3d",
            storageBucket: "checkin-58c3d.firebasestorage.app",
            messagingSenderId: "1086783925775",
            appId: "1:1086783925775:web:e8afa72e0b4f5f768f7d7a"
        };

        let db, auth, user;
        let labeledFaceDescriptors = [];
        let faceMatcher = null;
        let isModelLoaded = false;
        let isCameraReady = false;
        let allRegisteredUsers = [];
        let userToDeleteId = null;
        // NEW: Track who already checked in TODAY to update UI and prevent duplicate calls
        const checkedInToday = new Set();
        let isAttendanceListReady = false; // Flag to ensure we have loaded today's list before allowing check-ins

        const COLLECTION_USERS = `artifacts/${appId}/public/data/face_users`;
        const COLLECTION_ATTENDANCE = `artifacts/${appId}/public/data/face_attendance`;

        // --- UI Elements ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const statusLoading = document.getElementById('status-loading');
        const statusReady = document.getElementById('status-ready');
        const btnRegister = document.getElementById('btn-register');
        const inputName = document.getElementById('trainee-name');
        const attendanceListEl = document.getElementById('attendance-list');
        const countPresentEl = document.getElementById('count-present');
        const countRegisteredEl = document.getElementById('count-registered');
        const btnClearToday = document.getElementById('btn-clear-today');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const tabAttendance = document.getElementById('tab-attendance');
        const tabManagement = document.getElementById('tab-management');
        const viewAttendance = document.getElementById('view-attendance');
        const viewManagement = document.getElementById('view-management');
        const userManagementListEl = document.getElementById('user-management-list');
        const noUsersMsg = document.getElementById('no-users-msg');
        const deleteModal = document.getElementById('delete-modal');
        const deleteUserNameEl = document.getElementById('delete-user-name');
        const btnCancelDelete = document.getElementById('btn-cancel-delete');
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');

        // --- Initialization ---
        async function initApp() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (firebaseUser) => {
                if (firebaseUser) {
                    user = firebaseUser;
                    await loadModels();
                    await loadRegisteredUsers();
                    setupRealtimeAttendance();
                    startVideo();
                } else {
                    signInAnonymously(auth).catch(e => showToast("Auth failed: " + e.message, 'error'));
                }
            });
        }

        // --- Tab Switching ---
        tabAttendance.addEventListener('click', () => switchTab('attendance'));
        tabManagement.addEventListener('click', () => switchTab('management'));
        function switchTab(tab) {
            if (tab === 'attendance') {
                viewAttendance.classList.remove('hidden');
                viewManagement.classList.add('hidden');
                tabAttendance.classList.replace('bg-white', 'bg-blue-600');
                tabAttendance.classList.replace('text-slate-600', 'text-white');
                tabManagement.classList.replace('bg-blue-600', 'bg-white');
                tabManagement.classList.replace('text-white', 'text-slate-600');
            } else {
                viewAttendance.classList.add('hidden');
                viewManagement.classList.remove('hidden');
                tabManagement.classList.replace('bg-white', 'bg-blue-600');
                tabManagement.classList.replace('text-slate-600', 'text-white');
                tabAttendance.classList.replace('bg-blue-600', 'bg-white');
                tabAttendance.classList.replace('text-white', 'text-slate-600');
                renderManagementList();
            }
        }

        // --- Face API Setup ---
        async function loadModels() {
            try {
                // Alternative robust CDN
                // const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelLoaded = true;
                updateSystemStatus();
            } catch (error) {
                console.error("Model Load Error:", error);
                statusLoading.textContent = "เกิดข้อผิดพลาดในการโหลดโมเดล AI (ลองรีเฟรชหน้าจอ)";
                statusLoading.classList.add('text-red-600');
            }
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    cameraPlaceholder.classList.add('hidden');
                })
                .catch(err => {
                    console.error("Camera Error:", err);
                    showToast("ไม่สามารถเข้าถึงกล้องได้ กรุณาตรวจสอบสิทธิ์", 'error');
                });
        }

        video.addEventListener('play', () => {
            isCameraReady = true;
            updateSystemStatus();
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                if (!isModelLoaded || !faceMatcher || viewAttendance.classList.contains('hidden')) return;

                if (canvas.width !== video.offsetWidth || canvas.height !== video.offsetHeight) {
                     faceapi.matchDimensions(canvas, { width: video.offsetWidth, height: video.offsetHeight });
                }

                // Slightly lower Detection confidence to ensure we catch faces even at bad angles
                const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, { width: video.offsetWidth, height: video.offsetHeight });
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (resizedDetections.length > 0) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const { label, distance } = result;
                        
                        let color = '#ef4444'; // Red (Unknown)
                        let text = 'ไม่รู้จัก';

                        if (label !== 'unknown') {
                            const isCheckedIn = checkedInToday.has(label);
                            // Green if new, Blue if already checked in
                            color = isCheckedIn ? '#3b82f6' : '#22c55e';
                            const percentage = Math.round((1-distance)*100);
                            text = `${label} (${percentage}%) ${isCheckedIn ? '(เช็คชื่อแล้ว)' : ''}`;
                            
                            // Trigger check-in only if NOT checked in today AND attendance list is fully loaded
                            if (!isCheckedIn && isAttendanceListReady) {
                                handleCheckIn(label);
                            }
                        }
                        
                        // Draw with slightly thicker lines for better visibility
                        const drawBox = new faceapi.draw.DrawBox(box, { label: text, boxColor: color, lineWidth: 2 });
                        drawBox.draw(canvas);
                    });
                }
            }, 500);
        });

        function updateSystemStatus() {
            if (isModelLoaded && isCameraReady) {
                statusLoading.classList.add('hidden');
                statusReady.classList.remove('hidden');
                btnRegister.disabled = false;
            }
        }

        // --- Firestore Logic ---

        function loadRegisteredUsers() {
            const q = query(collection(db, COLLECTION_USERS), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                labeledFaceDescriptors = [];
                allRegisteredUsers = [];
                let count = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    allRegisteredUsers.push({ id: docSnap.id, ...data });
                    if(data.descriptor) {
                         const descriptor = new Float32Array(data.descriptor);
                         labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(data.name, [descriptor]));
                         count++;
                    }
                });
                countRegisteredEl.textContent = count;
                // Distance 0.6 = 40% similarity threshold.
                // If user sees 50% (distance 0.5), it matches (0.5 < 0.6).
                faceMatcher = labeledFaceDescriptors.length > 0 ? new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6) : null;
                if (!viewManagement.classList.contains('hidden')) renderManagementList();
            });
        }

        function renderManagementList() {
            userManagementListEl.innerHTML = '';
            if (allRegisteredUsers.length === 0) {
                noUsersMsg.classList.remove('hidden');
                return;
            }
            noUsersMsg.classList.add('hidden');
            allRegisteredUsers.forEach(user => {
                const dateStr = user.createdAt ? user.createdAt.toDate().toLocaleDateString('th-TH') : '-';
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-100 hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="py-4 px-4 font-medium text-slate-800 name-cell">${user.name}</td>
                    <td class="py-4 px-4 text-slate-500">${dateStr}</td>
                    <td class="py-4 px-4 text-right space-x-2 action-cell">
                        <button class="btn-edit text-blue-600 hover:text-blue-800 font-semibold text-sm px-3 py-1 bg-blue-50 hover:bg-blue-100 rounded-md transition">แก้ไข</button>
                        <button class="btn-delete text-red-600 hover:text-red-800 font-semibold text-sm px-3 py-1 bg-red-50 hover:bg-red-100 rounded-md transition">ลบ</button>
                    </td>`;
                
                const btnEdit = tr.querySelector('.btn-edit');
                const btnDelete = tr.querySelector('.btn-delete');
                const nameCell = tr.querySelector('.name-cell');
                const actionCell = tr.querySelector('.action-cell');

                btnDelete.addEventListener('click', () => confirmDeleteUser(user.id, user.name));
                btnEdit.addEventListener('click', () => {
                    const currentName = nameCell.textContent;
                    nameCell.innerHTML = `<input type="text" class="edit-input w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value="${currentName}">`;
                    actionCell.innerHTML = `<button class="btn-save text-white bg-green-500 hover:bg-green-600 font-semibold text-sm px-3 py-1 rounded-md transition mr-2">บันทึก</button><button class="btn-cancel text-slate-600 bg-slate-200 hover:bg-slate-300 font-semibold text-sm px-3 py-1 rounded-md transition">ยกเลิก</button>`;
                    nameCell.querySelector('input').focus();
                    actionCell.querySelector('.btn-save').addEventListener('click', async () => {
                        const newName = nameCell.querySelector('input').value.trim();
                        if (newName && newName !== currentName) {
                            await updateDoc(doc(db, COLLECTION_USERS, user.id), { name: newName });
                            showToast('แก้ไขชื่อเรียบร้อยแล้ว', 'success');
                        } else { renderManagementList(); }
                    });
                    actionCell.querySelector('.btn-cancel').addEventListener('click', () => renderManagementList());
                });
                userManagementListEl.appendChild(tr);
            });
        }

        function confirmDeleteUser(id, name) {
            userToDeleteId = id;
            deleteUserNameEl.textContent = name;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }
        btnCancelDelete.addEventListener('click', () => { deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); userToDeleteId = null; });
        btnConfirmDelete.addEventListener('click', async () => {
            if (userToDeleteId) {
                await deleteDoc(doc(db, COLLECTION_USERS, userToDeleteId));
                showToast('ลบผู้ใช้งานเรียบร้อยแล้ว', 'success');
                deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); userToDeleteId = null;
            }
        });

        btnRegister.addEventListener('click', async () => {
            const name = inputName.value.trim();
            if (!name) { showToast("กรุณากรอกชื่อก่อนลงทะเบียน", 'warning'); return; }
            if (!isModelLoaded || !isCameraReady) { showToast("ระบบยังไม่พร้อม", 'warning'); return; }
            btnRegister.disabled = true; btnRegister.textContent = "กำลังประมวลผล...";
            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();
                if (detection) {
                    await addDoc(collection(db, COLLECTION_USERS), { name: name, descriptor: Array.from(detection.descriptor), createdAt: serverTimestamp() });
                    showToast(`ลงทะเบียน "${name}" เรียบร้อยแล้ว`, 'success');
                    inputName.value = '';
                } else { showToast("ไม่พบใบหน้า หรือมีมากกว่า 1 คนในกล้อง", 'error'); }
            } catch (e) { console.error(e); showToast("เกิดข้อผิดพลาด", 'error'); }
            finally { btnRegister.disabled = false; btnRegister.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>ถ่ายภาพเพื่อลงทะเบียน`; }
        });

        // 3. Check-in Logic (FIXED: Removed double-query that caused index error)
        const pendingCheckIns = new Set();

        async function handleCheckIn(name) {
            // Trust the `checkedInToday` set which is populated by the main listener.
            // If it's not in there AND attendance list is ready, it's a new check-in.
            if (checkedInToday.has(name) || pendingCheckIns.has(name)) return;
            
            pendingCheckIns.add(name);
            console.log(`Attempting check-in for: ${name}`);

            try {
                // Removed the explicit getDocs query here that was causing "Query requires index" error.
                // We now rely entirely on the realtime listener to tell us who is checked in.
                await addDoc(collection(db, COLLECTION_ATTENDANCE), { name: name, timestamp: serverTimestamp() });
                showToast(`${name} เช็คชื่อแล้ว!`, 'success');
            } catch (e) {
                console.error("Check-in failed for", name, e);
                // On error, remove from pending so it can try again later, but maybe after a longer delay in real world
                setTimeout(() => pendingCheckIns.delete(name), 5000); 
            }
            // Note: We don't immediately delete from pendingCheckIns on success, 
            // we let the onSnapshot update `checkedInToday` first, 
            // effectively using pendingCheckIns as a temporary block until confirmed by DB.
            // Actually, let's clear it after a safe delay to ensure onSnapshot caught up.
             setTimeout(() => pendingCheckIns.delete(name), 10000);
        }

        // 4. Real-time Attendance List (IMPROVED)
        function setupRealtimeAttendance() {
            // FIX: Simplified query to avoid potential index issues here too, 
            // though single field + order usually works. 
            // If this also fails, we will remove orderBy and sort in JS.
            const todayStart = new Date();
            todayStart.setHours(0,0,0,0);
            
            // Try with orderBy first. If it fails in YOUR console, tell me, we might need to remove orderBy.
            // Usually 'where(field >= X) orderBy(field)' is OK without composite index.
            const q = query(collection(db, COLLECTION_ATTENDANCE), where("timestamp", ">=", todayStart), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                attendanceListEl.innerHTML = '';
                checkedInToday.clear();
                let count = 0;
                
                if (snapshot.empty) {
                    attendanceListEl.innerHTML = '<p class="text-slate-400 text-center py-4">ยังไม่มีการเช็คชื่อวันนี้</p>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        checkedInToday.add(data.name);
                        // If it was pending, it's now confirmed, so we can remove from pending (optional, as checkedInToday handles it now)
                        pendingCheckIns.delete(data.name); 

                        const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '...';
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100 animate-fadeIn';
                        item.innerHTML = `<div class="flex items-center"><div class="h-8 w-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center mr-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div><span class="font-medium text-slate-700">${data.name}</span></div><span class="text-sm text-slate-500">${time} น.</span>`;
                        attendanceListEl.appendChild(item);
                        count++;
                    });
                }
                countPresentEl.textContent = count;
                isAttendanceListReady = true; // Data is loaded, enable check-ins
            }, (error) => {
                console.error("Attendance realtime listener failed:", error);
                // Fallback if even this simple query fails due to index (unlikely but possible)
                if (error.code.includes('index')) {
                     showToast("ระบบต้องการ Index กรุณาแจ้งผู้ดูแล", 'error');
                }
            });
        }

        btnClearToday.addEventListener('click', async () => {
             deleteUserNameEl.textContent = "รายการเช็คชื่อทั้งหมดของวันนี้";
             deleteModal.querySelector('h3').textContent = "ยืนยันการล้างรายการ";
             if (btnClearToday.dataset.confirm === 'true') {
                const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                // Simple query for deletion, should be fine without composite index
                const q = query(collection(db, COLLECTION_ATTENDANCE), where("timestamp", ">=", todayStart));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (docSnap) => await deleteDoc(doc(db, COLLECTION_ATTENDANCE, docSnap.id)));
                checkedInToday.clear();
                showToast('ล้างรายการวันนี้เรียบร้อย', 'success');
                btnClearToday.textContent = 'ล้างรายการวันนี้'; btnClearToday.classList.remove('text-red-700', 'font-bold'); delete btnClearToday.dataset.confirm;
            } else {
                btnClearToday.textContent = 'ยืนยันการล้าง?'; btnClearToday.classList.add('text-red-700', 'font-bold'); btnClearToday.dataset.confirm = 'true';
                setTimeout(() => { btnClearToday.textContent = 'ล้างรายการวันนี้'; btnClearToday.classList.remove('text-red-700', 'font-bold'); delete btnClearToday.dataset.confirm; }, 3000);
            }
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 z-50 font-semibold text-white ${type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-red-500'}`;
            setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        initApp();
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</body>
</html>
