import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from 'firebase/firestore';

// --- Global Variables (Provided by Canvas Environment) ---
// These variables are automatically available in the Canvas runtime.
// DO NOT modify these lines or try to define them if they are undefined.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Context for Global State and Firebase ---
const AppContext = createContext(null);

// --- Helper Functions for Job ID Generation ---

// Helper function to get the last running number for today's jobs
const getTodaysLastJobNumber = async (db, appId) => {
    const today = new Date();
    const year = today.getFullYear().toString().slice(-2);
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const prefix = `PM${year}${month}${day}`;

    const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
    const q = query(
        jobsCollectionRef,
        where('id', '>=', prefix),
        where('id', '<', prefix + 'zzz'), // 'zzz' is a simple way to create an upper bound for the query
        orderBy('id', 'desc'),
        limit(1)
    );

    const querySnapshot = await getDocs(q);
    let lastRunningNumber = 0;

    if (!querySnapshot.empty) {
        const lastJobId = querySnapshot.docs[0].id;
        const lastNumberStr = lastJobId.slice(-3); // Get the last 3 digits of the running number
        lastRunningNumber = parseInt(lastNumberStr, 10);
    }

    return lastRunningNumber;
};

// Helper function to generate a new unique job ID for a single job creation
const generateSingleNewJobId = async (db, appId) => {
    const lastNumber = await getTodaysLastJobNumber(db, appId);
    const newNumber = lastNumber + 1;

    const today = new Date();
    const year = today.getFullYear().toString().slice(-2);
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const prefix = `PM${year}${month}${day}`;

    return `${prefix}${String(newNumber).padStart(3, '0')}`;
};


const AppProvider = ({ children }) => {
    const [currentPage, setCurrentPage] = useState('login');
    const [loggedInUser, setLoggedInUser] = useState(null);
    const [machines, setMachines] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [plans, setPlans] = useState([]); // For Master and Monthly Plans
    const [selectedJob, setSelectedJob] = useState(null);
    const [selectedMachine, setSelectedMachine] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Firebase instances
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);

    // Initial machine data (Hardcoded for demonstration)
    const initialMachines = [
        {
            id: 'MC-01-0001',
            assetNo: 'MC-01-0001',
            serialNo: 'SN010001',
            name: 'เครื่องจักรผลิต 1',
            type: 'Prod.1',
            location: 'Line1',
            lastPM: '2024-06-01',
            nextPM: 'N/A', // Will be calculated based on lastPM and first PM condition
            status: 'Operational', // Default status
            pmConditions: [
                {
                    task: 'ทำความสะอาดเครื่องยนต์ทุกเดือน',
                    frequency: 'monthly',
                    lastValue: '2024-06-01',
                    nextDue: '2024-07-01',
                    parts: [
                        { name: 'จาระบี', partNo: 'I-O-00001', qtyNeeded: 1 },
                        { name: 'น้ำมันทำความสะอาด', partNo: 'I-O-00002', qtyNeeded: 1 },
                        { name: 'น้ำมันเครื่อง', partNo: 'I-O-00003', qtyNeeded: 1 },
                    ],
                },
                {
                    task: 'ตรวจสอบและเปลี่ยนสายพานทุก 1000 ชั่วโมง',
                    frequency: '1000 hours',
                    lastValue: '9500',
                    nextDue: '10500',
                    parts: [
                        { name: 'สายพาน', partNo: 'I-P-00001', qtyNeeded: 1 },
                        { name: 'จาระบี', partNo: 'I-O-00001', qtyNeeded: 1 },
                    ],
                },
                {
                    task: 'ตรวจสอบและทำความสะอาดมอเตอร์ทุกไตรมาส',
                    frequency: 'quarterly',
                    lastValue: '2024-04-01',
                    nextDue: '2024-07-01',
                    parts: [
                        { name: 'จาระบี', partNo: 'I-O-00001', qtyNeeded: 1 },
                        { name: 'น้ำมันทำความสะอาด', partNo: 'I-O-00002', qtyNeeded: 1 },
                        { name: 'น้ำมันเครื่อง', partNo: 'I-O-00003', qtyNeeded: 1 },
                    ],
                },
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system-init',
        },
        {
            id: 'MC-01-0002',
            assetNo: 'MC-01-0002',
            serialNo: 'SN010002',
            name: 'เครื่องจักรบรรจุ 2',
            type: 'Pack.2',
            location: 'Line2',
            lastPM: '2024-05-15',
            nextPM: 'N/A',
            status: 'Operational',
            pmConditions: [
                {
                    task: 'ตรวจสอบระบบลมทุกเดือน',
                    frequency: 'monthly',
                    lastValue: '2024-05-15',
                    nextDue: '2024-06-15',
                    parts: [
                        { name: 'ซีลยาง', partNo: 'I-S-00001', qtyNeeded: 2 },
                    ],
                },
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system-init',
        },
    ];

    // Initial machine register data (latest readings)
    const initialMachineRegisters = [
        {
            id: 'MC-01-0001',
            machineId: 'MC-01-0001',
            lastMeterReading: 10250, // Example meter reading
            lastServiceDate: '2024-06-01',
            currentLocation: 'Line1',
            timestamp: new Date().toISOString(),
            recordedBy: 'system-init',
        },
        {
            id: 'MC-01-0002',
            machineId: 'MC-01-0002',
            lastMeterReading: 5120,
            lastServiceDate: '2024-05-15',
            currentLocation: 'Line2',
            timestamp: new Date().toISOString(),
            recordedBy: 'system-init',
        },
    ];

    // Initial monthly plans data
    const initialMonthlyPlans = [
        {
            id: `monthly-plan-${new Date().getFullYear()}-${new Date().getMonth() + 1}-MC010001-PM`,
            type: 'monthly',
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1,
            planName: 'แผน PM ประจำเดือน ก.ค. - เครื่องจักรผลิต 1',
            machineId: 'MC-01-0001',
            machineName: 'เครื่องจักรผลิต 1',
            assetNo: 'MC-01-0001',
            planType: 'PM',
            scheduledDate: new Date(new Date().getFullYear(), new Date().getMonth(), 15).toISOString(), // Mid-month
            description: 'PM ประจำเดือนสำหรับเครื่องจักรผลิต 1 ตามแผน',
            requiredParts: [
                { name: 'จาระบี', partNo: 'I-O-00001', qty: 1 },
                { name: 'น้ำมันทำความสะอาด', partNo: 'I-O-00002', qty: 1 },
            ],
            status: 'Approved', // This plan is approved
            generatedDate: new Date().toISOString(),
            approvedDate: new Date().toISOString(),
            jobCreated: false, // This plan has NOT yet created a job
            createdBy: 'system-init',
            approvedBy: 'system-init',
        },
        {
            id: `monthly-plan-${new Date().getFullYear()}-${new Date().getMonth() + 1}-MC010002-PM`,
            type: 'monthly',
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1,
            planName: 'แผน PM ประจำเดือน ก.ค. - เครื่องจักรบรรจุ 2',
            machineId: 'MC-01-0002',
            machineName: 'เครื่องจักรบรรจุ 2',
            assetNo: 'MC-01-0002',
            planType: 'PM',
            scheduledDate: new Date(new Date().getFullYear(), new Date().getMonth(), 20).toISOString(),
            description: 'PM ประจำเดือนสำหรับเครื่องจักรบรรจุ 2 ตรวจสอบระบบลม',
            requiredParts: [
                { name: 'ซีลยาง', partNo: 'I-S-00001', qty: 2 },
            ],
            status: 'Approved',
            generatedDate: new Date().toISOString(),
            approvedDate: new Date().toISOString(),
            jobCreated: false,
            createdBy: 'system-init',
            approvedBy: 'system-init',
        },
        {
            id: `monthly-plan-${new Date().getFullYear()}-${new Date().getMonth() + 1}-MC010001-QPM`,
            type: 'monthly',
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1,
            planName: 'แผน QPM ประจำไตรมาส 3 - เครื่องจักรผลิต 1',
            machineId: 'MC-01-0001',
            machineName: 'เครื่องจักรผลิต 1',
            assetNo: 'MC-01-0001',
            planType: 'QPM',
            scheduledDate: new Date(new Date().getFullYear(), new Date().getMonth(), 25).toISOString(),
            description: 'QPM ประจำไตรมาส 3 สำหรับเครื่องจักรผลิต 1',
            requiredParts: [
                { name: 'น้ำมันเครื่อง', partNo: 'I-O-00003', qty: 1 },
                { name: 'ไส้กรองน้ำมัน', partNo: 'I-F-00001', qty: 1 },
            ],
            status: 'Approved',
            generatedDate: new Date().toISOString(),
            approvedDate: new Date().toISOString(),
            jobCreated: false,
            createdBy: 'system-init',
            approvedBy: 'system-init',
        },
    ];

    // Initial jobs data (some already existing, some linked to plans)
    const initialJobs = [
        {
            id: 'PM240710001', // Updated ID format
            assetNo: 'MC-01-0001',
            machineName: 'เครื่องจักรผลิต 1',
            type: 'Monthly PM',
            assignedTo: 'Tom Tech',
            status: 'In Progress',
            dueDate: '2024-07-15',
            tasks: ['ทำความสะอาดเครื่องยนต์', 'ตรวจสอบระบบไฟฟ้า'],
            parts: [{ name: 'จาระบี', qty: 1, status: 'Ready' }],
            techSign: true, chiefProdSign: false, qcSign: false, supervisorApproved: false,
            technicianRemarks: 'ดำเนินการทำความสะอาดเครื่องยนต์เรียบร้อย', qcRemarks: '', supervisorRemarks: '',
            pcConfirmed: true, storeConfirmed: true,
            monthlyPlanRefId: `monthly-plan-2024-7-MC010001-PM`, // Match year/month for consistency
            meterReadingAtStart: 10200,
            prevServiceDate: '2024-06-01',
            currentLocationAtJobOpen: 'Line1',
            createdAt: new Date('2024-07-10').toISOString(),
            createdBy: 'system-init',
        },
        {
            id: 'PM240712001', // Updated ID format
            assetNo: 'ADHOC-MCH',
            machineName: 'เครื่องจักรบรรจุ 3',
            type: 'Ad-hoc PM',
            assignedTo: 'Unassigned',
            status: 'Open',
            dueDate: '2024-07-20',
            tasks: ['ตรวจสอบเสียงดังผิดปกติ'],
            parts: [],
            techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
            technicianRemarks: '', qcRemarks: '', supervisorRemarks: '',
            pcConfirmed: false, storeConfirmed: false,
            monthlyPlanRefId: null,
            meterReadingAtStart: null,
            prevServiceDate: null,
            currentLocationAtJobOpen: null,
            createdAt: new Date('2024-07-12').toISOString(),
            createdBy: 'system-init',
        },
    ];


    // --- Firebase Initialization and Authentication ---
    useEffect(() => {
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authInstance = getAuth(app);
                setDb(firestore);
                setAuth(authInstance);

                // Sign in using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                } else {
                    await signInAnonymously(authInstance);
                }

                // Listen for auth state changes
                const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null); // User logged out or not authenticated
                    }
                    setLoading(false); // Auth state is ready
                });

                return () => unsubscribeAuth();
            } catch (err) {
                console.error("Firebase initialization or authentication error:", err);
                setError("Failed to initialize application. Please try again.");
                setLoading(false);
            }
        };

        initFirebase();
    }, []);

    // --- Firestore Data Subscriptions and Initial Data Seeding ---
    useEffect(() => {
        if (!db || !userId) return;

        const seedData = async () => {
            // Seed initial machines
            const machinesCollectionRef = collection(db, `artifacts/${appId}/public/data/machines`);
            for (const machineData of initialMachines) {
                const machineDocRef = doc(machinesCollectionRef, machineData.id);
                const docSnap = await getDoc(machineDocRef);
                if (!docSnap.exists()) {
                    console.log(`Seeding initial machine: ${machineData.id}`);
                    await setDoc(machineDocRef, machineData);
                }
            }

            // Seed initial machine registers (latest state)
            const machineRegistersCollectionRef = collection(db, `artifacts/${appId}/public/data/machineRegisters`);
            for (const registerData of initialMachineRegisters) {
                const registerDocRef = doc(machineRegistersCollectionRef, registerData.id);
                const docSnap = await getDoc(registerDocRef);
                if (!docSnap.exists()) {
                    console.log(`Seeding initial machine register: ${registerData.id}`);
                    await setDoc(registerDocRef, registerData);
                }
            }

            // Seed initial monthly plans
            const plansCollectionRef = collection(db, `artifacts/${appId}/public/data/plans`);
            for (const planData of initialMonthlyPlans) {
                const planDocRef = doc(plansCollectionRef, planData.id);
                const docSnap = await getDoc(planDocRef);
                if (!docSnap.exists()) {
                    console.log(`Seeding initial monthly plan: ${planData.id}`);
                    await setDoc(planDocRef, planData);
                }
            }

            // Seed initial jobs
            const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            for (const jobData of initialJobs) {
                const jobDocRef = doc(jobsCollectionRef, jobData.id);
                const docSnap = await getDoc(jobDocRef);
                if (!docSnap.exists()) {
                    console.log(`Seeding initial job: ${jobData.id}`);
                    await setDoc(jobDocRef, jobData);
                }
            }

            // Update monthly plan to jobCreated if a job for it already exists in initialJobs
            for (const jobData of initialJobs) {
                if (jobData.monthlyPlanRefId) {
                    const planDocRef = doc(plansCollectionRef, jobData.monthlyPlanRefId);
                    const planSnap = await getDoc(planDocRef);
                    if (planSnap.exists() && !planSnap.data().jobCreated) {
                        await updateDoc(planDocRef, { jobCreated: true, jobId: jobData.id });
                        console.log(`Updated monthly plan ${jobData.monthlyPlanRefId} to jobCreated: true`);
                    }
                }
            }
        };

        seedData(); // Call the seeding function

        // Subscribe to Machines
        const machinesCollectionRef = collection(db, `artifacts/${appId}/public/data/machines`);
        const unsubscribeMachines = onSnapshot(machinesCollectionRef, (snapshot) => {
            const fetchedMachines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMachines(fetchedMachines);
        }, (err) => {
            console.error("Error fetching machines:", err);
            setError("Failed to load machine data.");
        });

        // Subscribe to Jobs
        const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
        const unsubscribeJobs = onSnapshot(jobsCollectionRef, (snapshot) => {
            const fetchedJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setJobs(fetchedJobs);
        }, (err) => {
            console.error("Error fetching jobs:", err);
            setError("Failed to load job data.");
        });

        // Subscribe to Plans
        const plansCollectionRef = collection(db, `artifacts/${appId}/public/data/plans`);
        const unsubscribePlans = onSnapshot(plansCollectionRef, (snapshot) => {
            const fetchedPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPlans(fetchedPlans);
        }, (err) => {
            console.error("Error fetching plans:", err);
            setError("Failed to load plan data.");
        });

        return () => {
            unsubscribeMachines();
            unsubscribeJobs();
            unsubscribePlans();
        };
    }, [db, userId]); // Re-run when db or userId changes

    const navigate = (page, data = null) => {
        setCurrentPage(page);
        if (page === 'web-job-detail' || page === 'mobile-job-detail') { // Removed mobile-job-inspection
            setSelectedJob(data);
        } else if (page === 'web-machine-detail') {
            setSelectedMachine(data);
        } else {
            setSelectedJob(null);
            setSelectedMachine(null);
        }
    };

    const value = {
        currentPage,
        navigate,
        loggedInUser,
        setLoggedInUser,
        machines,
        jobs,
        plans,
        selectedJob,
        selectedMachine,
        db, // Pass db instance to components
        userId, // Pass userId
        loading, // Pass loading state
        error, // Pass error state
    };

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
};

// Helper function to calculate next PM date based on frequency
const calculateNextPMDate = (lastPMDate, frequency) => {
    if (!lastPMDate) return 'N/A';
    const date = new Date(lastPMDate);
    if (isNaN(date.getTime())) return 'Invalid Date';

    let nextDate = new Date(date); // Start with the last PM date

    switch (frequency.toLowerCase()) {
        case 'daily':
            nextDate.setDate(date.getDate() + 1);
            break;
        case 'weekly':
            nextDate.setDate(date.getDate() + 7);
            break;
        case 'monthly':
            nextDate.setMonth(date.getMonth() + 1);
            break;
        case 'quarterly':
            nextDate.setMonth(date.getMonth() + 3);
            break;
        case 'semi-annually':
            nextDate.setMonth(date.getMonth() + 6);
            break;
        case 'annually':
            nextDate.setFullYear(date.getFullYear() + 1);
            break;
        default:
            // For custom frequencies like '1000 Hrs', we can't calculate a date directly
            // In a real system, this would involve meter readings or more complex logic.
            return 'N/A (Custom Frequency)';
    }

    // Format as YYYY-MM-DD
    return nextDate.toISOString().split('T')[0];
};


// --- Common Components ---
const Navbar = () => {
    const { navigate, loggedInUser, setLoggedInUser } = useContext(AppContext);

    const handleLogout = async () => {
        if (loggedInUser) {
            setLoggedInUser(null);
            navigate('login');
            // In a real app, you'd also sign out from Firebase here: await auth.signOut();
        }
    };

    return (
        <nav className="bg-white p-4 text-gray-800 shadow-md rounded-b-lg">
            <div className="container mx-auto flex justify-between items-center">
                <div className="text-2xl font-bold text-gray-800">PM Sync</div>
                {loggedInUser && (
                    <div className="flex items-center space-x-4">
                        <span className="text-lg font-semibold text-gray-700">{loggedInUser.name}</span>
                        <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                            <img src="https://placehold.co/40x40/cccccc/ffffff?text=User" alt="User Profile" className="w-full h-full object-cover" />
                        </div>
                        <button
                            onClick={handleLogout}
                            className="bg-red-500 text-white px-4 py-2 rounded-full shadow-md hover:bg-red-600 transition duration-300 ease-in-out"
                        >
                            Logout
                        </button>
                    </div>
                )}
            </div>
        </nav>
    );
};

const Sidebar = () => {
    const { navigate, loggedInUser, currentPage } = useContext(AppContext);

    if (!loggedInUser || loggedInUser.type === 'mobile') return null;

    const menuItems = [
        { id: 'web-dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt', roles: ['Admin', 'Planner', 'Supervisor', 'Store', 'PC'] },
        { id: 'web-machine-register', name: 'Machine Register', icon: 'fas fa-cogs', roles: ['Admin', 'Planner'] },
        { id: 'web-job-management', name: 'Job Management', icon: 'fas fa-clipboard-list', roles: ['Admin', 'Supervisor'] },
        { id: 'web-monthly-plan', name: 'Monthly Plan', icon: 'fas fa-calendar-alt', roles: ['Admin', 'Planner', 'Supervisor'] },
        { id: 'web-store-confirmation', name: 'Store', icon: 'fas fa-warehouse', roles: ['Admin', 'Store'] },
        { id: 'web-store-parts-summary', name: 'Parts Summary', icon: 'fas fa-boxes', roles: ['Admin', 'Store'] },
        { id: 'web-pc-confirmation', name: 'PC Confirmation', icon: 'fas fa-industry', roles: ['Admin', 'PC'] },
        { id: 'web-reports', name: 'Reports', icon: 'fas fa-chart-line', roles: ['Admin', 'Planner', 'Supervisor'] },
        { id: 'web-user-management', name: 'User Management', icon: 'fas fa-users', roles: ['Admin'] },
        { id: 'web-settings', name: 'Settings', icon: 'fas fa-cog', roles: ['Admin'] },
        { id: 'web-admin-workflow', name: 'Admin Workflow', icon: 'fas fa-user-shield', roles: ['Admin'] }, // New Admin Workflow menu
    ];

    return (
        <div className="w-64 bg-gray-800 text-white p-4 h-screen shadow-xl rounded-r-lg flex flex-col">
            <div className="flex items-center mb-8">
                <img src="https://img2.pic.in.th/pic/A-professional-and-modern-logo-design-for-a-maintenance-planning-software-called-PM-Sync.-The-logo.png" alt="PM Sync Logo" className="w-12 h-12 mr-3" />
                <span className="text-2xl font-bold">PM Sync</span>
            </div>
            <ul className="space-y-3 flex-1">
                {menuItems.map(item =>
                    loggedInUser.roles.some(role => item.roles.includes(role)) && (
                        <li key={item.id}>
                            <button
                                onClick={() => navigate(item.id)}
                                className={`w-full text-left px-4 py-2 rounded-md flex items-center space-x-3 transition duration-200 ease-in-out
                                    ${currentPage === item.id ? 'bg-blue-700 text-white shadow-inner' : 'hover:bg-blue-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500'}`}
                            >
                                <i className={`${item.icon} text-lg`}></i>
                                <span>{item.name}</span>
                            </button>
                        </li>
                    )
                )}
            </ul>
        </div>
    );
};

// --- Web Application Pages ---

const LoginPage = () => {
    const { navigate, setLoggedInUser } = useContext(AppContext);
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = () => {
        setError('');
        // Simple dummy login logic
        if (username === 'planner' && password === 'pass') {
            setLoggedInUser({ id: 'user1', name: 'John Doe', role: 'Planner', roles: ['Planner', 'Supervisor', 'Admin'], type: 'web' });
            navigate('web-dashboard');
        } else if (username === 'supervisor' && password === 'pass') {
            setLoggedInUser({ id: 'user2', name: 'Jane Smith', role: 'Supervisor', roles: ['Supervisor'], type: 'web' });
            navigate('web-dashboard');
        } else if (username === 'store' && password === 'pass') {
            setLoggedInUser({ id: 'user3', name: 'Mike Store', role: 'Store', roles: ['Store'], type: 'web' });
            navigate('web-store-confirmation');
        } else if (username === 'pc' && password === 'pass') {
            setLoggedInUser({ id: 'user4', name: 'Sarah PC', role: 'PC', roles: ['PC'], type: 'web' });
            navigate('web-pc-confirmation');
        } else if (username === 'technician' && password === 'pass') {
            setLoggedInUser({ id: 'user5', name: 'Tom Tech', role: 'Technician', roles: ['Technician'], type: 'mobile' });
            navigate('mobile-my-jobs');
        } else if (username === 'chiefprod' && password === 'pass') {
            setLoggedInUser({ id: 'user6', name: 'David Chief', role: 'Chief Production', roles: ['Chief Production'], type: 'mobile' });
            navigate('mobile-my-jobs'); // Navigate to my jobs, where they can inspect
        } else if (username === 'qc' && password === 'pass') {
            setLoggedInUser({ id: 'user7', name: 'Emily QC', role: 'QC', roles: ['QC'], type: 'mobile' });
            navigate('mobile-my-jobs'); // Navigate to my jobs, where they can inspect
        } else if (username === 'admin' && password === 'pass') { // New Admin user
            setLoggedInUser({ id: 'admin1', name: 'Super Admin', role: 'Admin', roles: ['Admin', 'Planner', 'Supervisor', 'Store', 'PC', 'Technician', 'Chief Production', 'QC'], type: 'web' });
            navigate('web-admin-workflow'); // Navigate to the new admin workflow page
        }
        else {
            setError('Invalid username or password.');
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-purple-100 p-4">
            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
                <div className="flex justify-center mb-6">
                    <img src="https://img2.pic.in.th/pic/A-professional-and-modern-logo-design-for-a-maintenance-planning-software-called-PM-Sync.-The-logo.png" alt="PM Sync Logo" className="w-24 h-24" />
                </div>
                <h2 className="text-3xl font-bold text-center text-gray-800 mb-8">PM Sync</h2>
                {error && <p className="text-red-500 text-center mb-4">{error}</p>}
                <div className="mb-6">
                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
                        Username
                    </label>
                    <input
                        type="text"
                        id="username"
                        className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        placeholder="Enter your username"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                    />
                </div>
                <div className="mb-8">
                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                        Password
                    </label>
                    <input
                        type="password"
                        id="password"
                        className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        placeholder="********"
                        value={password}
                        onChange={(e) => e.target.value.length <= 20 && setPassword(e.target.value)}
                    />
                </div>
                <button
                    onClick={handleLogin}
                    className="w-full bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline shadow-lg transform transition-all duration-300 hover:scale-105"
                >
                    Login
                </button>
                <p className="text-center text-gray-600 text-sm mt-6">
                    <span className="font-semibold">Test Accounts:</span><br/>
                    Admin: `admin/pass`<br/>
                    Planner: `planner/pass`<br/>
                    Supervisor: `supervisor/pass`<br/>
                    Store: `store/pass`<br/>
                    PC: `pc/pass`<br/>
                    Technician: `technician/pass`<br/>
                    Chief Production: `chiefprod/pass`<br/>
                    QC: `qc/pass`
                </p>
            </div>
        </div>
    );
};

const WebDashboard = () => {
    const { navigate, jobs, machines } = useContext(AppContext);

    const openJobs = jobs.filter(job => job.status === 'Open').length;
    const pendingJobs = jobs.filter(job => job.status === 'Pending Approval' || job.status === 'In Progress').length;
    const jobsThisWeek = jobs.filter(job => {
        const today = new Date();
        const dueDate = new Date(job.dueDate);
        const diffTime = Math.abs(dueDate.getTime() - today.getTime());
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays <= 7 && job.status !== 'Closed';
    }).length;

    const partsShortForThisMonth = jobs.filter(job =>
        job.parts && job.parts.some(part => part.status === 'Not Ready')
    ).length;

    const machinesNotReadyForPM = jobs.filter(job => !job.pcConfirmed && job.status !== 'Closed').length;

    // Dummy data for Monthly PM Summary Chart
    const monthlyPmData = [
        { month: 'Jan', completed: 10, pending: 5 },
        { month: 'Feb', completed: 8, pending: 2 },
        { month: 'Mar', completed: 15, pending: 3 },
        { month: 'Apr', completed: 12, pending: 4 },
        { month: 'May', completed: 10, pending: 2 },
        { month: 'Jun', completed: 13, pending: 3 },
    ];

    const recentNotifications = [
        { id: 'JOB001', status: 'pending approval', time: '5 min ago' },
        { id: 'JOB003', status: 'parts shortage', time: '1 hour ago' },
        { id: 'MCH004', status: 'not ready for PM', time: '2 hours ago' },
        { id: 'JOB004', status: 'completed', time: '1 day ago' },
        { id: 'JOB002', status: 'in progress', time: '2 days ago' },
    ];

    // --- Gantt Chart Logic ---
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const jobsThisMonth = jobs.filter(job => {
        const jobDate = new Date(job.createdAt);
        return jobDate.getMonth() === currentMonth && jobDate.getFullYear() === currentYear;
    });

    const getStatusColor = (status) => {
        switch (status) {
            case 'In Progress': return 'bg-yellow-500';
            case 'Pending Approval': return 'bg-orange-500';
            case 'Closed': return 'bg-green-500';
            case 'Returned for Correction': return 'bg-red-500';
            default: return 'bg-blue-500'; // Open
        }
    };

    const GanttChart = () => (
        <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mt-8">
            <h3 className="text-xl font-semibold text-gray-800 mb-4">Job Schedule Gantt Chart (This Month)</h3>
            <div className="relative overflow-x-auto">
                {/* Timeline Header */}
                <div className="flex bg-gray-100 rounded-t-lg">
                    <div className="w-1/4 p-2 font-semibold text-gray-600 border-r">Job / Machine</div>
                    <div className="w-3/4 grid" style={{ gridTemplateColumns: `repeat(${daysInMonth}, minmax(0, 1fr))` }}>
                        {Array.from({ length: daysInMonth }, (_, i) => (
                            <div key={i} className="text-center text-xs p-1 border-r">{i + 1}</div>
                        ))}
                    </div>
                </div>

                {/* Chart Body */}
                <div className="divide-y">
                    {jobsThisMonth.length > 0 ? jobsThisMonth.map((job, index) => {
                        const startDate = new Date(job.createdAt);
                        const dueDate = new Date(job.dueDate);

                        // Clamp dates to the current month for display
                        const startDay = startDate.getMonth() === currentMonth ? startDate.getDate() : 1;
                        const dueDay = dueDate.getMonth() === currentMonth ? dueDate.getDate() : daysInMonth;

                        const duration = Math.max(1, dueDay - startDay + 1);
                        const left = (startDay - 1) / daysInMonth * 100;
                        const width = duration / daysInMonth * 100;

                        return (
                            <div key={job.id} className="flex items-center hover:bg-gray-50">
                                <div className="w-1/4 p-2 border-r truncate">
                                    <p className="font-semibold text-sm text-gray-800">{job.id}</p>
                                    <p className="text-xs text-gray-600">{job.machineName}</p>
                                </div>
                                <div className="w-3/4 relative h-10">
                                    <div
                                        className={`absolute h-6 rounded ${getStatusColor(job.status)} text-white flex items-center justify-center text-xs px-2 shadow-md top-1/2 -translate-y-1/2`}
                                        style={{ left: `${left}%`, width: `${width}%` }}
                                        title={`${job.id} (${job.status}): ${startDate.toLocaleDateString()} - ${dueDate.toLocaleDateString()}`}
                                    >
                                        <span className="truncate">{job.type}</span>
                                    </div>
                                </div>
                            </div>
                        );
                    }) : (
                        <div className="text-center p-4 text-gray-500">No jobs scheduled for this month.</div>
                    )}
                </div>
            </div>
        </div>
    );
    // --- End of Gantt Chart Logic ---


    return (
        <div className="flex-1 p-8 bg-gray-100">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">DASHBOARD</h1>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-semibold text-gray-800 mb-3">PM Job Overview</h3>
                    <p className="text-gray-600 text-lg">Open Jobs: <span className="font-bold text-blue-600">{openJobs}</span></p>
                    <p className="text-gray-600 text-lg">Pending Jobs: <span className="font-bold text-orange-600">{pendingJobs}</span></p>
                    <p className="text-gray-600 text-lg">Jobs This Week: <span className="font-bold text-purple-600">{jobsThisWeek}</span></p>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-semibold text-gray-800 mb-3">Parts Status (Store)</h3>
                    <p className="text-gray-600 text-lg">Parts Short for This Month's Plan: <span className="font-bold text-red-600">{partsShortForThisMonth} items</span></p>
                    <button
                        onClick={() => navigate('web-store-confirmation')}
                        className="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition duration-300"
                    >
                        View Details
                    </button>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-semibold text-gray-800 mb-3">Machine Readiness (PC)</h3>
                    <p className="text-gray-600 text-lg">Machines Not Ready for PM: <span className="font-bold text-red-600">{machinesNotReadyForPM} machines</span></p>
                    <button
                        onClick={() => navigate('web-pc-confirmation')}
                        className="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition duration-300"
                    >
                        View Details
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-semibold text-gray-800 mb-4">Monthly PM Summary</h3>
                    <div className="flex items-end justify-around h-48 border-b border-l border-gray-300 pb-2 pl-2">
                        {monthlyPmData.map((data, index) => (
                            <div key={index} className="flex flex-col items-center mx-2 h-full justify-end">
                                <div
                                    className="bg-blue-500 w-8 rounded-t-md"
                                    style={{ height: `${data.completed * 4}px` }}
                                    title={`Completed: ${data.completed}`}
                                ></div>
                                <div
                                    className="bg-orange-400 w-8 rounded-b-md"
                                    style={{ height: `${data.pending * 4}px` }}
                                    title={`Pending: ${data.pending}`}
                                ></div>
                                <span className="text-xs text-gray-600 mt-1">{data.month}</span>
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-center space-x-4 mt-4 text-sm text-gray-700">
                        <span className="flex items-center"><span className="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Completed</span>
                        <span className="flex items-center"><span className="w-3 h-3 bg-orange-400 rounded-full mr-2"></span>Pending</span>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 className="text-xl font-semibold text-gray-800 mb-4">Recent Notifications</h3>
                    <ul className="space-y-3 text-gray-700">
                        {recentNotifications.map((notification, index) => (
                            <li key={index} className="flex justify-between items-center">
                                <span className="flex items-center">
                                    <i className="fas fa-circle text-xs mr-2 text-blue-500"></i>
                                    <span className="font-semibold text-blue-600">{notification.id}</span> is {notification.status}.
                                </span>
                                <span className="text-sm text-gray-500">{notification.time}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
            
            {/* Add the Gantt Chart here */}
            <GanttChart />
        </div>
    );
};

const WebMachineRegisterList = () => {
    const { navigate, machines, db, userId } = useContext(AppContext);
    const [searchTerm, setSearchTerm] = useState('');
    const [isAddingNew, setIsAddingNew] = useState(false);
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    const filteredMachines = machines.filter(machine =>
        (machine.assetNo?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        machine.name?.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    const handleAddNewMachine = async (newMachineData) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const machinesCollectionRef = collection(db, `artifacts/${appId}/public/data/machines`);
            const newMachineDocRef = doc(machinesCollectionRef, newMachineData.id); // Use provided ID for new machine
            await setDoc(newMachineDocRef, { // Use setDoc to use the provided ID
                ...newMachineData,
                createdAt: new Date().toISOString(),
                createdBy: userId
            });

            // Also create/update a corresponding entry in machineRegisters
            const machineRegistersCollectionRef = collection(db, `artifacts/${appId}/public/data/machineRegisters`);
            const newRegisterDocRef = doc(machineRegistersCollectionRef, newMachineData.id);
            await setDoc(newRegisterDocRef, {
                machineId: newMachineData.id,
                lastMeterReading: 0, // Default for new machine
                lastServiceDate: newMachineData.lastPM || '',
                currentLocation: newMachineData.location || '',
                timestamp: new Date().toISOString(),
                recordedBy: userId,
            });


            setIsAddingNew(false);
            alert('Machine added successfully!');
        } catch (err) {
            console.error("Error adding machine:", err);
            setCurrentError("Failed to add machine. Please try again.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">Machine Register</h1>

            {loading && <p className="text-blue-500 text-center">Loading machines...</p>}
            {currentError && <p className="text-red-500 text-center">{currentError}</p>}

            <div className="flex justify-between items-center mb-6">
                <input
                    type="text"
                    placeholder="Search by Asset No. or Name..."
                    className="p-3 border border-gray-300 rounded-lg w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
                <button
                    onClick={() => setIsAddingNew(true)}
                    className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                >
                    + Add New Machine
                </button>
            </div>

            {isAddingNew && (
                <WebMachineRegisterDetail onSave={handleAddNewMachine} onCancel={() => setIsAddingNew(false)} />
            )}

            {!isAddingNew && (
                <div className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-100"><tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset No.</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next PM</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr></thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {filteredMachines.length > 0 ? (
                                filteredMachines.map(machine => (
                                    <tr key={machine.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{machine.assetNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{machine.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{machine.location}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{machine.nextPM || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                machine.status === 'Operational' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                            }`}>{machine.status}</span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button
                                                onClick={() => navigate('web-machine-detail', machine)}
                                                className="text-blue-600 hover:text-blue-900 transition duration-200"
                                            >View Details</button>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="6" className="px-6 py-4 text-center text-gray-500">No machines found.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

const WebMachineRegisterDetail = ({ onSave, onCancel }) => {
    const { navigate, selectedMachine, db, userId } = useContext(AppContext);
    const [formData, setFormData] = useState(selectedMachine || {
        id: '', assetNo: '', serialNo: '', name: '', type: '', location: '', lastPM: '', nextPM: '', status: 'Operational', // nextPM will be calculated
        pmConditions: [], // New field for PM conditions
    });
    const [currentError, setCurrentError] = useState(null);
    const [loading, setLoading] = useState(false);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handlePMConditionChange = (index, field, value) => {
        const newPmConditions = [...formData.pmConditions];
        newPmConditions[index] = { ...newPmConditions[index], [field]: value };
        setFormData({ ...formData, pmConditions: newPmConditions });
    };

    const addPMCondition = () => {
        setFormData({
            ...formData,
            pmConditions: [...formData.pmConditions, { task: '', frequency: '', lastValue: '', nextDue: '', parts: [] }] // Added parts array
        });
    };

    const removePMCondition = (index) => {
        const newPmConditions = formData.pmConditions.filter((_, i) => i !== index);
        setFormData({ ...formData, pmConditions: newPmConditions });
    };

    // New handlers for parts within PM conditions
    const handlePMConditionPartChange = (pmIndex, partIndex, field, value) => {
        const newPmConditions = [...formData.pmConditions];
        const newParts = [...newPmConditions[pmIndex].parts];
        newParts[partIndex] = { ...newParts[partIndex], [field]: value };
        newPmConditions[pmIndex].parts = newParts;
        setFormData({ ...formData, pmConditions: newPmConditions });
    };

    const addPartToPMCondition = (pmIndex) => {
        const newPmConditions = [...formData.pmConditions];
        newPmConditions[pmIndex].parts = [...newPmConditions[pmIndex].parts, { name: '', partNo: '', qtyNeeded: 1 }];
        setFormData({ ...formData, pmConditions: newPmConditions });
    };

    const removePartFromPMCondition = (pmIndex, partIndex) => {
        const newPmConditions = [...formData.pmConditions];
        newPmConditions[pmIndex].parts = newPmConditions[pmIndex].parts.filter((_, i) => i !== partIndex);
        setFormData({ ...formData, pmConditions: newPmConditions });
    };

    const handleSubmit = async () => {
        setLoading(true);
        setCurrentError(null);

        // Calculate nextPM based on lastPM and the first PM condition's frequency
        // For a more robust system, you might calculate the earliest next PM from all conditions
        const calculatedNextPM = formData.lastPM && formData.pmConditions.length > 0 && formData.pmConditions[0].frequency
            ? calculateNextPMDate(formData.lastPM, formData.pmConditions[0].frequency)
            : 'N/A'; // If no lastPM or no PM conditions, nextPM is N/A

        const dataToSave = {
            ...formData,
            nextPM: calculatedNextPM, // Store the calculated nextPM
            updatedAt: new Date().toISOString(),
            updatedBy: userId
        };

        try {
            if (selectedMachine) {
                // Update existing machine
                const machineDocRef = doc(db, `artifacts/${appId}/public/data/machines`, selectedMachine.id);
                await updateDoc(machineDocRef, dataToSave);

                // Update corresponding entry in machineRegisters with latest info
                const machineRegisterDocRef = doc(db, `artifacts/${appId}/public/data/machineRegisters`, selectedMachine.id);
                await setDoc(machineRegisterDocRef, {
                    machineId: selectedMachine.id,
                    lastMeterReading: dataToSave.lastMeterReading || 0, // Assuming lastMeterReading might be updated here
                    lastServiceDate: dataToSave.lastPM || '',
                    currentLocation: dataToSave.location || '',
                    timestamp: new Date().toISOString(),
                    recordedBy: userId,
                }, { merge: true }); // Use merge to update existing fields without overwriting the whole document

                alert('Machine updated successfully!');
            } else {
                // Add new machine (handled by onSave prop in parent)
                if (!formData.id) {
                    setCurrentError("Machine ID is required for new machines.");
                    setLoading(false);
                    return;
                }
                await onSave(dataToSave);
            }
            navigate('web-machine-register');
        } catch (err) {
            console.error("Error saving machine:", err);
            setCurrentError("Failed to save machine. Please try again.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="p-8 bg-white rounded-xl shadow-md border border-gray-200 mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">{selectedMachine ? 'Machine Details' : 'Add New Machine'}</h2>
            {loading && <p className="text-blue-500 text-center mb-4">Saving...</p>}
            {currentError && <p className="text-red-500 text-center mb-4">{currentError}</p>}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Machine ID</label>
                    <input type="text" name="id" value={formData.id} onChange={handleChange} className="form-input" disabled={!!selectedMachine} placeholder="e.g., MC-01-0003" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Asset No.</label>
                    <input type="text" name="assetNo" value={formData.assetNo} onChange={handleChange} className="form-input" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Serial No.</label>
                    <input type="text" name="serialNo" value={formData.serialNo} onChange={handleChange} className="form-input" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Name</label>
                    <input type="text" name="name" value={formData.name} onChange={handleChange} className="form-input" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Type</label>
                    <input type="text" name="type" value={formData.type} onChange={handleChange} className="form-input" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Location</label>
                    <input type="text" name="location" value={formData.location} onChange={handleChange} className="form-input" />
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Status</label>
                    <select name="status" value={formData.status} onChange={handleChange} className="form-input">
                        <option value="Operational">Operational</option>
                        <option value="Needs PM">Needs PM</option>
                    </select>
                </div>
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Last PM Date</label>
                    <input type="date" name="lastPM" value={formData.lastPM} onChange={handleChange} className="form-input" />
                </div>
                {/* Removed direct input for Next PM Date */}
                <div>
                    <label className="block text-gray-700 text-sm font-bold mb-2">Calculated Next PM Date</label>
                    <input type="text" value={formData.lastPM && formData.pmConditions.length > 0 && formData.pmConditions[0].frequency ? calculateNextPMDate(formData.lastPM, formData.pmConditions[0].frequency) : 'N/A'} className="form-input bg-gray-100 cursor-not-allowed" readOnly />
                </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">PM Conditions</h3>
            {formData.pmConditions.length === 0 && <p className="text-gray-500 mb-4">No PM conditions added yet.</p>}
            {formData.pmConditions.map((condition, pmIndex) => (
                <div key={pmIndex} className="mb-6 p-4 border rounded-lg bg-gray-50 shadow-sm">
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                        <div className="md:col-span-2">
                            <label className="block text-gray-700 text-sm font-bold mb-2">Task</label>
                            <input type="text" value={condition.task} onChange={(e) => handlePMConditionChange(pmIndex, 'task', e.target.value)} className="form-input" />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Frequency</label>
                            <input type="text" value={condition.frequency} onChange={(e) => handlePMConditionChange(pmIndex, 'frequency', e.target.value)} className="form-input" placeholder="e.g., Monthly, 1000 Hrs" />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Last Value</label>
                            <input type="text" value={condition.lastValue} onChange={(e) => handlePMConditionChange(pmIndex, 'lastValue', e.target.value)} className="form-input" placeholder="Date or Meter Reading" />
                        </div>
                        <div className="flex items-end">
                            <button onClick={() => removePMCondition(pmIndex)} className="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600">Remove Condition</button>
                        </div>
                    </div>

                    <h4 className="text-lg font-semibold text-gray-700 mb-3 ml-2">Parts for this PM Condition:</h4>
                    {condition.parts.length === 0 && <p className="text-gray-500 mb-3 ml-2">No parts specified for this condition.</p>}
                    {condition.parts.map((part, partIndex) => (
                        <div key={partIndex} className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-3 p-3 border rounded-lg bg-gray-100 ml-4">
                            <div className="md:col-span-2">
                                <label className="block text-gray-700 text-sm font-bold mb-2">Part Name</label>
                                <input type="text" value={part.name} onChange={(e) => handlePMConditionPartChange(pmIndex, partIndex, 'name', e.target.value)} className="form-input" />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Part No.</label>
                                <input type="text" value={part.partNo} onChange={(e) => handlePMConditionPartChange(pmIndex, partIndex, 'partNo', e.target.value)} className="form-input" />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Qty Needed</label>
                                <input type="number" value={part.qtyNeeded} onChange={(e) => handlePMConditionPartChange(pmIndex, partIndex, 'qtyNeeded', parseInt(e.target.value))} className="form-input" />
                            </div>
                            <div className="flex items-end">
                                <button onClick={() => removePartFromPMCondition(pmIndex, partIndex)} className="bg-red-400 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-500">Remove Part</button>
                            </div>
                        </div>
                    ))}
                    <button onClick={() => addPartToPMCondition(pmIndex)} className="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 mt-3 ml-2">Add Part to Condition</button>
                </div>
            ))}
            <button onClick={addPMCondition} className="bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-600 mt-4">Add New PM Condition</button>

            <div className="mt-8 flex justify-end space-x-4">
                <button
                    onClick={onCancel || (() => navigate('web-machine-register'))}
                    className="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg shadow-md hover:bg-gray-400 transition duration-300"
                >
                    Cancel
                </button>
                <button
                    onClick={handleSubmit}
                    className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                >
                    Save Machine
                </button>
            </div>
        </div>
    );
};

const WebJobManagementList = () => {
    const { navigate, jobs, db, userId, plans, machines } = useContext(AppContext);
    const [filterStatus, setFilterStatus] = useState('All');
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);
    const [machineRegistersCache, setMachineRegistersCache] = useState({});

    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    const suggestedJobs = plans.filter(plan =>
        plan.type === 'monthly' &&
        plan.status === 'Approved' &&
        plan.year === currentYear &&
        plan.month === currentMonth &&
        !plan.jobCreated
    );

    const filteredJobs = jobs.filter(job =>
        filterStatus === 'All' || job.status === filterStatus
    );

    const fetchLatestMachineRegister = async (machineId) => {
        if (machineRegistersCache[machineId]) {
            return machineRegistersCache[machineId];
        }
        try {
            const q = query(
                collection(db, `artifacts/${appId}/public/data/machineRegisters`),
                where('machineId', '==', machineId),
                orderBy('timestamp', 'desc'),
                limit(1)
            );
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const latestRegister = querySnapshot.docs[0].data();
                setMachineRegistersCache(prev => ({ ...prev, [machineId]: latestRegister }));
                return latestRegister;
            }
            return null;
        } catch (err) {
            console.error(`Error fetching machine register for ${machineId}:`, err);
            return null;
        }
    };

    useEffect(() => {
        const loadMachineRegistersForSuggestedJobs = async () => {
            for (const plan of suggestedJobs) {
                if (!machineRegistersCache[plan.machineId]) {
                    await fetchLatestMachineRegister(plan.machineId);
                }
            }
        };
        loadMachineRegistersForSuggestedJobs();
    }, [suggestedJobs]);

    const handleOpenJobFromMonthlyPlan = async (plan) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const machineRegisterData = await fetchLatestMachineRegister(plan.machineId);
            const machineDetails = machines.find(m => m.id === plan.machineId);

            if (!machineRegisterData || !machineDetails) {
                alert(`ไม่พบข้อมูลทะเบียนเครื่องจักรล่าสุดหรือรายละเอียดเครื่องจักรสำหรับ ${plan.machineName} ไม่สามารถสร้างงานได้`);
                setLoading(false);
                return;
            }

            const newJobId = await generateSingleNewJobId(db, appId);
            const newJobData = {
                id: newJobId,
                assetNo: plan.assetNo,
                machineName: plan.machineName,
                type: plan.planType,
                assignedTo: 'Unassigned',
                status: 'Open',
                dueDate: plan.scheduledDate,
                tasks: machineDetails.pmConditions?.map(cond => cond.task) || ['ตรวจสอบตามแผน PM'],
                parts: plan.requiredParts.map(part => ({ ...part, status: 'Pending' })),
                techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                technicianRemarks: '', qcRemarks: '', supervisorRemarks: '',
                pcConfirmed: false, storeConfirmed: false,
                monthlyPlanRefId: plan.id,
                meterReadingAtStart: machineRegisterData.lastMeterReading,
                prevServiceDate: machineRegisterData.lastServiceDate,
                currentLocationAtJobOpen: machineRegisterData.currentLocation,
                createdAt: new Date().toISOString(),
                createdBy: userId
            };

            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, newJobId);
            await setDoc(jobDocRef, newJobData);

            const planDocRef = doc(db, `artifacts/${appId}/public/data/plans`, plan.id);
            await updateDoc(planDocRef, {
                jobCreated: true,
                jobId: newJobId,
                status: 'Job Created'
            });

            alert(`เปิดงาน PM "${plan.planName}" สำเร็จแล้ว! เลขที่งาน: ${newJobId}`);
            navigate('web-job-detail', newJobData);
        } catch (err) {
            console.error("Error opening job from monthly plan:", err);
            setCurrentError("Failed to open job from monthly plan. Please try again.");
        } finally {
            setLoading(false);
        }
    };

    const handleOpenNewAdhocJob = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const newJobId = await generateSingleNewJobId(db, appId);
            const newJob = {
                id: newJobId,
                assetNo: 'ADHOC-MCH',
                machineName: 'งานซ่อมเร่งด่วน',
                type: 'Ad-hoc PM',
                assignedTo: 'Unassigned',
                status: 'Open',
                dueDate: new Date().toISOString().split('T')[0],
                tasks: ['ตรวจสอบและแก้ไขปัญหา'],
                parts: [],
                techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                technicianRemarks: '', qcRemarks: '', supervisorRemarks: '',
                pcConfirmed: false, storeConfirmed: false,
                monthlyPlanRefId: null,
                meterReadingAtStart: null,
                prevServiceDate: null,
                currentLocationAtJobOpen: null,
                createdAt: new Date().toISOString(),
                createdBy: userId
            };
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, newJobId);
            await setDoc(jobDocRef, newJob);
            alert(`เปิดงาน PM แบบ Ad-hoc สำเร็จ! เลขที่งาน: ${newJobId}`);
            navigate('web-job-detail', newJob);
        } catch (err) {
            console.error("Error opening new ad-hoc job:", err);
            setCurrentError("Failed to open new ad-hoc job. Please try again.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">Job Management</h1>

            {loading && <p className="text-blue-500 text-center">กำลังโหลดข้อมูล...</p>}
            {currentError && <p className="text-red-500 text-center">{currentError}</p>}

            <div className="mb-8 p-6 bg-blue-50 rounded-xl shadow-md border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-800 mb-4">งานที่แนะนำจากแผนประจำเดือนที่อนุมัติแล้ว</h2>
                {suggestedJobs.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {suggestedJobs.map(plan => (
                            <div key={plan.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">{plan.planName}</h3>
                                <p className="text-sm text-gray-700">เครื่องจักร: {plan.machineName} ({plan.assetNo})</p>
                                <p className="text-sm text-gray-700">ประเภท: {plan.planType}</p>
                                <p className="text-sm text-gray-700">กำหนดการ: {new Date(plan.scheduledDate).toLocaleDateString('th-TH')}</p>
                                <p className="text-sm text-gray-700 mb-3">สถานะแผน: <span className="font-semibold text-green-600">{plan.status}</span></p>

                                {machineRegistersCache[plan.machineId] && (
                                    <div className="text-xs text-gray-600 mb-3">
                                        <p>เลขมิเตอร์ล่าสุด: {machineRegistersCache[plan.machineId].lastMeterReading || 'N/A'}</p>
                                        <p>วันเซอร์วิสล่าสุด: {machineRegistersCache[plan.machineId].lastServiceDate || 'N/A'}</p>
                                        <p>ตำแหน่งปัจจุบัน: {machineRegistersCache[plan.machineId].currentLocation || 'N/A'}</p>
                                    </div>
                                )}

                                <button
                                    onClick={() => handleOpenJobFromMonthlyPlan(plan)}
                                    className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 mt-2"
                                    disabled={loading}
                                >
                                    เปิดงาน
                                </button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p className="text-gray-600">ไม่มีงานที่แนะนำจากแผนประจำเดือนที่อนุมัติแล้วในขณะนี้</p>
                )}
            </div>

            <h2 className="text-2xl font-bold text-gray-800 mb-4">รายการงานปัจจุบัน</h2>
            <div className="flex justify-between items-center mb-6">
                <div className="flex space-x-4">
                    <select
                        className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                        value={filterStatus}
                        onChange={(e) => setFilterStatus(e.target.value)}
                    >
                        <option value="All">สถานะทั้งหมด</option>
                        <option value="Open">เปิด</option>
                        <option value="In Progress">กำลังดำเนินการ</option>
                        <option value="Pending Approval">รอการอนุมัติ</option>
                        <option value="Closed">ปิดแล้ว</option>
                        <option value="Returned for Correction">ส่งคืนเพื่อแก้ไข</option>
                    </select>
                </div>
                <button
                    onClick={handleOpenNewAdhocJob}
                    className="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                >
                    + เปิดงาน PM แบบ Ad-hoc
                </button>
            </div>

            <div className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-100"><tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่งาน</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เครื่องจักร</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้รับผิดชอบ</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กำหนดส่ง</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลายเซ็น</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {filteredJobs.length > 0 ? (
                            filteredJobs.map(job => (
                                <tr key={job.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{job.id}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.machineName} ({job.assetNo})</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.assignedTo}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.dueDate}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            job.status === 'Closed' ? 'bg-green-100 text-green-800' :
                                            job.status === 'Pending Approval' ? 'bg-orange-100 text-orange-800' :
                                            job.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                                            job.status === 'Returned for Correction' ? 'bg-red-100 text-red-800' :
                                            'bg-blue-100 text-blue-800'
                                        }`}>{job.status}</span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                        {job.techSign ? 'T✅' : 'T❌'} {job.chiefProdSign ? 'P✅' : 'P❌'} {job.qcSign ? 'Q✅' : 'Q❌'}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button
                                            onClick={() => navigate('web-job-detail', job)}
                                            className="text-blue-600 hover:text-blue-900 transition duration-200"
                                        >ดูรายละเอียด</button>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" className="px-6 py-4 text-center text-gray-500">ไม่พบงาน</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const WebJobApprovalDetail = () => {
    const { navigate, selectedJob, db, userId } = useContext(AppContext);
    const [currentError, setCurrentError] = useState(null);
    const [loading, setLoading] = useState(false);

    if (!selectedJob) {
        return (
            <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
                <p className="text-gray-700">ไม่พบงานที่เลือก โปรดกลับไปที่หน้า Job Management</p>
                <button onClick={() => navigate('web-job-management')} className="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">กลับไปที่ Job List</button>
            </div>
        );
    }

    const handleApproveJob = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, selectedJob.id);
            await updateDoc(jobDocRef, {
                status: 'Closed',
                supervisorApproved: true,
                supervisorApprovedAt: new Date().toISOString(),
                supervisorApprovedBy: userId
            });
            alert('งานได้รับการอนุมัติและปิดเรียบร้อยแล้ว!');
            navigate('web-job-management');
        } catch (err) {
            console.error("Error approving job:", err);
            setCurrentError("ไม่สามารถอนุมัติงานได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const handleRejectJob = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, selectedJob.id);
            await updateDoc(jobDocRef, {
                status: 'Returned for Correction',
                supervisorApproved: false,
                supervisorRemarks: 'ต้องการการแก้ไข/ลายเซ็นเพิ่มเติม', // Placeholder for actual remarks
                updatedAt: new Date().toISOString(),
                updatedBy: userId
            });
            alert('งานถูกปฏิเสธและส่งกลับเพื่อแก้ไข');
            navigate('web-job-management');
        } catch (err) {
            console.error("Error rejecting job:", err);
            setCurrentError("ไม่สามารถปฏิเสธงานได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const allSigned = selectedJob.techSign && selectedJob.chiefProdSign && selectedJob.qcSign;
    const canApprove = allSigned && selectedJob.pcConfirmed && selectedJob.storeConfirmed;

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">รายละเอียดการอนุมัติงาน: {selectedJob.id}</h1>

            {loading && <p className="text-blue-500 text-center mb-4">กำลังดำเนินการ...</p>}
            {currentError && <p className="text-red-500 text-center mb-4">{currentError}</p>}

            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">ข้อมูลงาน</h2>
                <div className="grid grid-cols-2 gap-4 text-gray-700">
                    <p><span className="font-semibold">เครื่องจักร:</span> {selectedJob.machineName} ({selectedJob.assetNo})</p>
                    <p><span className="font-semibold">ประเภท:</span> {selectedJob.type}</p>
                    <p><span className="font-semibold">ผู้รับผิดชอบ:</span> {selectedJob.assignedTo}</p>
                    <p><span className="font-semibold">กำหนดส่ง:</span> {selectedJob.dueDate}</p>
                    <p><span className="font-semibold">สถานะปัจจุบัน:</span> <span className={`font-bold ${
                        selectedJob.status === 'Closed' ? 'text-green-600' :
                        selectedJob.status === 'Pending Approval' ? 'text-orange-600' :
                        selectedJob.status === 'Returned for Correction' ? 'text-red-600' :
                        'text-blue-600'
                    }`}>{selectedJob.status}</span></p>
                    {selectedJob.monthlyPlanRefId && <p><span className="font-semibold">อ้างอิงแผนรายเดือน:</span> {selectedJob.monthlyPlanRefId}</p>}
                    {selectedJob.meterReadingAtStart && <p><span className="font-semibold">เลขมิเตอร์เริ่มต้น:</span> {selectedJob.meterReadingAtStart}</p>}
                    {selectedJob.prevServiceDate && <p><span className="font-semibold">วันเซอร์วิสก่อนหน้า:</span> {selectedJob.prevServiceDate}</p>}
                    {selectedJob.currentLocationAtJobOpen && <p><span className="font-semibold">ตำแหน่งเมื่อเปิดงาน:</span> {selectedJob.currentLocationAtJobOpen}</p>}
                </div>

                <div className="mt-6">
                    <h3 className="text-xl font-semibold text-gray-800 mb-2">งานที่ดำเนินการ:</h3>
                    <ul className="list-disc list-inside text-gray-700">
                        {selectedJob.tasks.map((task, index) => <li key={index}>{task}</li>)}
                    </ul>
                </div>

                <div className="mt-6">
                    <h3 className="text-xl font-semibold text-gray-800 mb-2">อะไหล่ที่ใช้:</h3>
                    {selectedJob.parts && selectedJob.parts.length > 0 ? (
                        <ul className="list-disc list-inside text-gray-700">
                            {selectedJob.parts.map((part, index) => <li key={index}>{part.name} ({part.qty}) - สถานะ: {part.status || 'รอดำเนินการ'} {part.qtyShort > 0 ? `(ขาด: ${part.qtyShort})` : ''}</li>)}
                        </ul>
                    ) : (
                        <p className="text-gray-500">ไม่มีอะไหล่บันทึกไว้</p>
                    )}
                </div>

                <div className="mt-6">
                    <h3 className="text-xl font-semibold text-gray-800 mb-2">ข้อสังเกตของช่างเทคนิค:</h3>
                    <p className="text-gray-700 italic">{selectedJob.technicianRemarks || 'ไม่มีข้อสังเกต'}</p>
                </div>
            </div>

            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">สถานะการยืนยัน</h2>
                <div className="space-y-3 text-gray-700">
                    <p><span className="font-semibold">ลายเซ็นช่างเทคนิค:</span> {selectedJob.techSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>
                    <p><span className="font-semibold">ลายเซ็นหัวหน้าฝ่ายผลิต:</span> {selectedJob.chiefProdSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>
                    <p><span className="font-semibold">ลายเซ็นผู้ตรวจสอบ QC:</span> {selectedJob.qcSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>
                    {selectedJob.qcRemarks && (
                        <p><span className="font-semibold">ข้อสังเกต QC:</span> {selectedJob.qcRemarks}</p>
                    )}
                    <p><span className="font-semibold">การยืนยันจากคลัง (อะไหล่):</span> {selectedJob.storeConfirmed ? '✅ ยืนยันแล้ว' : '❌ ยังไม่ยืนยัน'}</p>
                    <p><span className="font-semibold">การยืนยันจาก PC (ความพร้อมใช้งาน):</span> {selectedJob.pcConfirmed ? '✅ ยืนยันแล้ว' : '❌ ยังไม่ยืนยัน'}</p>
                </div>
                {!canApprove && selectedJob.status !== 'Closed' && (
                    <p className="text-red-500 mt-4 font-semibold">ไม่สามารถอนุมัติงานได้จนกว่าจะครบทุกรายเซ็นและการยืนยัน</p>
                )}
            </div>

            <div className="mt-8 flex justify-end space-x-4">
                <button
                    onClick={() => navigate('web-job-management')}
                    className="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg shadow-md hover:bg-gray-400 transition duration-300"
                >
                    กลับไปที่ Job List
                </button>
                {selectedJob.status !== 'Closed' && (
                    <button
                        onClick={handleRejectJob}
                        className="bg-red-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-red-700 transition duration-300"
                        disabled={loading}
                    >
                        ปฏิเสธงาน
                    </button>
                )}
                {canApprove && selectedJob.status !== 'Closed' && (
                    <button
                        onClick={handleApproveJob}
                        className="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                        disabled={loading}
                    >
                        อนุมัติและปิดงาน
                    </button>
                )}
            </div>
        </div>
    );
};

const WebStoreConfirmation = () => {
    const { jobs, db, userId } = useContext(AppContext);
    const [filterStatus, setFilterStatus] = useState('All');
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    const jobsNeedingPartsCheck = jobs.filter(job =>
        job.status !== 'Closed' && job.parts && job.parts.length > 0 && job.parts.some(part => part.status === 'Pending' || part.status === 'Not Ready')
    );

    const handlePartStatusChange = async (jobId, partName, status) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, jobId);
            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (jobToUpdate) {
                let qtyShort = 0;
                if (status === 'Not Ready') {
                    const promptValue = prompt(`ป้อนจำนวนที่ขาดสำหรับ '${partName}' ในงาน ${jobId}:`);
                    qtyShort = parseInt(promptValue);
                    if (isNaN(qtyShort) || qtyShort < 0) {
                        alert('จำนวนไม่ถูกต้อง โปรดป้อนตัวเลขที่ไม่ติดลบ');
                        setLoading(false);
                        return;
                    }
                }

                const updatedParts = jobToUpdate.parts.map(part =>
                    part.name === partName ? { ...part, status: status, qtyShort: status === 'Not Ready' ? qtyShort : 0 } : part
                );
                // Check if all parts are now ready for this job
                const allPartsReady = updatedParts.every(part => part.status === 'Ready');

                await updateDoc(jobDocRef, {
                    parts: updatedParts,
                    storeConfirmed: allPartsReady, // Update overall store confirmation status
                    updatedAt: new Date().toISOString(),
                    updatedBy: userId
                });
                alert(`อะไหล่ '${partName}' สำหรับงาน ${jobId} ถูกทำเครื่องหมายเป็น ${status} แล้ว!`);
            }
        } catch (err) {
            console.error("Error updating part status:", err);
            setCurrentError("ไม่สามารถอัปเดตสถานะอะไหล่ได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const filteredJobs = jobsNeedingPartsCheck.filter(job => {
        if (filterStatus === 'All') return true;
        if (filterStatus === 'Ready') return job.storeConfirmed;
        if (filterStatus === 'Not Ready') return !job.storeConfirmed;
        return true;
    });

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">การยืนยันจากคลัง (แผนรายเดือน)</h1>

            {loading && <p className="text-blue-500 text-center">กำลังอัปเดตสถานะอะไหล่...</p>}
            {currentError && <p className="text-red-500 text-center">{currentError}</p>}

            <div className="mb-6">
                <select
                    className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                >
                    <option value="All">สถานะทั้งหมด</option>
                    <option value="Ready">พร้อม</option>
                    <option value="Not Ready">ไม่พร้อม</option>
                </select>
            </div>

            <div className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-100"><tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่งาน</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เครื่องจักร</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่ออะไหล่</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนที่ต้องการ</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะสต็อก</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {filteredJobs.length > 0 ? (
                            filteredJobs.map(job => (
                                job.parts.map((part, idx) => (
                                    <tr key={`${job.id}-${part.name}`}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{job.id}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.machineName}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{part.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{part.qty}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                part.status === 'Ready' ? 'bg-green-100 text-green-800' :
                                                part.status === 'Not Ready' ? 'bg-red-100 text-red-800' :
                                                'bg-gray-100 text-gray-800'
                                            }`}>{part.status || 'รอดำเนินการ'}</span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button
                                                onClick={() => handlePartStatusChange(job.id, part.name, 'Ready')}
                                                className="text-green-600 hover:text-green-900 transition duration-200 mr-2"
                                            >ทำเครื่องหมายว่าพร้อม</button>
                                            <button
                                                onClick={() => handlePartStatusChange(job.id, part.name, 'Not Ready')}
                                                className="text-red-600 hover:text-red-900 transition duration-200"
                                            >ทำเครื่องหมายว่าไม่พร้อม</button>
                                        </td>
                                    </tr>
                                ))
                            ))
                        ) : (
                            <tr>
                                <td colSpan="6" className="px-6 py-4 text-center text-gray-500">ไม่มีงานที่ต้องยืนยันอะไหล่</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const WebStorePartsSummary = () => {
    const { jobs } = useContext(AppContext);

    // Aggregate parts from all open/in-progress/pending jobs
    const aggregatedParts = jobs.reduce((acc, job) => {
        if (job.status !== 'Closed' && job.parts) {
            job.parts.forEach(part => {
                if (!acc[part.name]) {
                    acc[part.name] = { totalNeeded: 0, ready: 0, notReady: 0, pending: 0, totalQtyShort: 0 }; // Added totalQtyShort
                }
                acc[part.name].totalNeeded += part.qty;
                if (part.status === 'Ready') {
                    acc[part.name].ready += part.qty;
                } else if (part.status === 'Not Ready') {
                    acc[part.name].notReady += part.qty;
                    acc[part.name].totalQtyShort += (part.qtyShort || 0); // Sum up qtyShort
                } else {
                    acc[part.name].pending += part.qty;
                }
            });
        }
        return acc;
    }, {});

    const getAvailabilityStatus = (partSummary) => {
        if (partSummary.totalNeeded === 0) return 'N/A';
        if (partSummary.ready === partSummary.totalNeeded) return 'พร้อมทั้งหมด';
        if (partSummary.notReady > 0) return 'ไม่พร้อมบางส่วน';
        if (partSummary.pending > 0) return 'รอยืนยัน';
        return 'ไม่ทราบ';
    };

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">คลัง: รายงานสรุปอะไหล่</h1>

            <div className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-100"><tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่ออะไหล่</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนที่ต้องการทั้งหมด</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนพร้อม</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนไม่พร้อม</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนรอดำเนินการ</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนขาด</th> {/* New column */}
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะความพร้อมใช้งาน</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {Object.keys(aggregatedParts).length > 0 ? (
                            Object.entries(aggregatedParts).map(([partName, summary]) => (
                                <tr key={partName}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{partName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{summary.totalNeeded}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{summary.ready}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{summary.notReady}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{summary.pending}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{summary.totalQtyShort}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            getAvailabilityStatus(summary) === 'พร้อมทั้งหมด' ? 'bg-green-100 text-green-800' :
                                            getAvailabilityStatus(summary) === 'ไม่พร้อมบางส่วน' ? 'bg-red-100 text-red-800' :
                                            'bg-orange-100 text-orange-800'
                                        }`}>{getAvailabilityStatus(summary)}</span>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="7" className="px-6 py-4 text-center text-gray-500">ไม่มีอะไหล่ที่ต้องการสำหรับงานที่กำลังดำเนินการ</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};


const WebPCConfirmation = () => {
    const { jobs, db, userId } = useContext(AppContext);
    const [filterStatus, setFilterStatus] = useState('All');
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    const jobsNeedingPCConfirmation = jobs.filter(job => job.status !== 'Closed' && !job.pcConfirmed);

    const handleMachineAvailabilityChange = async (jobId, status) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, jobId);
            await updateDoc(jobDocRef, {
                pcConfirmed: status === 'Available' ? true : false,
                updatedAt: new Date().toISOString(),
                updatedBy: userId
            });
            alert(`เครื่องจักรสำหรับงาน ${jobId} ถูกทำเครื่องหมายเป็น ${status} แล้ว!`);
        } catch (err) {
            console.error("Error updating machine availability:", err);
            setCurrentError("ไม่สามารถอัปเดตความพร้อมใช้งานของเครื่องจักรได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const filteredJobs = jobsNeedingPCConfirmation.filter(job => {
        if (filterStatus === 'All') return true;
        if (filterStatus === 'Available') return job.pcConfirmed;
        if (filterStatus === 'Not Available') return !job.pcConfirmed;
        return true;
    });

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">การยืนยันจาก PC (แผนรายเดือน)</h1>

            {loading && <p className="text-blue-500 text-center">กำลังอัปเดตความพร้อมใช้งาน...</p>}
            {currentError && <p className="text-red-500 text-center">{currentError}</p>}

            <div className="mb-6">
                <select
                    className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                >
                    <option value="All">สถานะทั้งหมด</option>
                    <option value="Available">พร้อมใช้งาน</option>
                    <option value="Not Available">ไม่พร้อมใช้งาน</option>
                </select>
            </div>

            <div className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-100"><tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่งาน</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เครื่องจักร</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กำหนดส่ง</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ความพร้อมใช้งาน</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {filteredJobs.length > 0 ? (
                            filteredJobs.map(job => (
                                <tr key={job.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{job.id}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.machineName} ({job.assetNo})</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{job.dueDate}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            job.pcConfirmed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }`}>{job.pcConfirmed ? 'พร้อมใช้งาน' : 'ไม่พร้อมใช้งาน'}</span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button
                                            onClick={() => handleMachineAvailabilityChange(job.id, 'Available')}
                                            className="text-green-600 hover:text-green-900 transition duration-200 mr-2"
                                        >ทำเครื่องหมายว่าพร้อม</button>
                                        <button
                                            onClick={() => handleMachineAvailabilityChange(job.id, 'Not Available')}
                                            className="text-red-600 hover:text-red-900 transition duration-200"
                                        >ทำเครื่องหมายว่าไม่พร้อม</button>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="5" className="px-6 py-4 text-center text-gray-500">ไม่มีงานที่ต้องยืนยันจาก PC</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const WebReports = () => {
    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">รายงานและวิเคราะห์</h1>
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p className="text-gray-700">ส่วนนี้จะประกอบด้วยรายงานต่างๆ เช่น:</p>
                <ul className="list-disc list-inside mt-4 text-gray-700 space-y-2">
                    <li>รายงานประวัติเครื่องจักร</li>
                    <li>รายงานการใช้อะไหล่</li>
                    <li>รายงานค่าใช้จ่ายในการบำรุงรักษา</li>
                    <li>รายงานประสิทธิภาพ PM (เช่น อัตราการดำเนินการเสร็จสิ้น)</li>
                </ul>
                <p className="mt-4 text-gray-500 italic">
                    (ใน Prototype นี้ การสร้างรายงานโดยละเอียดจะยังไม่ถูกนำมาใช้ แต่หน้านี้ทำหน้าที่เป็น Placeholder)
                </p>
            </div>
        </div>
    );
};

const WebMonthlyPlan = () => {
    const { machines, plans, db, userId } = useContext(AppContext);
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1; // 1-indexed
    const masterPlan = plans.find(p => p.id === 'master-plan');
    const monthlyPlan = plans.find(p => p.id === `monthly-plan-${currentYear}-${currentMonth}`);
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    const handleGenerateMasterPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const planData = machines.map(machine => {
                // Simulate AI logic: if machine has PM conditions, schedule quarterly PM
                const hasPMConditions = machine.pmConditions && machine.pmConditions.length > 0;
                const months = hasPMConditions ? ['Jan', 'Apr', 'Jul', 'Oct'] : [];
                return { machineId: machine.id, machineName: machine.name, assetNo: machine.assetNo, months: months };
            });

            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, 'master-plan');
            await setDoc(docRef, {
                type: 'master',
                year: currentYear,
                planData: planData,
                status: 'Pending',
                generatedDate: new Date().toISOString(),
                createdBy: userId
            });
            alert('แผนหลักถูกสร้างสำเร็จแล้ว! โปรดตรวจสอบและอนุมัติ');
        } catch (err) {
            console.error("Error generating master plan:", err);
            setCurrentError("ไม่สามารถสร้างแผนหลักได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const handleApproveMasterPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!masterPlan) {
            setCurrentError("ไม่มีแผนหลักที่ต้องอนุมัติ");
            setLoading(false);
            return;
        }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, 'master-plan');
            await updateDoc(docRef, {
                status: 'Approved',
                approvedDate: new Date().toISOString(),
                approvedBy: userId
            });
            alert('แผนหลักได้รับการอนุมัติแล้ว!');
        } catch (err) {
            console.error("Error approving master plan:", err);
            setCurrentError("ไม่สามารถอนุมัติแผนหลักได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const handleGenerateMonthlyPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!masterPlan || masterPlan.status !== 'Approved') {
            setCurrentError("ต้องอนุมัติแผนหลักก่อนจึงจะสร้างแผนรายเดือนได้");
            setLoading(false);
            return;
        }
        try {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonthName = monthNames[currentMonth - 1];

            const monthlyJobsData = masterPlan.planData
                .filter(machinePlan => machinePlan.months.includes(currentMonthName))
                .map(machinePlan => {
                    const machine = machines.find(m => m.id === machinePlan.machineId);
                    const aggregatedParts = {};
                    if (machine && machine.pmConditions) {
                        machine.pmConditions.forEach(condition => {
                            if (condition.parts) {
                                condition.parts.forEach(part => {
                                    if (aggregatedParts[part.name]) {
                                        aggregatedParts[part.name].qty += part.qtyNeeded;
                                    } else {
                                        aggregatedParts[part.name] = { ...part, qty: part.qtyNeeded, status: 'Pending' };
                                    }
                                });
                            }
                        });
                    }

                    return {
                        machineId: machinePlan.machineId,
                        assetNo: machinePlan.assetNo,
                        machineName: machinePlan.machineName,
                        type: 'Monthly PM',
                        dueDate: `${currentYear}-${String(currentMonth).padStart(2, '0')}-15`,
                        tasks: machine?.pmConditions?.map(cond => cond.task) || ['ตรวจสอบ PM ทั่วไป'],
                        parts: Object.values(aggregatedParts),
                        assignedTo: 'Unassigned',
                        techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                        technicianRemarks: '', qcRemarks: '', supervisorRemarks: '',
                        pcConfirmed: false, storeConfirmed: false,
                    };
                });

            const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const newJobIds = [];
            let lastJobNumber = await getTodaysLastJobNumber(db, appId);

            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const prefix = `PM${year}${month}${day}`;

            for (const jobData of monthlyJobsData) {
                lastJobNumber++;
                const newJobId = `${prefix}${String(lastJobNumber).padStart(3, '0')}`;
                const jobDataWithId = { ...jobData, id: newJobId, createdAt: new Date().toISOString(), createdBy: userId };
                
                const jobDocRef = doc(jobsCollectionRef, newJobId);
                await setDoc(jobDocRef, jobDataWithId);
                newJobIds.push(newJobId);
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, `monthly-plan-${currentYear}-${currentMonth}`);
            await setDoc(docRef, {
                type: 'monthly',
                year: currentYear,
                month: currentMonth,
                planData: monthlyJobsData.map((job, index) => ({ jobId: newJobIds[index], machineId: job.machineId, dueDate: job.dueDate })),
                status: 'Pending',
                generatedDate: new Date().toISOString(),
                createdBy: userId
            });
            alert('แผนรายเดือนถูกสร้างและงานที่เกี่ยวข้องถูกสร้างแล้ว! โปรดตรวจสอบและอนุมัติ');
        } catch (err) {
            console.error("Error generating monthly plan:", err);
            setCurrentError("ไม่สามารถสร้างแผนรายเดือนได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    const handleApproveMonthlyPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!monthlyPlan) {
            setCurrentError("ไม่มีแผนรายเดือนที่ต้องอนุมัติ");
            setLoading(false);
            return;
        }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, `monthly-plan-${currentYear}-${currentMonth}`);
            await updateDoc(docRef, {
                status: 'Approved',
                approvedDate: new Date().toISOString(),
                approvedBy: userId
            });
            alert('แผนรายเดือนได้รับการอนุมัติและส่งไปยังแผนกที่เกี่ยวข้องแล้ว!');
        } catch (err) {
            console.error("Error approving monthly plan:", err);
            setCurrentError("ไม่สามารถอนุมัติแผนรายเดือนได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">การจัดการแผนรายเดือน</h1>

            {loading && <p className="text-blue-500 text-center mb-4">กำลังดำเนินการแผน...</p>}
            {currentError && <p className="text-red-500 text-center mb-4">{currentError}</p>}

            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">แผนหลัก ({currentYear})</h2>
                <p className="text-gray-700 mb-4">สถานะ: <span className={`font-semibold ${masterPlan?.status === 'Approved' ? 'text-green-600' : 'text-orange-600'}`}>{masterPlan?.status || 'ยังไม่ถูกสร้าง'}</span></p>
                <div className="flex space-x-4">
                    <button
                        onClick={handleGenerateMasterPlan}
                        className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300"
                        disabled={loading}
                    >
                        สร้างแผนหลัก (AI)
                    </button>
                    {masterPlan && masterPlan.status === 'Pending' && (
                        <button
                            onClick={handleApproveMasterPlan}
                            className="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300"
                            disabled={loading}
                        >
                            อนุมัติแผนหลัก
                        </button>
                    )}
                </div>
                {masterPlan && masterPlan.planData && (
                    <div className="mt-6">
                        <h3 className="text-xl font-semibold mb-2">ตัวอย่างแผนหลัก:</h3>
                        <div className="max-h-60 overflow-y-auto border rounded-lg p-2">
                            {masterPlan.planData.map((mp, idx) => (
                                <p key={idx} className="text-sm text-gray-700">{mp.machineName} ({mp.assetNo}): PM ใน {mp.months.join(', ')}</p>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">แผนรายเดือน ({currentMonth}/{currentYear})</h2>
                <p className="text-gray-700 mb-4">สถานะ: <span className={`font-semibold ${monthlyPlan?.status === 'Approved' ? 'text-green-600' : 'text-orange-600'}`}>{monthlyPlan?.status || 'ยังไม่ถูกสร้าง'}</span></p>
                <div className="flex space-x-4">
                    <button
                        onClick={handleGenerateMonthlyPlan}
                        className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300"
                        disabled={loading || !masterPlan || masterPlan.status !== 'Approved'}
                    >
                        สร้างแผนรายเดือน (AI)
                    </button>
                    {monthlyPlan && monthlyPlan.status === 'Pending' && (
                        <button
                            onClick={handleApproveMonthlyPlan}
                            className="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300"
                            disabled={loading}
                        >
                            อนุมัติแผนรายเดือน
                        </button>
                    )}
                </div>
                {monthlyPlan && monthlyPlan.planData && (
                    <div className="mt-6">
                        <h3 className="text-xl font-semibold mb-2">ตัวอย่างแผนรายเดือน:</h3>
                        <div className="max-h-60 overflow-y-auto border rounded-lg p-2">
                            {monthlyPlan.planData.map((mp, idx) => (
                                <p key={idx} className="text-sm text-gray-700">Job {mp.jobId} for {mp.machineName} on {mp.dueDate}</p>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// Placeholder for User Management page
const WebUserManagement = () => {
    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">การจัดการผู้ใช้</h1>
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p className="text-gray-700">หน้านี้จะช่วยให้ผู้ดูแลระบบสามารถจัดการบัญชีผู้ใช้และบทบาทได้</p>
                <p className="mt-4 text-gray-500 italic">
                    (ฟังก์ชันการจัดการผู้ใช้ยังไม่ถูกนำมาใช้ใน Prototype นี้)
                </p>
            </div>
        </div>
    );
};

// Placeholder for Settings page
const WebSettings = () => {
    return (
        <div className="flex-1 p-8 bg-gray-50 rounded-lg shadow-inner m-4">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">การตั้งค่า</h1>
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p className="text-gray-700">หน้านี้จะมีการตั้งค่าและกำหนดค่าระบบต่างๆ</p>
                <p className="mt-4 text-gray-500 italic">
                    (ฟังก์ชันการตั้งค่ายังไม่ถูกนำมาใช้ใน Prototype นี้)
                </p>
            </div>
        </div>
    );
};

// --- NEW ADMIN WORKFLOW DASHBOARD ---
const WebAdminWorkflow = () => {
    const { machines, jobs, plans, db, userId } = useContext(AppContext);
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    const masterPlan = plans.find(p => p.id === 'master-plan');
    const monthlyPlan = plans.find(p => p.id === `monthly-plan-${currentYear}-${currentMonth}`);

    const handleGenerateMasterPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const planData = machines.map(machine => {
                const hasPMConditions = machine.pmConditions && machine.pmConditions.length > 0;
                const months = hasPMConditions ? ['Jan', 'Apr', 'Jul', 'Oct'] : [];
                return { machineId: machine.id, machineName: machine.name, assetNo: machine.assetNo, months: months };
            });
            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, 'master-plan');
            await setDoc(docRef, { type: 'master', year: currentYear, planData: planData, status: 'Pending', generatedDate: new Date().toISOString(), generatedBy: userId });
            alert('แผนหลักถูกสร้างแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถสร้างแผนหลักได้"); } finally { setLoading(false); }
    };

    const handleApproveMasterPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!masterPlan || masterPlan.status !== 'Pending') { setCurrentError("ไม่มีแผนหลักที่รอดำเนินการ"); setLoading(false); return; }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, 'master-plan');
            await updateDoc(docRef, { status: 'Approved', approvedDate: new Date().toISOString(), approvedBy: userId });
            alert('แผนหลักได้รับการอนุมัติแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถอนุมัติแผนหลักได้"); } finally { setLoading(false); }
    };

    const handleGenerateMonthlyPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!masterPlan || masterPlan.status !== 'Approved') { setCurrentError("ต้องอนุมัติแผนหลักก่อน"); setLoading(false); return; }
        try {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonthName = monthNames[currentMonth - 1];
            const monthlyJobsData = masterPlan.planData
                .filter(mp => mp.months.includes(currentMonthName))
                .map(mp => {
                    const machine = machines.find(m => m.id === mp.machineId);
                    const aggregatedParts = {};
                    if (machine && machine.pmConditions) {
                        machine.pmConditions.forEach(condition => {
                            if (condition.parts) {
                                condition.parts.forEach(part => {
                                    if (aggregatedParts[part.name]) {
                                        aggregatedParts[part.name].qty += part.qtyNeeded;
                                    } else {
                                        aggregatedParts[part.name] = { ...part, qty: part.qtyNeeded, status: 'Pending' };
                                    }
                                });
                            }
                        });
                    }

                    return {
                        machineId: mp.machineId, assetNo: mp.assetNo, machineName: mp.machineName, type: 'Monthly PM',
                        dueDate: `${currentYear}-${String(currentMonth).padStart(2, '0')}-15`,
                        tasks: machine?.pmConditions?.map(cond => cond.task) || ['ตรวจสอบ PM ทั่วไป'],
                        parts: Object.values(aggregatedParts),
                        assignedTo: 'Unassigned', techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                        technicianRemarks: '', qcRemarks: '', supervisorRemarks: '', pcConfirmed: false, storeConfirmed: false,
                        createdBy: userId
                    };
                });
            const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const newJobIds = [];
            let lastJobNumber = await getTodaysLastJobNumber(db, appId);

            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const prefix = `PM${year}${month}${day}`;

            for (const jobData of monthlyJobsData) {
                lastJobNumber++;
                const newJobId = `${prefix}${String(lastJobNumber).padStart(3, '0')}`;
                const jobDataWithId = { ...jobData, id: newJobId, createdAt: new Date().toISOString() };
                const jobDocRef = doc(jobsCollectionRef, newJobId);
                await setDoc(jobDocRef, jobDataWithId);
                newJobIds.push(newJobId);
            }
            const monthlyPlanDocRef = doc(db, `artifacts/${appId}/public/data/plans`, `monthly-plan-${currentYear}-${currentMonth}`);
            await setDoc(monthlyPlanDocRef, { type: 'monthly', year: currentYear, month: currentMonth, planData: monthlyJobsData.map((job, idx) => ({ jobId: newJobIds[idx], machineId: job.machineId, dueDate: job.dueDate })), status: 'Pending', generatedDate: new Date().toISOString(), createdBy: userId });
            alert('แผนรายเดือนถูกสร้างและงานถูกสร้างแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถสร้างแผนรายเดือนได้"); } finally { setLoading(false); }
    };

    const handleApproveMonthlyPlan = async () => {
        setLoading(true);
        setCurrentError(null);
        if (!monthlyPlan || monthlyPlan.status !== 'Pending') { setCurrentError("ไม่มีแผนรายเดือนที่รอดำเนินการ"); setLoading(false); return; }
        try {
            const docRef = doc(db, `artifacts/${appId}/public/data/plans`, `monthly-plan-${currentYear}-${currentMonth}`);
            await updateDoc(docRef, { status: 'Approved', approvedDate: new Date().toISOString(), approvedBy: userId });
            alert('แผนรายเดือนได้รับการอนุมัติแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถอนุมัติแผนรายเดือนได้"); } finally { setLoading(false); }
    };

    const handleConfirmAllStoreParts = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobsToUpdate = jobs.filter(job => job.status !== 'Closed' && job.parts && job.parts.some(p => p.status !== 'Ready'));
            for (const job of jobsToUpdate) {
                const updatedParts = job.parts.map(p => ({ ...p, status: 'Ready', qtyShort: 0 })); // Set qtyShort to 0 when ready
                const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, job.id);
                await updateDoc(jobDocRef, { parts: updatedParts, storeConfirmed: true, updatedAt: new Date().toISOString(), updatedBy: userId });
            }
            alert('ยืนยันอะไหล่คลังที่รอดำเนินการทั้งหมดแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถยืนยันอะไหล่คลังได้"); } finally { setLoading(false); }
    };

    const handleConfirmAllPCAvailability = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobsToUpdate = jobs.filter(job => job.status !== 'Closed' && !job.pcConfirmed);
            for (const job of jobsToUpdate) {
                const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, job.id);
                await updateDoc(jobDocRef, { pcConfirmed: true, updatedAt: new Date().toISOString(), updatedBy: userId });
            }
            alert('ยืนยันความพร้อมใช้งานของ PC ที่รอดำเนินการทั้งหมดแล้ว!');
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถยืนยันความพร้อมใช้งานของ PC ได้"); } finally { setLoading(false); }
    };

    const handleOpenNewAdhocJob = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const newJobId = await generateSingleNewJobId(db, appId);
            const newJob = {
                id: newJobId,
                assetNo: 'ADHOC-MCH', machineName: 'งานซ่อมเร่งด่วน', type: 'Ad-hoc PM',
                assignedTo: 'Technician 1', status: 'Open', dueDate: new Date().toISOString().split('T')[0],
                tasks: ['ตรวจสอบและแก้ไขปัญหา'], parts: [], techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                technicianRemarks: '', qcRemarks: '', supervisorRemarks: '', pcConfirmed: false, storeConfirmed: false,
                createdAt: new Date().toISOString(), createdBy: userId
            };
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, newJobId);
            await setDoc(jobDocRef, newJob);
            alert(`สร้างงาน Ad-hoc ใหม่แล้ว! เลขที่งาน: ${newJobId}`);
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถเปิดงาน Ad-hoc ได้"); } finally { setLoading(false); }
    };

    const handleForceSign = async (jobId, signatureType) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, jobId);
            let updateData = { updatedAt: new Date().toISOString(), updatedBy: userId };
            if (signatureType === 'tech') updateData.techSign = true;
            if (signatureType === 'chiefProd') updateData.chiefProdSign = true;
            if (signatureType === 'qc') updateData.qcSign = true;
            if (signatureType === 'supervisor') updateData.supervisorApproved = true;

            // Also update status for technician sign
            if (signatureType === 'tech' && jobs.find(j => j.id === jobId)?.status === 'Open') {
                updateData.status = 'In Progress';
            }
            // For supervisor approval, if all conditions met, set to Closed
            if (signatureType === 'supervisor') {
                const job = jobs.find(j => j.id === jobId);
                // Ensure all previous conditions are met before forcing supervisor approval to 'Closed'
                if (job.techSign && job.chiefProdSign && job.qcSign && job.storeConfirmed && job.pcConfirmed) {
                    updateData.status = 'Closed';
                }
            }

            await updateDoc(jobDocRef, updateData);
            alert(`${signatureType.toUpperCase()} ลายเซ็น/การอนุมัติถูกบังคับสำหรับงาน ${jobId} แล้ว!`);
        } catch (err) { console.error("Error:", err); setCurrentError(`ไม่สามารถบังคับลายเซ็น/การอนุมัติ ${signatureType} ได้`); } finally { setLoading(false); }
    };

    const handleResetJob = async (jobId) => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, jobId);
            await updateDoc(jobDocRef, {
                status: 'Open',
                techSign: false, chiefProdSign: false, qcSign: false, supervisorApproved: false,
                technicianRemarks: '', qcRemarks: '', supervisorRemarks: '', pcConfirmed: false, storeConfirmed: false,
                updatedAt: new Date().toISOString(), updatedBy: userId
            });
            alert(`งาน ${jobId} ถูกรีเซ็ตเป็นสถานะเปิดแล้ว!`);
        } catch (err) { console.error("Error:", err); setCurrentError("ไม่สามารถรีเซ็ตงานได้"); } finally { setLoading(false); }
    };

    return (
        <div className="flex-1 p-8 bg-gray-100">
            <h1 className="text-3xl font-bold text-gray-800 mb-8">แผงควบคุมการทำงานของผู้ดูแลระบบ</h1>

            {loading && <p className="text-blue-500 text-center mb-4">กำลังดำเนินการ...</p>}
            {currentError && <p className="text-red-500 text-center mb-4">{currentError}</p>}

            {/* Plan Management Section */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">การจัดการแผน</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 className="text-xl font-semibold text-gray-700 mb-2">แผนหลัก ({currentYear})</h3>
                        <p className="mb-2">สถานะ: <span className={`font-semibold ${masterPlan?.status === 'Approved' ? 'text-green-600' : 'text-orange-600'}`}>{masterPlan?.status || 'ยังไม่ถูกสร้าง'}</span></p>
                        <button onClick={handleGenerateMasterPlan} className="bg-blue-600 text-white px-4 py-2 rounded-lg mr-2 hover:bg-blue-700">สร้างแผนหลัก</button>
                        {masterPlan?.status === 'Pending' && <button onClick={handleApproveMasterPlan} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">อนุมัติแผนหลัก</button>}
                    </div>
                    <div>
                        <h3 className="text-xl font-semibold text-gray-700 mb-2">แผนรายเดือน ({currentMonth}/{currentYear})</h3>
                        <p className="mb-2">สถานะ: <span className={`font-semibold ${monthlyPlan?.status === 'Approved' ? 'text-green-600' : 'text-orange-600'}`}>{monthlyPlan?.status || 'ยังไม่ถูกสร้าง'}</span></p>
                        <button onClick={handleGenerateMonthlyPlan} className="bg-blue-600 text-white px-4 py-2 rounded-lg mr-2 hover:bg-blue-700" disabled={!masterPlan || masterPlan.status !== 'Approved'}>สร้างแผนรายเดือน</button>
                        {monthlyPlan?.status === 'Pending' && <button onClick={handleApproveMonthlyPlan} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">อนุมัติแผนรายเดือน</button>}
                    </div>
                </div>
            </div>

            {/* Confirmation Management Section */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">การจัดการการยืนยัน</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 className="text-xl font-semibold text-gray-700 mb-2">การยืนยันอะไหล่คลัง</h3>
                        <p className="mb-2">งานที่รอดำเนินการ: {jobs.filter(job => job.status !== 'Closed' && job.parts && job.parts.some(p => p.status !== 'Ready')).length}</p>
                        <button onClick={handleConfirmAllStoreParts} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">ยืนยันอะไหล่คลังทั้งหมด (งานที่รอดำเนินการ)</button>
                    </div>
                    <div>
                        <h3 className="text-xl font-semibold text-gray-700 mb-2">การยืนยันความพร้อมใช้งานของ PC</h3>
                        <p className="mb-2">งานที่รอดำเนินการ: {jobs.filter(job => job.status !== 'Closed' && !job.pcConfirmed).length}</p>
                        <button onClick={handleConfirmAllPCAvailability} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">ยืนยันความพร้อมใช้งานของ PC ทั้งหมด (งานที่รอดำเนินการ)</button>
                    </div>
                </div>
            </div>

            {/* Job Management Actions */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-6">
                <h2 className="text-2xl font-semibold text-gray-800 mb-4">การดำเนินการจัดการงาน</h2>
                <button onClick={handleOpenNewAdhocJob} className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 mb-4">เปิดงาน PM แบบ Ad-hoc ใหม่</button>

                <h3 className="text-xl font-semibold text-gray-700 mb-3">งานที่กำลังดำเนินการสำหรับการดำเนินการโดยตรง</h3>
                {jobs.filter(job => job.status !== 'Closed').length === 0 && <p className="text-gray-500">ไม่มีงานที่กำลังดำเนินการ</p>}
                <div className="space-y-4">
                    {jobs.filter(job => job.status !== 'Closed').map(job => (
                        <div key={job.id} className="border p-4 rounded-lg shadow-sm bg-gray-50">
                            <h4 className="font-bold text-lg mb-2">งาน {job.id} - {job.machineName} ({job.assetNo})</h4>
                            <p className="text-sm text-gray-700 mb-2">สถานะ: <span className={`font-semibold ${
                                job.status === 'Pending Approval' ? 'text-orange-600' :
                                job.status === 'In Progress' ? 'text-yellow-600' :
                                job.status === 'Returned for Correction' ? 'text-red-600' :
                                'text-blue-600'
                            }`}>{job.status}</span></p>
                            <p className="text-sm text-gray-700 mb-2">การยืนยัน: คลัง {job.storeConfirmed ? '✅' : '❌'}, PC {job.pcConfirmed ? '✅' : '❌'}</p>
                            <p className="text-sm text-gray-700 mb-4">ลายเซ็น: ช่างเทคนิค {job.techSign ? '✅' : '❌'}, หัวหน้าฝ่ายผลิต {job.chiefProdSign ? '✅' : '❌'}, QC {job.qcSign ? '✅' : '❌'}</p>

                            <div className="flex flex-wrap gap-2">
                                {!job.techSign && <button onClick={() => handleForceSign(job.id, 'tech')} className="bg-indigo-500 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-600">บังคับลายเซ็นช่างเทคนิค</button>}
                                {!job.chiefProdSign && <button onClick={() => handleForceSign(job.id, 'chiefProd')} className="bg-indigo-500 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-600">บังคับลายเซ็นหัวหน้าฝ่ายผลิต</button>}
                                {!job.qcSign && <button onClick={() => handleForceSign(job.id, 'qc')} className="bg-indigo-500 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-600">บังคับลายเซ็น QC</button>}
                                <button onClick={() => handleForceSign(job.id, 'supervisor')} className="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700">อนุมัติและปิดงาน (บังคับ)</button>
                                <button onClick={() => handleResetJob(job.id)} className="bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">รีเซ็ตสถานะงาน</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};


// --- Mobile Application Pages ---

const MobileMyJobs = () => {
    const { navigate, loggedInUser, jobs } = useContext(AppContext);

    // Filter jobs based on role:
    // Technician sees jobs assigned to them.
    // Chief Production and QC see jobs that are 'In Progress', 'Pending Approval', or 'Returned for Correction'
    const myJobs = jobs.filter(job => {
        if (loggedInUser.role === 'Technician') {
            return job.assignedTo === loggedInUser.name;
        } else if (loggedInUser.role === 'Chief Production' || loggedInUser.role === 'QC') {
            return job.status === 'In Progress' || job.status === 'Pending Approval' || job.status === 'Returned for Correction';
        }
        return false;
    });

    return (
        <div className="flex flex-col h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4">
            <div className="bg-gradient-to-r from-blue-600 to-purple-700 p-4 text-white rounded-b-xl shadow-lg mb-4">
                <h1 className="text-2xl font-bold text-center">งานของฉัน</h1>
                <p className="text-center text-sm">ยินดีต้อนรับ, {loggedInUser.name}</p>
            </div>

            <div className="flex-1 overflow-y-auto space-y-4 pb-20">
                {myJobs.length > 0 ? (
                    myJobs.map(job => (
                        <div key={job.id} className="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                            <h2 className="text-xl font-semibold text-gray-800 mb-2">เลขที่งาน {job.id}</h2>
                            <p className="text-gray-700"><span className="font-medium">เครื่องจักร:</span> {job.machineName} ({job.assetNo})</p>
                            <p className="text-gray-700"><span className="font-medium">กำหนดส่ง:</span> {job.dueDate}</p>
                            <p className="text-gray-700 mb-3"><span className="font-medium">สถานะ:</span>
                                <span className={`ml-2 px-3 py-1 rounded-full text-sm font-semibold ${
                                    job.status === 'Closed' ? 'bg-green-100 text-green-800' :
                                    job.status === 'Pending Approval' ? 'bg-orange-100 text-orange-800' :
                                    job.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                                    job.status === 'Returned for Correction' ? 'bg-red-100 text-red-800' :
                                    'bg-blue-100 text-blue-800'
                                }`}>
                                    {job.status}
                                </span>
                            </p>
                            <button
                                onClick={() => navigate('mobile-job-detail', job)}
                                className="w-full bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition duration-300"
                            >
                                ดูรายละเอียด
                            </button>
                        </div>
                    ))
                ) : (
                    <p className="text-center text-gray-600 mt-10">ไม่มีงานที่มอบหมายให้คุณ</p>
                )}
            </div>

            <MobileBottomNav />
        </div>
    );
};

const MobileJobDetails = () => {
    const { navigate, selectedJob, db, userId, loggedInUser } = useContext(AppContext);
    const [showSignaturePad, setShowSignaturePad] = useState(false);
    const [signingFor, setSigningFor] = useState(''); // 'technician', 'chiefProd', or 'qc'
    const [technicianRemarks, setTechnicianRemarks] = useState(selectedJob?.technicianRemarks || '');
    const [qcRemarks, setQcRemarks] = useState(selectedJob?.qcRemarks || '');
    const [loading, setLoading] = useState(false);
    const [currentError, setCurrentError] = useState(null);

    // Update local state when selectedJob changes
    useEffect(() => {
        if (selectedJob) {
            setTechnicianRemarks(selectedJob.technicianRemarks || '');
            setQcRemarks(selectedJob.qcRemarks || '');
        }
    }, [selectedJob]);

    if (!selectedJob) {
        return (
            <div className="flex flex-col h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4">
                <p className="text-gray-700 text-center mt-10">ไม่พบงานที่เลือก</p>
                <button onClick={() => navigate('mobile-my-jobs')} className="mt-4 mx-auto bg-blue-500 text-white px-4 py-2 rounded-lg">กลับไปที่งานของฉัน</button>
                <MobileBottomNav />
            </div>
        );
    }

    const handleSign = (role) => {
        setSigningFor(role);
        setShowSignaturePad(true);
    };

    const handleSignatureConfirm = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, selectedJob.id);
            let updateData = {
                updatedAt: new Date().toISOString(),
                updatedBy: userId
            };

            if (signingFor === 'technician') {
                updateData.techSign = true;
                updateData.technicianRemarks = technicianRemarks;
                // If technician signs, and job is 'Open', change status to 'In Progress'
                if (selectedJob.status === 'Open') {
                    updateData.status = 'In Progress';
                }
            } else if (signingFor === 'chiefProd') {
                updateData.chiefProdSign = true;
            } else if (signingFor === 'qc') {
                updateData.qcSign = true;
                updateData.qcRemarks = qcRemarks; // Save QC remarks
            }

            await updateDoc(jobDocRef, updateData);
            setShowSignaturePad(false);
            alert(`บันทึกลายเซ็น ${signingFor === 'technician' ? 'ช่างเทคนิค' : signingFor === 'chiefProd' ? 'หัวหน้าฝ่ายผลิต' : 'QC'} แล้ว!`);

            // After signing, refresh the selected job data to reflect changes immediately
            const updatedJobSnap = await getDoc(jobDocRef);
            if (updatedJobSnap.exists()) {
                // Manually update selectedJob state to trigger re-render with new data
                // This is a workaround as useContext does not have a direct setter for selectedJob
                // A better approach in a larger app would be to refetch all jobs or update the specific job in the jobs array
                const updatedJobData = { id: updatedJobSnap.id, ...updatedJobSnap.data() };
                // This won't directly update `selectedJob` in AppContext, but will update the local `selectedJob` for this component.
                // For a full context update, you'd need a `setSelectedJob` passed from AppProvider.
                // For now, we'll rely on the `onSnapshot` in AppProvider to eventually update the global jobs array.
            }

        } catch (err) {
            console.error(`Error signing job (${signingFor}):`, err);
            setCurrentError(`ไม่สามารถลงนามในงานได้ กรุณาลองใหม่`);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmitJob = async () => {
        setLoading(true);
        setCurrentError(null);
        try {
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs`, selectedJob.id);
            await updateDoc(jobDocRef, {
                status: 'Pending Approval',
                updatedAt: new Date().toISOString(),
                updatedBy: userId
            });
            alert('ส่งงานเพื่ออนุมัติแล้ว หัวหน้างานจะตรวจสอบ');
            navigate('mobile-my-jobs');
        } catch (err) {
            console.error("Error submitting job:", err);
            setCurrentError("ไม่สามารถส่งงานได้ กรุณาลองใหม่");
        } finally {
            setLoading(false);
        }
    };

    // Determine if the current user can sign based on their role and if they've already signed
    const canTechnicianSign = loggedInUser.role === 'Technician' && !selectedJob.techSign;
    const canChiefProdSign = loggedInUser.role === 'Chief Production' && !selectedJob.chiefProdSign;
    const canQCSign = loggedInUser.role === 'QC' && !selectedJob.qcSign;

    return (
        <div className="flex flex-col h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4">
            <div className="bg-gradient-to-r from-blue-600 to-purple-700 p-4 text-white rounded-b-xl shadow-lg mb-4 flex justify-between items-center">
                <button onClick={() => navigate('mobile-my-jobs')} className="text-white text-lg">&lt; ย้อนกลับ</button>
                <h1 className="text-2xl font-bold">งาน {selectedJob.id}</h1>
                <div></div>
            </div>

            {loading && <p className="text-blue-500 text-center mb-4">กำลังดำเนินการ...</p>}
            {currentError && <p className="text-red-500 text-center mb-4">{currentError}</p>}

            <div className="flex-1 overflow-y-auto space-y-4 pb-20">
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">ข้อมูลงาน</h2>
                    <p className="text-gray-700"><span className="font-medium">เครื่องจักร:</span> {selectedJob.machineName} ({selectedJob.assetNo})</p>
                    <p className="text-gray-700"><span className="font-medium">ประเภท:</span> {selectedJob.type}</p>
                    <p className="text-gray-700"><span className="font-medium">ผู้รับผิดชอบ:</span> {selectedJob.assignedTo}</p>
                    <p className="text-gray-700"><span className="font-medium">กำหนดส่ง:</span> {selectedJob.dueDate}</p>
                    <p className="text-gray-700"><span className="font-medium">สถานะ:</span>
                        <span className={`ml-2 px-3 py-1 rounded-full text-sm font-semibold ${
                            selectedJob.status === 'Closed' ? 'bg-green-100 text-green-800' :
                            selectedJob.status === 'Pending Approval' ? 'bg-orange-100 text-orange-800' :
                            selectedJob.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                            selectedJob.status === 'Returned for Correction' ? 'bg-red-100 text-red-800' :
                            'bg-blue-100 text-blue-800'
                        }`}>
                            {selectedJob.status}
                        </span>
                    </p>
                </div>

                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">งาน</h2>
                    <ul className="list-disc list-inside text-gray-700 space-y-1">
                        {selectedJob.tasks.map((task, index) => <li key={index}>{task}</li>)}
                    </ul>
                    {loggedInUser.role === 'Technician' && (
                        <div className="mt-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2">ข้อสังเกตของช่างเทคนิค:</label>
                            <textarea
                                className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"
                                value={technicianRemarks}
                                onChange={(e) => setTechnicianRemarks(e.target.value)}
                                placeholder="เพิ่มข้อสังเกตของคุณที่นี่..."
                                disabled={selectedJob.techSign} // Disable if already signed
                            ></textarea>
                        </div>
                    )}
                    {loggedInUser.role !== 'Technician' && selectedJob.technicianRemarks && (
                        <p className="mt-4 text-gray-700"><span className="font-medium">ข้อสังเกตของช่างเทคนิค:</span> {selectedJob.technicianRemarks}</p>
                    )}
                    <button className="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg mt-3 hover:bg-gray-300">อัปโหลดรูปภาพ</button>
                </div>

                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">อะไหล่ที่ใช้</h2>
                    {selectedJob.parts && selectedJob.parts.length > 0 ? (
                        <ul className="list-disc list-inside text-gray-700 space-y-1">
                            {selectedJob.parts.map((part, index) => <li key={index}>{part.name} ({part.qty}) - สถานะ: {part.status || 'รอดำเนินการ'} {part.qtyShort > 0 ? `(ขาด: ${part.qtyShort})` : ''}</li>)}
                        </ul>
                    ) : (
                        <p className="text-gray-500">ไม่มีอะไหล่ที่จำเป็นสำหรับงานนี้</p>
                    )}
                </div>

                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">ลายเซ็น</h2>
                    <p className="text-gray-700 mb-2">ช่างเทคนิค: {selectedJob.techSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>
                    <p className="text-gray-700 mb-2">หัวหน้าฝ่ายผลิต: {selectedJob.chiefProdSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>
                    <p className="text-gray-700">ผู้ตรวจสอบ QC: {selectedJob.qcSign ? '✅ ลงนามแล้ว' : '❌ ยังไม่ลงนาม'}</p>

                    {loggedInUser.role === 'QC' && (
                        <div className="mt-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2">ข้อสังเกต QC:</label>
                            <textarea
                                className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"
                                value={qcRemarks}
                                onChange={(e) => setQcRemarks(e.target.value)}
                                placeholder="เพิ่มข้อสังเกตการตรวจสอบ QC ที่นี่..."
                                disabled={selectedJob.qcSign} // Disable if already signed
                            ></textarea>
                        </div>
                    )}

                    {canTechnicianSign && (
                        <button
                            onClick={() => handleSign('technician')}
                            className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 mt-4 transform hover:scale-105"
                        >
                            ลงนามในงาน (ช่างเทคนิค)
                        </button>
                    )}
                    {canChiefProdSign && (
                        <button
                            onClick={() => handleSign('chiefProd')}
                            className="w-full bg-purple-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 mt-4 transform hover:scale-105"
                        >
                            ลงนาม (หัวหน้าฝ่ายผลิต)
                        </button>
                    )}
                    {canQCSign && (
                        <button
                            onClick={() => handleSign('qc')}
                            className="w-full bg-orange-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-orange-700 transition duration-300 mt-4 transform hover:scale-105"
                        >
                            ลงนาม (QC)
                        </button>
                    )}

                    {selectedJob.techSign && selectedJob.chiefProdSign && selectedJob.qcSign && selectedJob.status !== 'Closed' && (
                        <button
                            onClick={handleSubmitJob}
                            className="w-full bg-green-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 mt-4 transform hover:scale-105"
                        >
                            ส่งงานเพื่ออนุมัติ
                        </button>
                    )}
                </div>
            </div>

            {showSignaturePad && (
                <SignaturePadSimulation
                    onConfirm={handleSignatureConfirm}
                    onCancel={() => setShowSignaturePad(false)}
                    title={`${signingFor === 'technician' ? 'ลายเซ็นช่างเทคนิค' : signingFor === 'chiefProd' ? 'ลายเซ็นหัวหน้าฝ่ายผลิต' : 'ลายเซ็น QC'}`}
                />
            )}

            <MobileBottomNav />
        </div>
    );
};

const SignaturePadSimulation = ({ onConfirm, onCancel, title }) => {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 className="text-xl font-bold text-gray-800 mb-4 text-center">{title}</h2>
                <div className="border border-gray-300 rounded-lg h-32 flex items-center justify-center bg-gray-50 text-gray-500 italic mb-6">
                    (พื้นที่จำลองลายเซ็น)
                </div>
                <div className="flex justify-end space-x-4">
                    <button
                        onClick={onCancel}
                        className="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg shadow-md hover:bg-gray-400 transition duration-300"
                    >
                        ยกเลิก
                    </button>
                    <button
                        onClick={onConfirm}
                        className="bg-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                    >
                        ยืนยันลายเซ็น
                    </button>
                </div>
            </div>
        </div>
    );
};

const MobileBottomNav = () => {
    const { navigate, loggedInUser } = useContext(AppContext);

    const getIconClass = (pageId) => {
        // Now all mobile roles navigate to 'mobile-my-jobs' first
        return `text-3xl ${
            pageId === 'mobile-my-jobs' ? 'text-blue-500' : 'text-gray-400'
        }`;
    };

    return (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg rounded-t-xl p-3">
            <div className="flex justify-around items-center">
                <button
                    onClick={() => navigate('mobile-my-jobs')}
                    className="flex flex-col items-center text-gray-700 focus:outline-none"
                >
                    <i className={`fas fa-home ${getIconClass('mobile-my-jobs')}`}></i>
                    <span className="text-xs mt-1">หน้าแรก</span>
                </button>
            </div>
        </div>
    );
};


// --- Main App Component ---
const App = () => {
    const { currentPage, loggedInUser, loading, error } = useContext(AppContext);

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
                    <p className="text-gray-700 text-lg">กำลังเริ่มต้นแอปพลิเคชัน...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-red-100">
                <div className="text-center p-8 rounded-lg shadow-md bg-white">
                    <h2 className="text-2xl font-bold text-red-700 mb-4">ข้อผิดพลาดของแอปพลิเคชัน</h2>
                    <p className="text-gray-700">{error}</p>
                    <p className="text-gray-500 mt-4">โปรดลองรีเฟรชหน้า</p>
                </div>
            </div>
        );
    }

    const renderPage = () => {
        if (!loggedInUser) {
            return <LoginPage />;
        }

        // Web App Layout
        if (loggedInUser.type === 'web') {
            return (
                <div className="flex min-h-screen bg-gray-100 font-sans">
                    <Sidebar />
                    <div className="flex-1 flex flex-col">
                        <Navbar />
                        {currentPage === 'web-dashboard' && <WebDashboard />}
                        {currentPage === 'web-machine-register' && <WebMachineRegisterList />}
                        {currentPage === 'web-machine-detail' && <WebMachineRegisterDetail />}
                        {currentPage === 'web-job-management' && <WebJobManagementList />}
                        {currentPage === 'web-job-detail' && <WebJobApprovalDetail />}
                        {currentPage === 'web-store-confirmation' && <WebStoreConfirmation />}
                        {currentPage === 'web-store-parts-summary' && <WebStorePartsSummary />}
                        {currentPage === 'web-pc-confirmation' && <WebPCConfirmation />}
                        {currentPage === 'web-reports' && <WebReports />}
                        {currentPage === 'web-monthly-plan' && <WebMonthlyPlan />}
                        {currentPage === 'web-user-management' && <WebUserManagement />}
                        {currentPage === 'web-settings' && <WebSettings />}
                        {currentPage === 'web-admin-workflow' && <WebAdminWorkflow />} {/* Render the new Admin Workflow page */}
                    </div>
                </div>
            );
        }

        // Mobile App Layout
        if (loggedInUser.type === 'mobile') {
            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    {currentPage === 'mobile-my-jobs' && <MobileMyJobs />}
                    {currentPage === 'mobile-job-detail' && <MobileJobDetails />}
                    {/* Removed mobile-job-inspection as it's merged into MobileJobDetails */}
                </div>
            );
        }
    };

    return (
        <>
            <script src="https://cdn.tailwindcss.com"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></link>
            <style>
                {`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                body {
                    font-family: 'Inter', sans-serif;
                }
                .form-input {
                    @apply shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200;
                }
                `}
            </style>
            {renderPage()}
        </>
    );
};

// Wrap the App component with the AppProvider
export default function ProvidedApp() {
    return (
        <AppProvider>
            <App />
        </AppProvider>
    );
}

